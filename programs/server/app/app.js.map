{"version":3,"sources":["meteor://ðŸ’»app/imports/lib/core.js","meteor://ðŸ’»app/imports/lib/routes.js","meteor://ðŸ’»app/imports/server/files.collection.js","meteor://ðŸ’»app/imports/server/image-processing.js","meteor://ðŸ’»app/imports/server/methods.js","meteor://ðŸ’»app/imports/server/publications.js","meteor://ðŸ’»app/imports/server/service-configurations.js","meteor://ðŸ’»app/imports/server/spiderable.js","meteor://ðŸ’»app/server/core.js"],"names":["module","export","_app","Collections","watch","require","NOOP","isUndefined","obj","isObject","isArray","isFunction","Object","Array","isBoolean","prototype","toString","call","isEmpty","isDate","keys","length","isString","clone","slice","assign","has","_obj","path","hasOwnProperty","i","omit","clear","pick","map","key","now","Date","throttle","func","wait","options","previous","timeout","result","that","self","args","later","leading","apply","throttled","remaining","arguments","clearTimeout","trailing","setTimeout","cancel","helpers","Meteor","v","FlowRouter","route","name","action","render","waitOn","isClient","subs","subscribe","userOnly","get","whileWaiting","subscriptions","isServer","register","fastRender","title","userId","meta","keywords","itemprop","content","description","property","params","queryParams","file","link","absoluteUrl","image","href","_id","onNoData","data","files","findOne","Random","filesize","FilesCollection","useDropBox","useS3","client","sendToStorage","fs","S3","stream","request","Dropbox","bound","bindEnvironment","callback","process","env","DROPBOX","settings","dropbox","JSON","parse","s3","s3Conf","dbConf","secret","token","Client","bucket","region","secretAccessKey","accessKeyId","sslEnabled","httpOptions","agent","storagePath","collectionName","allowClientCode","protected","fileObj","secured","onBeforeRemove","cursor","res","indexOf","onBeforeUpload","size","downloadCallback","query","download","collection","update","$inc","interceptDownload","http","fileRef","version","versions","pipeFrom","serve","url","headers","pipePath","opts","Bucket","Key","range","vRef","array","split","start","parseInt","end","isNaN","chunkSize","Range","fileColl","getObject","error","console","response","finished","httpResponse","replace","dataStream","PassThrough","Body","denyClient","on","_fileRef","makeUrl","stat","triesUrl","long","downloadHack","xml","upd","$set","updError","unlink","writeToDB","triesSend","writeFile","extension","readFile","triesRead","filePath","id","putObject","StorageClass","createReadStream","ContentType","type","test","createThumbnails","_origRemove","remove","search","find","forEach","deleteObject","setInterval","$lte","check","default","gm","cb","isLast","finish","exists","Error","sizes","preview","width","thumbnail40","square","features","height","copyPaste","copy","fsCopyError","colUpdError","img","quality","define","autoOrient","noProfile","strip","dither","interlace","filter","updateAndSave","upNSaveError","fsStatError","gmSizeError","imgInfo","resize","write","x","y","widthRatio","heightRatio","widthNew","heightNew","crop","methods","filesLenght","Boolean","selector","$or","$lt","count","unblame","String","blame","changeAccess","unlisted","changePrivacy","getServiceConfiguration","sc","publish","take","Number","limit","sort","fields","isPDF","isText","isJSON","isVideo","isAudio","isImage","_collectionName","_downloadRoute","ServiceConfiguration","configurations","ACCOUNTS_METEOR_ID","ACCOUNTS_METEOR_SEC","meteor","upsert","service","clientId","loginStyle","ACCOUNTS_GITHUB_ID","ACCOUNTS_GITHUB_SEC","github","ACCOUNTS_TWITTER_ID","ACCOUNTS_TWITTER_SEC","twitter","consumerKey","ACCOUNTS_FACEBOOK_ID","ACCOUNTS_FACEBOOK_SEC","facebook","appId"],"mappings":"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","file":"/app.js","sourcesContent":["import './routes.js';\n\nconst Collections = {};\nconst _app = {\n  NOOP(){},\n  isUndefined(obj) {\n    return obj === void 0;\n  },\n  isObject(obj) {\n    if (this.isArray(obj) || this.isFunction(obj)) {\n      return false;\n    }\n    return obj === Object(obj);\n  },\n  isArray(obj) {\n    return Array.isArray(obj);\n  },\n  isBoolean(obj) {\n    return obj === true || obj === false || Object.prototype.toString.call(obj) === '[object Boolean]';\n  },\n  isFunction(obj) {\n    return typeof obj === 'function' || false;\n  },\n  isEmpty(obj) {\n    if (this.isDate(obj)) {\n      return false;\n    }\n    if (this.isObject(obj)) {\n      return !Object.keys(obj).length;\n    }\n    if (this.isArray(obj) || this.isString(obj)) {\n      return !obj.length;\n    }\n    return false;\n  },\n  clone(obj) {\n    if (!this.isObject(obj)) return obj;\n    return this.isArray(obj) ? obj.slice() : Object.assign({}, obj);\n  },\n  has(_obj, path) {\n    let obj = _obj;\n    if (!this.isObject(obj)) {\n      return false;\n    }\n    if (!this.isArray(path)) {\n      return this.isObject(obj) && Object.prototype.hasOwnProperty.call(obj, path);\n    }\n\n    const length = path.length;\n    for (let i = 0; i < length; i++) {\n      if (!Object.prototype.hasOwnProperty.call(obj, path[i])) {\n        return false;\n      }\n      obj = obj[path[i]];\n    }\n    return !!length;\n  },\n  omit(obj, ...keys) {\n    const clear = Object.assign({}, obj);\n    for (let i = keys.length - 1; i >= 0; i--) {\n      delete clear[keys[i]];\n    }\n\n    return clear;\n  },\n  pick(obj, ...keys) {\n    return Object.assign({}, ...keys.map(key => ({[key]: obj[key]})));\n  },\n  now: Date.now,\n  throttle(func, wait, options = {}) {\n    let previous = 0;\n    let timeout = null;\n    let result;\n    const that = this;\n    let self;\n    let args;\n\n    const later = () => {\n      previous = options.leading === false ? 0 : that.now();\n      timeout = null;\n      result = func.apply(self, args);\n      if (!timeout) self = args = null;\n    };\n\n    const throttled = function () {\n      const now = that.now();\n      if (!previous && options.leading === false) previous = now;\n      const remaining = wait - (now - previous);\n      self = this;\n      args = arguments;\n      if (remaining <= 0 || remaining > wait) {\n        if (timeout) {\n          clearTimeout(timeout);\n          timeout = null;\n        }\n        previous = now;\n        result = func.apply(self, args);\n        if (!timeout) self = args = null;\n      } else if (!timeout && options.trailing !== false) {\n        timeout = setTimeout(later, remaining);\n      }\n      return result;\n    };\n\n    throttled.cancel = () => {\n      clearTimeout(timeout);\n      previous = 0;\n      timeout = self = args = null;\n    };\n\n    return throttled;\n  }\n};\n\nconst helpers = ['String', 'Number', 'Date'];\nfor (let i = 0; i < helpers.length; i++) {\n  _app['is' + helpers[i]] = function (obj) {\n    return Object.prototype.toString.call(obj) === '[object ' + helpers[i] + ']';\n  };\n}\n\nexport { _app, Collections };\n","import { Meteor }            from 'meteor/meteor';\nimport { FlowRouter }        from 'meteor/ostrio:flow-router-extra';\nimport { _app, Collections } from '/imports/lib/core.js';\n\nFlowRouter.route('/', {\n  name: 'index',\n  action() {\n    this.render('_layout', 'index');\n  },\n  waitOn() {\n    if (Meteor.isClient) {\n      return [_app.subs.subscribe('latest', 10, _app.userOnly.get()), import('/imports/client/index/index.js')];\n    }\n  },\n  whileWaiting() {\n    this.render('_layout', '_loading');\n  },\n  subscriptions() {\n    if (Meteor.isServer) {\n      this.register('latest', Meteor.subscribe('latest', 10, false));\n    }\n  },\n  fastRender: true\n});\n\nFlowRouter.route('/login', {\n  name: 'login',\n  title() {\n    if (Meteor.userId()) {\n      return 'Your account settings';\n    }\n    return 'Login into Meteor Files';\n  },\n  meta: {\n    keywords: {\n      name: 'keywords',\n      itemprop: 'keywords',\n      content: 'private, unlisted, files, upload, meteor, open source, javascript'\n    },\n    description: {\n      name: 'description',\n      itemprop: 'description',\n      property: 'og:description',\n      content: 'Login into Meteor files. After you logged in you can make files private and unlisted'\n    },\n    'twitter:description': 'Login into Meteor files. After you logged in you can make files private and unlisted'\n  },\n  action() {\n    this.render('_layout', 'login');\n  },\n  waitOn() {\n    return import('/imports/client/user-account/login.js');\n  },\n  whileWaiting() {\n    this.render('_layout', '_loading');\n  }\n});\n\nFlowRouter.route('/:_id', {\n  name: 'file',\n  title(params, queryParams, file) {\n    if (file) {\n      return 'View File: ' + (file.get('name'));\n    }\n    return '404: Page not found';\n  },\n  meta(params, queryParams, file) {\n    return {\n      keywords: {\n        name: 'keywords',\n        itemprop: 'keywords',\n        content: file ? 'file, view, preview, uploaded, shared, ' + (file.get('name')) + ', ' + (file.get('extension')) + ', ' + (file.get('type')) + ', meteor, open source, javascript' : '404, page, not found'\n      },\n      description: {\n        name: 'description',\n        itemprop: 'description',\n        property: 'og:description',\n        content: file ? 'View uploaded and shared file: ' + (file.get('name')) : '404: No such page'\n      },\n      'twitter:description': file ? 'View uploaded and shared file: ' + (file.get('name')) : '404: No such page',\n      'og:image': {\n        property: 'og:image',\n        content: file && file.get('isImage') ? file.link('preview') : Meteor.absoluteUrl('icon_1200x630.png')\n      },\n      'twitter:image': {\n        name: 'twitter:image',\n        content: file && file.get('isImage') ? file.link('preview') : Meteor.absoluteUrl('icon_750x560.png')\n      }\n    };\n  },\n  link(params, queryParams, file) {\n    return {\n      image: {\n        itemprop: 'image',\n        content() {\n          if (file && file.get('isImage')) {\n            return file.link('preview');\n          }\n          return Meteor.absoluteUrl('icon_1200x630.png');\n        },\n        href() {\n          if (file && file.get('isImage')) {\n            return file.link('preview');\n          }\n          return Meteor.absoluteUrl('icon_1200x630.png');\n        }\n      }\n    };\n  },\n  action(params, queryParams, file) {\n    if (_app.isObject(file) && !_app.isEmpty(file)) {\n      this.render('_layout', 'file', {\n        file: file\n      });\n    }\n  },\n  waitOn(params) {\n    if (Meteor.isClient) {\n      return [_app.subs.subscribe('file', params._id), import('/imports/client/file/file.js')];\n    }\n  },\n  subscriptions(params) {\n    if (Meteor.isServer) {\n      this.register('file', Meteor.subscribe('file', params._id));\n    }\n  },\n  fastRender: true,\n  whileWaiting() {\n    this.render('_layout', '_loading');\n  },\n  onNoData() {\n    this.render('_layout', '_404');\n  },\n  data(params) {\n    return Collections.files.findOne(params._id) || false;\n  }\n});\n\n// 404 route (catch all)\nFlowRouter.route('*', {\n  action() {\n    this.render('_layout', '_404');\n  },\n  title: '404: Page not found'\n});\n","import { Meteor }            from 'meteor/meteor';\nimport { Random }            from 'meteor/random';\nimport { filesize }          from 'meteor/mrt:filesize';\nimport { FilesCollection }   from 'meteor/ostrio:files';\nimport { _app, Collections } from '/imports/lib/core.js';\n\n// DropBox usage:\n// Read: https://github.com/VeliovGroup/Meteor-Files/wiki/DropBox-Integration\n// env.var example: DROPBOX='{\"dropbox\":{\"key\": \"xxx\", \"secret\": \"xxx\", \"token\": \"xxx\"}}'\nlet useDropBox = false;\n\n// AWS:S3 usage:\n// Read: https://github.com/VeliovGroup/Meteor-Files/wiki/AWS-S3-Integration\n// env.var example: S3='{\"s3\":{\"key\": \"xxx\", \"secret\": \"xxx\", \"bucket\": \"xxx\", \"region\": \"xxx\"\"}}'\nlet useS3 = false;\nlet client;\nlet sendToStorage;\n\nconst fs      = require('fs-extra');\nconst S3      = require('aws-sdk/clients/s3');\nconst stream  = require('stream');\nconst request = require('request');\nconst Dropbox = require('dropbox');\nconst bound   = Meteor.bindEnvironment((callback) => {\n  return callback();\n});\n\nif (process.env.DROPBOX) {\n  Meteor.settings.dropbox = JSON.parse(process.env.DROPBOX).dropbox;\n} else if (process.env.S3) {\n  Meteor.settings.s3 = JSON.parse(process.env.S3).s3;\n}\n\nconst s3Conf = Meteor.settings.s3 || {};\nconst dbConf = Meteor.settings.dropbox || {};\n\nif (dbConf && dbConf.key && dbConf.secret && dbConf.token) {\n  useDropBox = true;\n  client     = new Dropbox.Client({\n    key: dbConf.key,\n    secret: dbConf.secret,\n    token: dbConf.token\n  });\n} else if (s3Conf && s3Conf.key && s3Conf.secret && s3Conf.bucket && s3Conf.region) {\n  useS3  = true;\n  client = new S3({\n    secretAccessKey: s3Conf.secret,\n    accessKeyId: s3Conf.key,\n    region: s3Conf.region,\n    sslEnabled: false,\n    httpOptions: {\n      timeout: 6000,\n      agent: false\n    }\n  });\n}\n\nCollections.files = new FilesCollection({\n  // debug: true,\n  storagePath: 'assets/app/uploads/uploadedFiles',\n  collectionName: 'uploadedFiles',\n  allowClientCode: true,\n  // disableUpload: true,\n  // disableDownload: true,\n  protected(fileObj) {\n    if (fileObj) {\n      if (!(fileObj.meta && fileObj.meta.secured)) {\n        return true;\n      } else if ((fileObj.meta && fileObj.meta.secured === true) && this.userId === fileObj.userId) {\n        return true;\n      }\n    }\n    return false;\n  },\n  onBeforeRemove(cursor) {\n    const res = cursor.map((file) => {\n      if (file && file.userId && _app.isString(file.userId)) {\n        return file.userId === this.userId;\n      }\n      return false;\n    });\n    return !~res.indexOf(false);\n  },\n  onBeforeUpload() {\n    if (this.file.size <= 1024 * 1024 * 128) {\n      return true;\n    }\n    return \"Max. file size is 128MB you've tried to upload \" + (filesize(this.file.size));\n  },\n  downloadCallback(fileObj) {\n    if (this.params && this.params.query && this.params.query.download === 'true') {\n      Collections.files.collection.update(fileObj._id, {\n        $inc: {\n          'meta.downloads': 1\n        }\n      }, _app.NOOP);\n    }\n    return true;\n  },\n  interceptDownload(http, fileRef, version) {\n    let path;\n    if (useDropBox) {\n      path = (fileRef && fileRef.versions && fileRef.versions[version] && fileRef.versions[version].meta && fileRef.versions[version].meta.pipeFrom) ? fileRef.versions[version].meta.pipeFrom : void 0;\n      if (path) {\n        // If file is successfully moved to Storage\n        // We will pipe request to Storage\n        // So, original link will stay always secure\n\n        // To force ?play and ?download parameters\n        // and to keep original file name, content-type,\n        // content-disposition and cache-control\n        // we're using low-level .serve() method\n        this.serve(http, fileRef, fileRef.versions[version], version, request({\n          url: path,\n          headers: _app.pick(http.request.headers, 'range', 'cache-control', 'connection')\n        }));\n        return true;\n      }\n      // While file is not yet uploaded to Storage\n      // We will serve file from FS\n      return false;\n    } else if (useS3) {\n      path = (fileRef && fileRef.versions && fileRef.versions[version] && fileRef.versions[version].meta && fileRef.versions[version].meta.pipePath) ? fileRef.versions[version].meta.pipePath : void 0;\n      if (path) {\n        // If file is successfully moved to Storage\n        // We will pipe request to Storage\n        // So, original link will stay always secure\n\n        // To force ?play and ?download parameters\n        // and to keep original file name, content-type,\n        // content-disposition and cache-control\n        // we're using low-level .serve() method\n        const opts = {\n          Bucket: s3Conf.bucket,\n          Key: path\n        };\n\n        if (http.request.headers.range) {\n          const vRef  = fileRef.versions[version];\n          let range   = _app.clone(http.request.headers.range);\n          const array = range.split(/bytes=([0-9]*)-([0-9]*)/);\n          const start = parseInt(array[1]);\n          let end     = parseInt(array[2]);\n          if (isNaN(end)) {\n            // Request data from AWS:S3 by small chunks\n            end       = (start + this.chunkSize) - 1;\n            if (end >= vRef.size) {\n              end     = vRef.size - 1;\n            }\n          }\n          opts.Range   = `bytes=${start}-${end}`;\n          http.request.headers.range = `bytes=${start}-${end}`;\n        }\n\n        const fileColl = this;\n        client.getObject(opts, function (error) {\n          if (error) {\n            console.error(error);\n            if (!http.response.finished) {\n              http.response.end();\n            }\n          } else {\n            if (http.request.headers.range && this.httpResponse.headers['content-range']) {\n              // Set proper range header in according to what is returned from AWS:S3\n              http.request.headers.range = this.httpResponse.headers['content-range'].split('/')[0].replace('bytes ', 'bytes=');\n            }\n\n            const dataStream = new stream.PassThrough();\n            fileColl.serve(http, fileRef, fileRef.versions[version], version, dataStream);\n            dataStream.end(this.data.Body);\n          }\n        });\n\n        return true;\n      }\n      // While file is not yet uploaded to Storage\n      // We will serve file from FS\n      return false;\n    }\n    return false;\n  }\n});\n\nCollections.files.denyClient();\nCollections.files.on('afterUpload', function(_fileRef) {\n  if (useDropBox) {\n    const makeUrl = (stat, fileRef, version, triesUrl = 0) => {\n      client.makeUrl(stat.path, {\n        long: true,\n        downloadHack: true\n      }, (error, xml) => {\n        bound(() => {\n          // Store downloadable link in file's meta object\n          if (error) {\n            if (triesUrl < 10) {\n              Meteor.setTimeout(() => {\n                makeUrl(stat, fileRef, version, ++triesUrl);\n              }, 2048);\n            } else {\n              console.error(error, {\n                triesUrl: triesUrl\n              });\n            }\n          } else if (xml) {\n            const upd = { $set: {} };\n            upd.$set[`versions.${version}.meta.pipeFrom`] = xml.url;\n            upd.$set[`versions.${version}.meta.pipePath`] = stat.path;\n            this.collection.update({\n              _id: fileRef._id\n            }, upd, (updError) => {\n              if (updError) {\n                console.error(updError);\n              } else {\n                // Unlink original files from FS\n                // after successful upload to DropBox\n                this.unlink(this.collection.findOne(fileRef._id), version);\n              }\n            });\n          } else {\n            if (triesUrl < 10) {\n              Meteor.setTimeout(() => {\n                // Generate downloadable link\n                makeUrl(stat, fileRef, version, ++triesUrl);\n              }, 2048);\n            } else {\n              console.error('client.makeUrl doesn\\'t returns xml', {\n                triesUrl: triesUrl\n              });\n            }\n          }\n        });\n      });\n    };\n\n    const writeToDB = (fileRef, version, data, triesSend = 0) => {\n      // DropBox already uses random URLs\n      // No need to use random file names\n      client.writeFile(fileRef._id + '-' + version + '.' + fileRef.extension, data, (error, stat) => {\n        bound(() => {\n          if (error) {\n            if (triesSend < 10) {\n              Meteor.setTimeout(() => {\n                // Write file to DropBox\n                writeToDB(fileRef, version, data, ++triesSend);\n              }, 2048);\n            } else {\n              console.error(error, {\n                triesSend: triesSend\n              });\n            }\n          } else {\n            makeUrl(stat, fileRef, version);\n          }\n        });\n      });\n    };\n\n    const readFile = (fileRef, vRef, version, triesRead = 0) => {\n      fs.readFile(vRef.path, (error, data) => {\n        bound(() => {\n          if (error) {\n            if (triesRead < 10) {\n              readFile(fileRef, vRef, version, ++triesRead);\n            } else {\n              console.error(error);\n            }\n          } else {\n            writeToDB(fileRef, version, data);\n          }\n        });\n      });\n    };\n\n    sendToStorage = (fileRef) => {\n      for(let version in fileRef.versions) {\n        if (fileRef.versions[version]) {\n          readFile(fileRef, fileRef.versions[version], version);\n        }\n      }\n    };\n  } else if (useS3) {\n    sendToStorage = (fileRef) => {\n      for(let version in fileRef.versions) {\n        if (fileRef.versions[version]) {\n          const vRef = fileRef.versions[version];\n          // We use Random.id() instead of real file's _id\n          // to secure files from reverse engineering\n          // As after viewing this code it will be easy\n          // to get access to unlisted and protected files\n          const filePath = 'files/' + (Random.id()) + '-' + version + '.' + fileRef.extension;\n\n          client.putObject({\n            StorageClass: 'STANDARD',\n            Bucket: s3Conf.bucket,\n            Key: filePath,\n            Body: fs.createReadStream(vRef.path),\n            ContentType: vRef.type,\n          }, (error) => {\n            bound(() => {\n              if (error) {\n                console.error(error);\n              } else {\n                const upd = { $set: {} };\n                upd.$set[`versions.${version}.meta.pipePath`] = filePath;\n                this.collection.update({\n                  _id: fileRef._id\n                }, upd, (updError) => {\n                  if (updError) {\n                    console.error(updError);\n                  } else {\n                    // Unlink original file from FS\n                    // after successful upload to AWS:S3\n                    this.unlink(this.collection.findOne(fileRef._id), version);\n                  }\n                });\n              }\n            });\n          });\n        }\n      }\n    };\n  }\n\n  if (/png|jpe?g/i.test(_fileRef.extension || '')) {\n    Meteor.setTimeout( () => {\n      _app.createThumbnails(this, _fileRef, (error) => {\n        if (error) {\n          console.error(error);\n        }\n\n        if (useDropBox || useS3) {\n          sendToStorage(this.collection.findOne(_fileRef._id));\n        }\n      });\n    }, 1024);\n  } else {\n    if (useDropBox || useS3) {\n      sendToStorage(_fileRef);\n    }\n  }\n});\n\n// This line now commented due to Heroku usage\n// Collections.files.collection._ensureIndex {'meta.expireAt': 1}, {expireAfterSeconds: 0, background: true}\n\n// Intercept FileCollection's remove method\n// to remove file from DropBox or AWS S3\nif (useDropBox || useS3) {\n  const _origRemove = Collections.files.remove;\n  Collections.files.remove = function(search) {\n    const cursor = this.collection.find(search);\n    cursor.forEach((fileRef) => {\n      for (let version in fileRef.versions) {\n        if (fileRef.versions[version]) {\n          const vRef = fileRef.versions[version];\n          if (vRef && vRef.meta && vRef.meta.pipePath) {\n            if (useDropBox) {\n              // DropBox usage:\n              client.remove(vRef.meta.pipePath, (error) => {\n                bound(() => {\n                  if (error) {\n                    console.error(error);\n                  }\n                });\n              });\n            } else {\n              // AWS:S3 usage:\n              client.deleteObject({\n                Bucket: s3Conf.bucket,\n                Key: vRef.meta.pipePath,\n              }, (error) => {\n                bound(() => {\n                  if (error) {\n                    console.error(error);\n                  }\n                });\n              });\n            }\n          }\n        }\n      }\n    });\n    // Call original method\n    _origRemove.call(this, search);\n  };\n}\n\n// Remove all files on server load/reload, useful while testing/development\n// Meteor.startup -> Collections.files.remove {}\n\n// Remove files along with MongoDB records two minutes before expiration date\n// If we have 'expireAfterSeconds' index on 'meta.expireAt' field,\n// it won't remove files themselves.\nMeteor.setInterval(() => {\n  Collections.files.remove({\n    'meta.expireAt': {\n      $lte: new Date(+new Date() + 120000)\n    }\n  }, _app.NOOP);\n}, 120000);\n","import { _app }   from '/imports/lib/core.js';\nimport { check }  from 'meteor/check';\nimport { Meteor } from 'meteor/meteor';\n\nimport fs from 'fs-extra';\nimport gm from 'gm';\n//Some platforms may bundle ImageMagick into their tools (like Heroku). In this case you may use GraphicsMagick as Imagemagick in this way:\n//npm install gm --save and then where you use it:\n//const gm = require('gm');\n//const im = gm.subClass({ imageMagick: true });\n//Please note that GM was considered slightly faster than IM so before you chose convenience over performance read the latest news about it.\n//https://mazira.com/blog/comparing-speed-imagemagick-graphicsmagick\n\nconst bound = Meteor.bindEnvironment((callback) => {\n  return callback();\n});\n\n_app.createThumbnails = (collection, fileRef, cb) => {\n  check(fileRef, Object);\n\n  let isLast = false;\n  const finish = (error) => {\n    bound(() => {\n      if (error) {\n        console.error('[_app.createThumbnails] [finish]', error);\n        cb && cb (error);\n      } else {\n        if (isLast) {\n          cb && cb(void 0, fileRef);\n        }\n      }\n      return true;\n    });\n  };\n\n  fs.exists(fileRef.path, (exists) => {\n    bound(() => {\n      if (!exists) {\n        throw new Meteor.Error('File ' + fileRef.path + ' not found in [createThumbnails] Method');\n      }\n      const image = gm(fileRef.path);\n      const sizes = {\n        preview: {\n          width: 400\n        },\n        thumbnail40: {\n          width: 40,\n          square: true\n        }\n      };\n\n      image.size((error, features) => {\n        bound(() => {\n          if (error) {\n            console.error('[_app.createThumbnails] [forEach sizes]', error);\n            finish(new Meteor.Error('[_app.createThumbnails] [forEach sizes]', error));\n            return;\n          }\n\n          let i = 0;\n          collection.collection.update(fileRef._id, {\n            $set: {\n              'meta.width': features.width,\n              'meta.height': features.height,\n              'versions.original.meta.width': features.width,\n              'versions.original.meta.height': features.height\n            }\n          }, _app.NOOP);\n\n          Object.keys(sizes).forEach((name) => {\n            const size = sizes[name];\n            const path = (collection.storagePath(fileRef)) + '/' + name + '-' + fileRef._id + '.' + fileRef.extension;\n            const copyPaste = () => {\n              fs.copy(fileRef.path, path, (fsCopyError) => {\n                bound(() => {\n                  if (fsCopyError) {\n                    console.error('[_app.createThumbnails] [forEach sizes] [fs.copy]', fsCopyError);\n                    finish(fsCopyError);\n                    return;\n                  }\n\n                  const upd = { $set: {} };\n                  upd.$set[`versions.${name}`] = {\n                    path: path,\n                    size: fileRef.size,\n                    type: fileRef.type,\n                    extension: fileRef.extension,\n                    meta: {\n                      width: features.width,\n                      height: features.height\n                    }\n                  };\n\n                  collection.collection.update(fileRef._id, upd, (colUpdError) => {\n                    ++i;\n                    if (i === Object.keys(sizes).length) {\n                      isLast = true;\n                    }\n                    finish(colUpdError);\n                  });\n                });\n              });\n            };\n\n            if (/png|jpe?g/i.test(fileRef.extension)) {\n              const img = gm(fileRef.path)\n                .quality(70)\n                .define('filter:support=2')\n                .define('jpeg:fancy-upsampling=false')\n                .define('jpeg:fancy-upsampling=off')\n                .define('png:compression-filter=5')\n                .define('png:compression-level=9')\n                .define('png:compression-strategy=1')\n                .define('png:exclude-chunk=all')\n                .autoOrient()\n                .noProfile()\n                .strip()\n                .dither(false)\n                .interlace('Line')\n                .filter('Triangle');\n\n              const updateAndSave = (upNSaveError) => {\n                bound(() => {\n                  if (upNSaveError) {\n                    console.error('[_app.createThumbnails] [forEach sizes] [img.resize]', upNSaveError);\n                    finish(upNSaveError);\n                    return;\n                  }\n                  fs.stat(path, (fsStatError, stat) => {\n                    bound(() => {\n                      if (fsStatError) {\n                        console.error('[_app.createThumbnails] [forEach sizes] [img.resize] [fs.stat]', fsStatError);\n                        finish(fsStatError);\n                        return;\n                      }\n\n                      gm(path).size((gmSizeError, imgInfo) => {\n                        bound(() => {\n                          if (gmSizeError) {\n                            console.error('[_app.createThumbnails] [forEach sizes] [img.resize] [fs.stat] [gm(path).size]', gmSizeError);\n                            finish(gmSizeError);\n                            return;\n                          }\n                          const upd = { $set: {} };\n                          upd.$set[`versions.${name}`] = {\n                            path: path,\n                            size: stat.size,\n                            type: fileRef.type,\n                            extension: fileRef.extension,\n                            name: fileRef.name,\n                            meta: {\n                              width: imgInfo.width,\n                              height: imgInfo.height\n                            }\n                          };\n\n                          collection.collection.update(fileRef._id, upd, (colUpdError) => {\n                            ++i;\n                            if (i === Object.keys(sizes).length) {\n                              isLast = true;\n                            }\n                            finish(colUpdError);\n                          });\n                        });\n                      });\n                    });\n                  });\n                });\n              };\n\n              if (!size.square) {\n                if (features.width > size.width) {\n                  img.resize(size.width).interlace('Line').write(path, updateAndSave);\n                } else {\n                  copyPaste();\n                }\n              } else {\n                let x = 0;\n                let y = 0;\n                const widthRatio  = features.width / size.width;\n                const heightRatio = features.height / size.width;\n                let widthNew      = size.width;\n                let heightNew     = size.width;\n\n                if (heightRatio < widthRatio) {\n                  widthNew = (size.width * features.width) / features.height;\n                  x = (widthNew - size.width) / 2;\n                }\n\n                if (heightRatio > widthRatio) {\n                  heightNew = (size.width * features.height) / features.width;\n                  y = (heightNew - size.width) / 2;\n                }\n\n                img\n                  .resize(widthNew, heightNew)\n                  .crop(size.width, size.width, x, y)\n                  .interlace('Line')\n                  .write(path, updateAndSave);\n              }\n            } else {\n              copyPaste();\n            }\n          });\n        });\n      });\n    });\n  });\n  return true;\n};\n","import { check }             from 'meteor/check';\nimport { Meteor }            from 'meteor/meteor';\nimport { _app, Collections } from '/imports/lib/core.js';\n\nMeteor.methods({\n  filesLenght(userOnly = false) {\n    check(userOnly, Boolean);\n\n    let selector;\n    if (userOnly && this.userId) {\n      selector = {\n        userId: this.userId\n      };\n    } else if (this.userId) {\n      selector = {\n        $or: [\n          {\n            'meta.unlisted': false,\n            'meta.secured': false,\n            'meta.blamed': {\n              $lt: 3\n            }\n          }, {\n            userId: this.userId,\n            'meta.blamed': {\n              $lt: 3\n            }\n          }\n        ]\n      };\n    } else {\n      selector = {\n        'meta.unlisted': false,\n        'meta.secured': false,\n        'meta.blamed': {\n          $lt: 3\n        }\n      };\n    }\n    return Collections.files.find(selector).count();\n  },\n  unblame(_id) {\n    check(_id, String);\n    Collections.files.update({\n      _id: _id\n    }, {\n      $inc: {\n        'meta.blamed': -1\n      }\n    }, _app.NOOP);\n    return true;\n  },\n  blame(_id) {\n    check(_id, String);\n    Collections.files.update({\n      _id: _id\n    }, {\n      $inc: {\n        'meta.blamed': 1\n      }\n    }, _app.NOOP);\n    return true;\n  },\n  changeAccess(_id) {\n    check(_id, String);\n    if (Meteor.userId()) {\n      const file = Collections.files.findOne({\n        _id: _id,\n        userId: Meteor.userId()\n      });\n\n      if (file) {\n        Collections.files.update(_id, {\n          $set: {\n            'meta.unlisted': file.meta.unlisted ? false : true\n          }\n        }, _app.NOOP);\n        return true;\n      }\n    }\n    throw new Meteor.Error(401, 'Access denied!');\n  },\n  changePrivacy(_id) {\n    check(_id, String);\n    if (Meteor.userId()) {\n      const file = Collections.files.findOne({\n        _id: _id,\n        userId: Meteor.userId()\n      });\n\n      if (file) {\n        Collections.files.update(_id, {\n          $set: {\n            'meta.unlisted': true,\n            'meta.secured': file.meta.secured ? false : true\n          }\n        }, _app.NOOP);\n        return true;\n      }\n    }\n    throw new Meteor.Error(401, 'Access denied!');\n  },\n  getServiceConfiguration() {\n    return _app.sc;\n  }\n});\n","import { check }       from 'meteor/check';\nimport { Meteor }      from 'meteor/meteor';\nimport { Collections } from '/imports/lib/core.js';\n\nMeteor.publish('latest', function(take = 10, userOnly = false) {\n  check(take, Number);\n  check(userOnly, Boolean);\n\n  let selector;\n  if (userOnly && this.userId) {\n    selector = {\n      userId: this.userId\n    };\n  } else if (this.userId) {\n    selector = {\n      $or: [\n        {\n          'meta.unlisted': false,\n          'meta.secured': false,\n          'meta.blamed': {\n            $lt: 3\n          }\n        }, {\n          userId: this.userId,\n          'meta.blamed': {\n            $lt: 3\n          }\n        }\n      ]\n    };\n  } else {\n    selector = {\n      'meta.unlisted': false,\n      'meta.secured': false,\n      'meta.blamed': {\n        $lt: 3\n      }\n    };\n  }\n\n  return Collections.files.find(selector, {\n    limit: take,\n    sort: {\n      'meta.created_at': -1\n    },\n    fields: {\n      _id: 1,\n      name: 1,\n      size: 1,\n      meta: 1,\n      type: 1,\n      isPDF: 1,\n      isText: 1,\n      isJSON: 1,\n      isVideo: 1,\n      isAudio: 1,\n      isImage: 1,\n      userId: 1,\n      'versions.thumbnail40.extension': 1,\n      'versions.preview.extension': 1,\n      extension: 1,\n      _collectionName: 1,\n      _downloadRoute: 1\n    }\n  }).cursor;\n});\n\nMeteor.publish('file', function(_id) {\n  check(_id, String);\n\n  let selector = {\n    _id: _id,\n    'meta.secured': false\n  };\n\n  if (this.userId) {\n    selector = {\n      $or: [selector, {\n        _id: _id,\n        'meta.secured': true,\n        userId: this.userId\n      }]\n    };\n  }\n\n  return Collections.files.find(selector, {\n    fields: {\n      _id: 1,\n      name: 1,\n      size: 1,\n      type: 1,\n      meta: 1,\n      isPDF: 1,\n      isText: 1,\n      isJSON: 1,\n      isVideo: 1,\n      isAudio: 1,\n      isImage: 1,\n      extension: 1,\n      'versions.thumbnail40.extension': 1,\n      'versions.preview.extension': 1,\n      _collectionName: 1,\n      _downloadRoute: 1\n    }\n  }).cursor;\n});\n","import { _app }                 from '/imports/lib/core.js';\nimport { ServiceConfiguration } from 'meteor/service-configuration';\n\n_app.sc = {};\nServiceConfiguration.configurations.remove({});\n\nif (process.env.ACCOUNTS_METEOR_ID && process.env.ACCOUNTS_METEOR_SEC) {\n  _app.sc.meteor = true;\n  ServiceConfiguration.configurations.upsert({\n    service: 'meteor-developer'\n  }, {\n    $set: {\n      secret: process.env.ACCOUNTS_METEOR_SEC,\n      clientId: process.env.ACCOUNTS_METEOR_ID,\n      loginStyle: 'redirect'\n    }\n  });\n}\n\nif (process.env.ACCOUNTS_GITHUB_ID && process.env.ACCOUNTS_GITHUB_SEC) {\n  _app.sc.github = true;\n  ServiceConfiguration.configurations.upsert({\n    service: 'github'\n  }, {\n    $set: {\n      secret: process.env.ACCOUNTS_GITHUB_SEC,\n      clientId: process.env.ACCOUNTS_GITHUB_ID,\n      loginStyle: 'redirect'\n    }\n  });\n}\n\nif (process.env.ACCOUNTS_TWITTER_ID && process.env.ACCOUNTS_TWITTER_SEC) {\n  _app.sc.twitter = true;\n  ServiceConfiguration.configurations.upsert({\n    service: 'twitter'\n  }, {\n    $set: {\n      loginStyle: 'redirect',\n      secret: process.env.ACCOUNTS_TWITTER_SEC,\n      consumerKey: process.env.ACCOUNTS_TWITTER_ID\n    }\n  });\n}\n\nif (process.env.ACCOUNTS_FACEBOOK_ID && process.env.ACCOUNTS_FACEBOOK_SEC) {\n  _app.sc.facebook = true;\n  ServiceConfiguration.configurations.upsert({\n    service: 'facebook'\n  }, {\n    $set: {\n      secret: process.env.ACCOUNTS_FACEBOOK_SEC,\n      appId: process.env.ACCOUNTS_FACEBOOK_ID,\n      loginStyle: 'redirect'\n    }\n  });\n}\n","// import { WebApp } from 'meteor/webapp';\n// import Spiderable from 'meteor/ostrio:spiderable-middleware';\n//\n// WebApp.connectHandlers.use(new Spiderable({\n//   rootURL: 'https://files.veliov.com',\n//   serviceURL: 'https://render.ostr.io',\n//   auth: 'xxx:yyy'\n// }));\n","import '/imports/server/files.collection.js';\nimport '/imports/server/image-processing.js';\nimport '/imports/server/methods.js';\nimport '/imports/server/publications.js';\nimport '/imports/server/service-configurations.js';\nimport '/imports/server/spiderable.js';\n"]}