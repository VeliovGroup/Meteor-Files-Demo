{"version":3,"sources":["meteor://ðŸ’»app/packages/staringatlights:fast-render/lib/server/namespace.js","meteor://ðŸ’»app/packages/staringatlights:fast-render/lib/server/utils.js","meteor://ðŸ’»app/packages/staringatlights:fast-render/lib/server/routes.js","meteor://ðŸ’»app/packages/staringatlights:fast-render/lib/server/publish_context.js","meteor://ðŸ’»app/packages/staringatlights:fast-render/lib/server/context.js","meteor://ðŸ’»app/packages/staringatlights:fast-render/lib/server/ssr_helper.js"],"names":["module","export","FastRender","_routes","_onAllRoutes","IsAppUrl","RoutePolicy","watch","require","v","req","url","classify","test","headers","Fiber","default","Meteor","Picker","InjectData","PublishContext","_","connect","frContext","EnvironmentVariable","fastRenderRoutes","filter","res","middleware","cookieParser","next","handleOnAllRoutes","route","path","callback","indexOf","Error","handleRoute","bind","setQueryDataCallback","queryData","existingPayload","getData","pushData","extend","subscriptions","each","collectionData","data","pubName","existingData","concat","processingCallback","params","afterProcessed","_processRoutes","_processAllRoutes","onAllRoutes","push","routeCallback","loginToken","cookies","context","_Context","withValue","call","stop","err","handleError","forEach","run","message","stack","console","error","nullHandlers","default_server","universal_publish_handlers","publishHandler","publishContext","processPublication","Random","EJSON","MeteorX","handler","subscriptionId","name","self","sessionId","id","session","userId","inQueue","connectionHandle","close","onClose","clientAddress","httpHeaders","added","subscriptionHandle","collectionName","strId","fields","doc","clone","_id","_idFilter","idParse","_ensure","_collectionData","changed","value","key","undefined","removed","sendReady","subscriptionIds","_subscriptionId","_isDeactivated","_context","completeSubscriptions","_name","_params","Subscription","unblock","prototype","Object","create","constructor","_deactivate","warn","exportDefault","Fibers","Future","Accounts","DDP","Context","otherParams","_subscriptions","_loginToken","users","hashedToken","_hashLoginToken","query","options","user","findOne","current","_meteor_dynamics","_CurrentInvocation","slot","subscribe","subName","publish_handlers","Array","slice","arguments","ensureCollection","_ensureCollection","future","onStop","isResolved","return","_runHandler","setTimeout","wait","collData","values","subs","stringify","onPageLoad","originalSubscribe","args","get","apply","ready","_mergeFrData","injectToHead","sink","request","meteor_login_token"],"mappings":"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","file":"/packages/staringatlights_fast-render.js","sourcesContent":["export const FastRender = {\n\t_routes: [],\n\t_onAllRoutes: [],\n}\n","import { RoutePolicy } from 'meteor/routepolicy'\n\n// meteor algorithm to check if this is a meteor serving http request or not\nexport const IsAppUrl = function(req) {\n\tvar url = req.url\n\tif (url === '/favicon.ico' || url === '/robots.txt') {\n\t\treturn false\n\t}\n\n\t// NOTE: app.manifest is not a web standard like favicon.ico and\n\t// robots.txt. It is a file name we have chosen to use for HTML5\n\t// appcache URLs. It is included here to prevent using an appcache\n\t// then removing it from poisoning an app permanently. Eventually,\n\t// once we have server side routing, this won't be needed as\n\t// unknown URLs with return a 404 automatically.\n\tif (url === '/app.manifest') {\n\t\treturn false\n\t}\n\n\t// Avoid serving app HTML for declared routes such as /sockjs/.\n\tif (RoutePolicy.classify(url)) {\n\t\treturn false\n\t}\n\n\t// we only need to support HTML pages only\n\t// this is a check to do it\n\treturn /html/.test(req.headers['accept'])\n}\n","import Fiber from 'fibers'\nimport { FastRender } from './namespace'\nimport { Meteor } from 'meteor/meteor'\nimport { Picker } from 'meteor/meteorhacks:picker'\nimport { InjectData } from 'meteor/staringatlights:inject-data'\nimport PublishContext from './publish_context'\nimport { IsAppUrl } from './utils'\nimport { _ } from 'meteor/underscore'\nimport connect from 'connect'\n\nFastRender._onAllRoutes = []\nFastRender.frContext = new Meteor.EnvironmentVariable()\n\nvar fastRenderRoutes = Picker.filter(function(req, res) {\n\treturn IsAppUrl(req)\n})\nfastRenderRoutes.middleware(connect.cookieParser())\nfastRenderRoutes.middleware(function(req, res, next) {\n\tFastRender.handleOnAllRoutes(req, res, next)\n})\n\n// handling specific routes\nFastRender.route = function route(path, callback) {\n\tif (path.indexOf('/') !== 0) {\n\t\tthrow new Error(\n\t\t\t'Error: path (' + path + ') must begin with a leading slash \"/\"'\n\t\t)\n\t}\n\tfastRenderRoutes.route(path, FastRender.handleRoute.bind(null, callback))\n}\n\nfunction setQueryDataCallback(req, next) {\n\treturn function(queryData) {\n\t\tif (!queryData) return next()\n\n\t\tvar existingPayload = InjectData.getData(req, 'fast-render-data')\n\t\tif (!existingPayload) {\n\t\t\tInjectData.pushData(req, 'fast-render-data', queryData)\n\t\t} else {\n\t\t\t// it's possible to execute this callback twice\n\t\t\t// the we need to merge exisitng data with the new one\n\t\t\t_.extend(existingPayload.subscriptions, queryData.subscriptions)\n\t\t\t_.each(queryData.collectionData, function(data, pubName) {\n\t\t\t\tvar existingData = existingPayload.collectionData[pubName]\n\t\t\t\tif (existingData) {\n\t\t\t\t\tdata = existingData.concat(data)\n\t\t\t\t}\n\n\t\t\t\texistingPayload.collectionData[pubName] = data\n\t\t\t\tInjectData.pushData(req, 'fast-render-data', existingPayload)\n\t\t\t})\n\t\t}\n\t\tnext()\n\t}\n}\n\nFastRender.handleRoute = function(processingCallback, params, req, res, next) {\n\tvar afterProcessed = setQueryDataCallback(req, next)\n\tFastRender._processRoutes(params, req, processingCallback, afterProcessed)\n}\n\nFastRender.handleOnAllRoutes = function(req, res, next) {\n\tvar afterProcessed = setQueryDataCallback(req, next)\n\tFastRender._processAllRoutes(req, afterProcessed)\n}\n\nFastRender.onAllRoutes = function onAllRoutes(callback) {\n\tFastRender._onAllRoutes.push(callback)\n}\n\nFastRender._processRoutes = function _processRoutes(\n\tparams,\n\treq,\n\trouteCallback,\n\tcallback\n) {\n\tcallback = callback || function() {}\n\n\tvar path = req.url\n\tvar loginToken = req.cookies['meteor_login_token']\n\tvar headers = req.headers\n\n\tvar context = new FastRender._Context(loginToken, { headers: headers })\n\n\ttry {\n\t\tFastRender.frContext.withValue(context, function() {\n\t\t\trouteCallback.call(context, params, path)\n\t\t})\n\n\t\tif (context.stop) {\n\t\t\treturn\n\t\t}\n\n\t\tcallback(context.getData())\n\t} catch (err) {\n\t\thandleError(err, path, callback)\n\t}\n}\n\nFastRender._processAllRoutes = function _processAllRoutes(req, callback) {\n\tcallback = callback || function() {}\n\n\tvar path = req.url\n\tvar loginToken = req.cookies['meteor_login_token']\n\tvar headers = req.headers\n\n\tnew Fiber(function() {\n\t\tvar context = new FastRender._Context(loginToken, { headers: headers })\n\n\t\ttry {\n\t\t\tFastRender._onAllRoutes.forEach(function(callback) {\n\t\t\t\tcallback.call(context, req.url)\n\t\t\t})\n\n\t\t\tcallback(context.getData())\n\t\t} catch (err) {\n\t\t\thandleError(err, path, callback)\n\t\t}\n\t}).run()\n}\n\nfunction handleError(err, path, callback) {\n\tvar message =\n\t\t'error on fast-rendering path: ' + path + ' ; error: ' + err.stack\n\tconsole.error(message)\n\tcallback(null)\n}\n\n// adding support for null publications\nFastRender.onAllRoutes(function() {\n\tvar context = this\n\tvar nullHandlers = Meteor.default_server.universal_publish_handlers\n\n\tif (nullHandlers) {\n\t\tnullHandlers.forEach(function(publishHandler) {\n\t\t\t// universal subs have subscription ID, params, and name undefined\n\t\t\tvar publishContext = new PublishContext(context, publishHandler)\n\t\t\tcontext.processPublication(publishContext)\n\t\t})\n\t}\n})\n","import { Random } from 'meteor/random'\nimport { EJSON } from 'meteor/ejson'\nimport { Meteor } from 'meteor/meteor'\nimport { _ } from 'meteor/underscore'\nimport { MeteorX } from 'meteor/meteorhacks:meteorx'\n\nconst PublishContext = function PublishContext(\n\tcontext,\n\thandler,\n\tsubscriptionId,\n\tparams,\n\tname\n) {\n\tvar self = this\n\n\t// mock session\n\tvar sessionId = Random.id()\n\tvar session = {\n\t\tid: sessionId,\n\t\tuserId: context.userId,\n\t\t// not null\n\t\tinQueue: {},\n\t\tconnectionHandle: {\n\t\t\tid: sessionId,\n\t\t\tclose: function() {},\n\t\t\tonClose: function() {},\n\t\t\tclientAddress: '127.0.0.1',\n\t\t\thttpHeaders: context.headers,\n\t\t},\n\t\tadded: function(subscriptionHandle, collectionName, strId, fields) {\n\t\t\t// Don't share state with the data passed in by the user.\n\t\t\tvar doc = EJSON.clone(fields)\n\t\t\tdoc._id = self._idFilter.idParse(strId)\n\t\t\tMeteor._ensure(self._collectionData, collectionName)[strId] = doc\n\t\t},\n\t\tchanged: function(subscriptionHandle, collectionName, strId, fields) {\n\t\t\tvar doc = self._collectionData[collectionName][strId]\n\t\t\tif (!doc) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t'Could not find element with id ' + strId + ' to change'\n\t\t\t\t)\n\t\t\t}\n\t\t\t_.each(fields, function(value, key) {\n\t\t\t\t// Publish API ignores _id if present in fields.\n\t\t\t\tif (key === '_id') return\n\n\t\t\t\tif (value === undefined) {\n\t\t\t\t\tdelete doc[key]\n\t\t\t\t} else {\n\t\t\t\t\t// Don't share state with the data passed in by the user.\n\t\t\t\t\tdoc[key] = EJSON.clone(value)\n\t\t\t\t}\n\t\t\t})\n\t\t},\n\t\tremoved: function(subscriptionHandle, collectionName, strId) {\n\t\t\tif (\n\t\t\t\t!(\n\t\t\t\t\tself._collectionData[collectionName] &&\n\t\t\t\t\tself._collectionData[collectionName][strId]\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\tthrow new Error('Removed nonexistent document ' + strId)\n\t\t\t}\n\t\t\tdelete self._collectionData[collectionName][strId]\n\t\t},\n\t\tsendReady: function(subscriptionIds) {\n\t\t\t// this is called only for non-universal subscriptions\n\t\t\tif (!self._subscriptionId) throw new Error('Assertion.')\n\n\t\t\t// make the subscription be marked as ready\n\t\t\tif (!self._isDeactivated()) {\n\t\t\t\tself._context.completeSubscriptions(self._name, self._params)\n\t\t\t}\n\n\t\t\t// we just stop it\n\t\t\tself.stop()\n\t\t},\n\t}\n\n\tMeteorX.Subscription.call(\n\t\tself,\n\t\tsession,\n\t\thandler,\n\t\tsubscriptionId,\n\t\tparams,\n\t\tname\n\t)\n\n\tself.unblock = function() {}\n\n\tself._context = context\n\tself._collectionData = {}\n}\n\nPublishContext.prototype = Object.create(MeteorX.Subscription.prototype)\nPublishContext.prototype.constructor = PublishContext\n\nPublishContext.prototype.stop = function() {\n\t// our stop does not remove all documents (it just calls deactivate)\n\t// Meteor one removes documents for non-universal subscription\n\t// we deactivate both for universal and named subscriptions\n\t// hopefully this is right in our case\n\t// Meteor does it just for named subscriptions\n\tthis._deactivate()\n}\n\nPublishContext.prototype.error = function(error) {\n\t// TODO: Should we pass the error to the subscription somehow?\n\tconsole.warn(\n\t\t'error caught on publication: ',\n\t\tthis._name,\n\t\t': ',\n\t\terror.message || error\n\t)\n\tthis.stop()\n}\n\nexport default PublishContext\n","import { Meteor } from 'meteor/meteor'\nimport Fibers from 'fibers'\nimport Future from 'fibers/future'\nimport { Accounts } from 'meteor/accounts-base'\nimport { DDP } from 'meteor/ddp'\nimport { Random } from 'meteor/random'\nimport PublishContext from './publish_context'\nimport { _ } from 'meteor/underscore'\nimport { EJSON } from 'meteor/ejson'\nimport { FastRender } from './namespace'\n\nconst Context = function Context(loginToken, otherParams) {\n\tthis._collectionData = {}\n\tthis._subscriptions = {}\n\tthis._loginToken = loginToken\n\n\t_.extend(this, otherParams)\n\n\t// get the user\n\tif (Meteor.users) {\n\t\t// check to make sure, we've the loginToken,\n\t\t// otherwise a random user will fetched from the db\n\t\tif (loginToken) {\n\t\t\tvar hashedToken = loginToken && Accounts._hashLoginToken(loginToken)\n\t\t\tvar query = { 'services.resume.loginTokens.hashedToken': hashedToken }\n\t\t\tvar options = { fields: { _id: 1 } }\n\t\t\tvar user = Meteor.users.findOne(query, options)\n\t\t}\n\n\t\t// support for Meteor.user\n\t\tFibers.current._meteor_dynamics = []\n\t\tFibers.current._meteor_dynamics[DDP._CurrentInvocation.slot] = this\n\n\t\tif (user) {\n\t\t\tthis.userId = user._id\n\t\t}\n\t}\n}\n\nContext.prototype.subscribe = function(subName /*, params */) {\n\tvar publishHandler = Meteor.default_server.publish_handlers[subName]\n\tif (publishHandler) {\n\t\tvar params = Array.prototype.slice.call(arguments, 1)\n\t\t// non-universal subs have subscription id\n\t\tvar subscriptionId = Random.id()\n\t\tvar publishContext = new PublishContext(\n\t\t\tthis,\n\t\t\tpublishHandler,\n\t\t\tsubscriptionId,\n\t\t\tparams,\n\t\t\tsubName\n\t\t)\n\n\t\treturn this.processPublication(publishContext)\n\t} else {\n\t\tconsole.warn('There is no such publish handler named:', subName)\n\t\treturn {}\n\t}\n}\n\nContext.prototype.processPublication = function(publishContext) {\n\tvar self = this\n\tvar data = {}\n\tvar ensureCollection = function(collectionName) {\n\t\tself._ensureCollection(collectionName)\n\t\tif (!data[collectionName]) {\n\t\t\tdata[collectionName] = []\n\t\t}\n\t}\n\n\tvar future = new Future()\n\t// detect when the context is ready to be sent to the client\n\tpublishContext.onStop(function() {\n\t\tif (!future.isResolved()) {\n\t\t\tfuture.return()\n\t\t}\n\t})\n\n\tpublishContext._runHandler()\n\n\tif (!publishContext._subscriptionId) {\n\t\t// universal subscription, we stop it (same as marking it as ready) ourselves\n\t\t// they otherwise do not have ready or stopped state, but in our case they do\n\t\tpublishContext.stop()\n\t}\n\n\tif (!future.isResolved()) {\n\t\t// don't wait forever for handler to fire ready()\n\t\tMeteor.setTimeout(function() {\n\t\t\tif (!future.isResolved()) {\n\t\t\t\t// publish handler failed to send ready signal in time\n\t\t\t\t// maybe your non-universal publish handler is not calling this.ready()?\n\t\t\t\t// or maybe it is returning null to signal empty publish?\n\t\t\t\t// it should still call this.ready() or return an empty array []\n\t\t\t\tvar message =\n\t\t\t\t\t'Publish handler for ' +\n\t\t\t\t\tpublishContext._name +\n\t\t\t\t\t' sent no ready signal\\n' +\n\t\t\t\t\t' This could be because this publication `return null`.\\n' +\n\t\t\t\t\t' Use `return this.ready()` instead.'\n\t\t\t\tconsole.warn(message)\n\t\t\t\tfuture.return()\n\t\t\t}\n\t\t}, 500) // arbitrarially set timeout to 500ms, should probably be configurable\n\n\t\t//  wait for the subscription became ready.\n\t\tfuture.wait()\n\t}\n\n\t// stop any runaway subscription\n\t// this can happen if a publish handler never calls ready or stop, for example\n\t// it does not hurt to call it multiple times\n\tpublishContext.stop()\n\n\t// get the data\n\t_.each(publishContext._collectionData, function(collData, collectionName) {\n\t\t// making an array from a map\n\t\tcollData = _.values(collData)\n\n\t\tensureCollection(collectionName)\n\t\tdata[collectionName].push(collData)\n\n\t\t// copy the collection data in publish context into the FR context\n\t\tself._collectionData[collectionName].push(collData)\n\t})\n\n\treturn data\n}\n\nContext.prototype.completeSubscriptions = function(name, params) {\n\tvar subs = this._subscriptions[name]\n\tif (!subs) {\n\t\tsubs = this._subscriptions[name] = {}\n\t}\n\n\tsubs[EJSON.stringify(params)] = true\n}\n\nContext.prototype._ensureCollection = function(collectionName) {\n\tif (!this._collectionData[collectionName]) {\n\t\tthis._collectionData[collectionName] = []\n\t}\n}\n\nContext.prototype.getData = function() {\n\treturn {\n\t\tcollectionData: this._collectionData,\n\t\tsubscriptions: this._subscriptions,\n\t\tloginToken: this._loginToken,\n\t}\n}\n\nFastRender._Context = Context\n","import { Meteor } from 'meteor/meteor'\nimport { FastRender } from 'meteor/staringatlights:fast-render'\nimport { InjectData } from 'meteor/staringatlights:inject-data'\nimport { onPageLoad } from 'meteor/server-render'\nimport { _ } from 'meteor/underscore'\n\nconst originalSubscribe = Meteor.subscribe\nMeteor.subscribe = function(name, ...args) {\n\tconst frContext = FastRender.frContext.get()\n\tif (!frContext) {\n\t\tthrow new Error(\n\t\t\t`Cannot add a subscription: ${name} without FastRender Context`\n\t\t)\n\t}\n\tfrContext.subscribe(name, ...args)\n\n\tif (originalSubscribe) {\n\t\toriginalSubscribe.apply(this, arguments)\n\t}\n\n\treturn {\n\t\tready: () => true,\n\t}\n}\n\nFastRender._mergeFrData = function(req, queryData) {\n\tvar existingPayload = InjectData.getData(req, 'fast-render-data')\n\tif (!existingPayload) {\n\t\tInjectData.pushData(req, 'fast-render-data', queryData)\n\t} else {\n\t\t// it's possible to execute this callback twice\n\t\t// the we need to merge exisitng data with the new one\n\t\t_.extend(existingPayload.subscriptions, queryData.subscriptions)\n\t\t_.each(queryData.collectionData, function(data, pubName) {\n\t\t\tvar existingData = existingPayload.collectionData[pubName]\n\t\t\tif (existingData) {\n\t\t\t\tdata = existingData.concat(data)\n\t\t\t}\n\n\t\t\texistingPayload.collectionData[pubName] = data\n\t\t\tInjectData.pushData(req, 'fast-render-data', existingPayload)\n\t\t})\n\t}\n}\n\nFastRender.onPageLoad = function(callback) {\n\tInjectData.injectToHead = false\n\tonPageLoad(async sink => {\n\t\tconst frContext = new FastRender._Context(\n\t\t\tsink.request.cookies.meteor_login_token,\n\t\t\t{\n\t\t\t\theaders: sink.headers,\n\t\t\t}\n\t\t)\n\n\t\tawait FastRender.frContext.withValue(frContext, async function() {\n\t\t\tawait callback(sink)\n\t\t\tFastRender._mergeFrData(\n\t\t\t\tsink.request,\n\t\t\t\tFastRender.frContext.get().getData()\n\t\t\t)\n\t\t})\n\t})\n}\n"]}