{"version":3,"sources":["meteor://ðŸ’»app/packages/staringatlights:fast-render/lib/server/namespace.js","meteor://ðŸ’»app/packages/staringatlights:fast-render/lib/server/utils.js","meteor://ðŸ’»app/packages/staringatlights:fast-render/lib/server/routes.js","meteor://ðŸ’»app/packages/staringatlights:fast-render/lib/server/publish_context.js","meteor://ðŸ’»app/packages/staringatlights:fast-render/lib/server/context.js","meteor://ðŸ’»app/packages/staringatlights:fast-render/lib/server/ssr_helper.js"],"names":["module","export","FastRender","_routes","_onAllRoutes","IsAppUrl","RoutePolicy","link","v","req","url","classify","test","headers","Fiber","default","Meteor","Picker","InjectData","PublishContext","_","connect","frContext","EnvironmentVariable","fastRenderRoutes","filter","res","middleware","cookieParser","next","handleOnAllRoutes","route","path","callback","indexOf","Error","handleRoute","bind","setQueryDataCallback","queryData","existingPayload","getData","pushData","extend","subscriptions","each","collectionData","data","pubName","existingData","concat","processingCallback","params","afterProcessed","_processRoutes","_processAllRoutes","onAllRoutes","push","routeCallback","loginToken","cookies","context","_Context","withValue","call","stop","err","handleError","forEach","run","message","stack","console","error","nullHandlers","default_server","universal_publish_handlers","publishHandler","publishContext","processPublication","Random","EJSON","MeteorX","handler","subscriptionId","name","self","sessionId","id","session","userId","inQueue","connectionHandle","close","onClose","clientAddress","httpHeaders","added","subscriptionHandle","collectionName","strId","fields","doc","clone","_id","_idFilter","idParse","_ensure","_collectionData","changed","value","key","undefined","removed","sendReady","subscriptionIds","_subscriptionId","_isDeactivated","_context","completeSubscriptions","_name","_params","Subscription","unblock","prototype","Object","create","constructor","_deactivate","warn","exportDefault","Fibers","Future","Accounts","DDP","Context","otherParams","_subscriptions","_loginToken","users","hashedToken","_hashLoginToken","query","options","user","findOne","current","_meteor_dynamics","_CurrentInvocation","slot","subscribe","subName","publish_handlers","Array","slice","arguments","ensureCollection","_ensureCollection","future","onStop","isResolved","return","_runHandler","setTimeout","wait","collData","values","subs","length","lastParam","hasOwnProperty","pop","stringify","onPageLoad","originalSubscribe","args","get","apply","ready","_mergeFrData","injectToHead","sink","request","meteor_login_token"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAAA,MAAM,CAACC,MAAP,CAAc;AAACC,YAAU,EAAC,MAAIA;AAAhB,CAAd;AAAO,MAAMA,UAAU,GAAG;AACzBC,SAAO,EAAE,EADgB;AAEzBC,cAAY,EAAE;AAFW,CAAnB,C;;;;;;;;;;;ACAPJ,MAAM,CAACC,MAAP,CAAc;AAACI,UAAQ,EAAC,MAAIA;AAAd,CAAd;AAAuC,IAAIC,WAAJ;AAAgBN,MAAM,CAACO,IAAP,CAAY,oBAAZ,EAAiC;AAACD,aAAW,CAACE,CAAD,EAAG;AAACF,eAAW,GAACE,CAAZ;AAAc;;AAA9B,CAAjC,EAAiE,CAAjE;;AAGhD,MAAMH,QAAQ,GAAG,UAASI,GAAT,EAAc;AACrC,MAAIC,GAAG,GAAGD,GAAG,CAACC,GAAd;;AACA,MAAIA,GAAG,KAAK,cAAR,IAA0BA,GAAG,KAAK,aAAtC,EAAqD;AACpD,WAAO,KAAP;AACA,GAJoC,CAMrC;AACA;AACA;AACA;AACA;AACA;;;AACA,MAAIA,GAAG,KAAK,eAAZ,EAA6B;AAC5B,WAAO,KAAP;AACA,GAdoC,CAgBrC;;;AACA,MAAIJ,WAAW,CAACK,QAAZ,CAAqBD,GAArB,CAAJ,EAA+B;AAC9B,WAAO,KAAP;AACA,GAnBoC,CAqBrC;AACA;;;AACA,SAAO,OAAOE,IAAP,CAAYH,GAAG,CAACI,OAAJ,CAAY,QAAZ,CAAZ,CAAP;AACA,CAxBM,C;;;;;;;;;;;ACHP,IAAIC,KAAJ;AAAUd,MAAM,CAACO,IAAP,CAAY,QAAZ,EAAqB;AAACQ,SAAO,CAACP,CAAD,EAAG;AAACM,SAAK,GAACN,CAAN;AAAQ;;AAApB,CAArB,EAA2C,CAA3C;AAA8C,IAAIN,UAAJ;AAAeF,MAAM,CAACO,IAAP,CAAY,aAAZ,EAA0B;AAACL,YAAU,CAACM,CAAD,EAAG;AAACN,cAAU,GAACM,CAAX;AAAa;;AAA5B,CAA1B,EAAwD,CAAxD;AAA2D,IAAIQ,MAAJ;AAAWhB,MAAM,CAACO,IAAP,CAAY,eAAZ,EAA4B;AAACS,QAAM,CAACR,CAAD,EAAG;AAACQ,UAAM,GAACR,CAAP;AAAS;;AAApB,CAA5B,EAAkD,CAAlD;AAAqD,IAAIS,MAAJ;AAAWjB,MAAM,CAACO,IAAP,CAAY,2BAAZ,EAAwC;AAACU,QAAM,CAACT,CAAD,EAAG;AAACS,UAAM,GAACT,CAAP;AAAS;;AAApB,CAAxC,EAA8D,CAA9D;AAAiE,IAAIU,UAAJ;AAAelB,MAAM,CAACO,IAAP,CAAY,oCAAZ,EAAiD;AAACW,YAAU,CAACV,CAAD,EAAG;AAACU,cAAU,GAACV,CAAX;AAAa;;AAA5B,CAAjD,EAA+E,CAA/E;AAAkF,IAAIW,cAAJ;AAAmBnB,MAAM,CAACO,IAAP,CAAY,mBAAZ,EAAgC;AAACQ,SAAO,CAACP,CAAD,EAAG;AAACW,kBAAc,GAACX,CAAf;AAAiB;;AAA7B,CAAhC,EAA+D,CAA/D;AAAkE,IAAIH,QAAJ;AAAaL,MAAM,CAACO,IAAP,CAAY,SAAZ,EAAsB;AAACF,UAAQ,CAACG,CAAD,EAAG;AAACH,YAAQ,GAACG,CAAT;AAAW;;AAAxB,CAAtB,EAAgD,CAAhD;;AAAmD,IAAIY,CAAJ;;AAAMpB,MAAM,CAACO,IAAP,CAAY,mBAAZ,EAAgC;AAACa,GAAC,CAACZ,CAAD,EAAG;AAACY,KAAC,GAACZ,CAAF;AAAI;;AAAV,CAAhC,EAA4C,CAA5C;AAA+C,IAAIa,OAAJ;AAAYrB,MAAM,CAACO,IAAP,CAAY,SAAZ,EAAsB;AAACQ,SAAO,CAACP,CAAD,EAAG;AAACa,WAAO,GAACb,CAAR;AAAU;;AAAtB,CAAtB,EAA8C,CAA9C;AAUrkBN,UAAU,CAACE,YAAX,GAA0B,EAA1B;AACAF,UAAU,CAACoB,SAAX,GAAuB,IAAIN,MAAM,CAACO,mBAAX,EAAvB;AAEA,IAAIC,gBAAgB,GAAGP,MAAM,CAACQ,MAAP,CAAc,UAAShB,GAAT,EAAciB,GAAd,EAAmB;AACvD,SAAOrB,QAAQ,CAACI,GAAD,CAAf;AACA,CAFsB,CAAvB;AAGAe,gBAAgB,CAACG,UAAjB,CAA4BN,OAAO,CAACO,YAAR,EAA5B;AACAJ,gBAAgB,CAACG,UAAjB,CAA4B,UAASlB,GAAT,EAAciB,GAAd,EAAmBG,IAAnB,EAAyB;AACpD3B,YAAU,CAAC4B,iBAAX,CAA6BrB,GAA7B,EAAkCiB,GAAlC,EAAuCG,IAAvC;AACA,CAFD,E,CAIA;;AACA3B,UAAU,CAAC6B,KAAX,GAAmB,SAASA,KAAT,CAAeC,IAAf,EAAqBC,QAArB,EAA+B;AACjD,MAAID,IAAI,CAACE,OAAL,CAAa,GAAb,MAAsB,CAA1B,EAA6B;AAC5B,UAAM,IAAIC,KAAJ,CACL,kBAAkBH,IAAlB,GAAyB,uCADpB,CAAN;AAGA;;AACDR,kBAAgB,CAACO,KAAjB,CAAuBC,IAAvB,EAA6B9B,UAAU,CAACkC,WAAX,CAAuBC,IAAvB,CAA4B,IAA5B,EAAkCJ,QAAlC,CAA7B;AACA,CAPD;;AASA,SAASK,oBAAT,CAA8B7B,GAA9B,EAAmCoB,IAAnC,EAAyC;AACxC,SAAO,UAASU,SAAT,EAAoB;AAC1B,QAAI,CAACA,SAAL,EAAgB,OAAOV,IAAI,EAAX;AAEhB,QAAIW,eAAe,GAAGtB,UAAU,CAACuB,OAAX,CAAmBhC,GAAnB,EAAwB,kBAAxB,CAAtB;;AACA,QAAI,CAAC+B,eAAL,EAAsB;AACrBtB,gBAAU,CAACwB,QAAX,CAAoBjC,GAApB,EAAyB,kBAAzB,EAA6C8B,SAA7C;AACA,KAFD,MAEO;AACN;AACA;AACAnB,OAAC,CAACuB,MAAF,CAASH,eAAe,CAACI,aAAzB,EAAwCL,SAAS,CAACK,aAAlD;;AACAxB,OAAC,CAACyB,IAAF,CAAON,SAAS,CAACO,cAAjB,EAAiC,UAASC,IAAT,EAAeC,OAAf,EAAwB;AACxD,YAAIC,YAAY,GAAGT,eAAe,CAACM,cAAhB,CAA+BE,OAA/B,CAAnB;;AACA,YAAIC,YAAJ,EAAkB;AACjBF,cAAI,GAAGE,YAAY,CAACC,MAAb,CAAoBH,IAApB,CAAP;AACA;;AAEDP,uBAAe,CAACM,cAAhB,CAA+BE,OAA/B,IAA0CD,IAA1C;AACA7B,kBAAU,CAACwB,QAAX,CAAoBjC,GAApB,EAAyB,kBAAzB,EAA6C+B,eAA7C;AACA,OARD;AASA;;AACDX,QAAI;AACJ,GArBD;AAsBA;;AAED3B,UAAU,CAACkC,WAAX,GAAyB,UAASe,kBAAT,EAA6BC,MAA7B,EAAqC3C,GAArC,EAA0CiB,GAA1C,EAA+CG,IAA/C,EAAqD;AAC7E,MAAIwB,cAAc,GAAGf,oBAAoB,CAAC7B,GAAD,EAAMoB,IAAN,CAAzC;;AACA3B,YAAU,CAACoD,cAAX,CAA0BF,MAA1B,EAAkC3C,GAAlC,EAAuC0C,kBAAvC,EAA2DE,cAA3D;AACA,CAHD;;AAKAnD,UAAU,CAAC4B,iBAAX,GAA+B,UAASrB,GAAT,EAAciB,GAAd,EAAmBG,IAAnB,EAAyB;AACvD,MAAIwB,cAAc,GAAGf,oBAAoB,CAAC7B,GAAD,EAAMoB,IAAN,CAAzC;;AACA3B,YAAU,CAACqD,iBAAX,CAA6B9C,GAA7B,EAAkC4C,cAAlC;AACA,CAHD;;AAKAnD,UAAU,CAACsD,WAAX,GAAyB,SAASA,WAAT,CAAqBvB,QAArB,EAA+B;AACvD/B,YAAU,CAACE,YAAX,CAAwBqD,IAAxB,CAA6BxB,QAA7B;AACA,CAFD;;AAIA/B,UAAU,CAACoD,cAAX,GAA4B,SAASA,cAAT,CAC3BF,MAD2B,EAE3B3C,GAF2B,EAG3BiD,aAH2B,EAI3BzB,QAJ2B,EAK1B;AACDA,UAAQ,GAAGA,QAAQ,IAAI,YAAW,CAAE,CAApC;;AAEA,MAAID,IAAI,GAAGvB,GAAG,CAACC,GAAf;AACA,MAAIiD,UAAU,GAAGlD,GAAG,CAACmD,OAAJ,CAAY,oBAAZ,CAAjB;AACA,MAAI/C,OAAO,GAAGJ,GAAG,CAACI,OAAlB;AAEA,MAAIgD,OAAO,GAAG,IAAI3D,UAAU,CAAC4D,QAAf,CAAwBH,UAAxB,EAAoC;AAAE9C,WAAO,EAAEA;AAAX,GAApC,CAAd;;AAEA,MAAI;AACHX,cAAU,CAACoB,SAAX,CAAqByC,SAArB,CAA+BF,OAA/B,EAAwC,YAAW;AAClDH,mBAAa,CAACM,IAAd,CAAmBH,OAAnB,EAA4BT,MAA5B,EAAoCpB,IAApC;AACA,KAFD;;AAIA,QAAI6B,OAAO,CAACI,IAAZ,EAAkB;AACjB;AACA;;AAEDhC,YAAQ,CAAC4B,OAAO,CAACpB,OAAR,EAAD,CAAR;AACA,GAVD,CAUE,OAAOyB,GAAP,EAAY;AACbC,eAAW,CAACD,GAAD,EAAMlC,IAAN,EAAYC,QAAZ,CAAX;AACA;AACD,CA3BD;;AA6BA/B,UAAU,CAACqD,iBAAX,GAA+B,SAASA,iBAAT,CAA2B9C,GAA3B,EAAgCwB,QAAhC,EAA0C;AACxEA,UAAQ,GAAGA,QAAQ,IAAI,YAAW,CAAE,CAApC;;AAEA,MAAID,IAAI,GAAGvB,GAAG,CAACC,GAAf;AACA,MAAIiD,UAAU,GAAGlD,GAAG,CAACmD,OAAJ,CAAY,oBAAZ,CAAjB;AACA,MAAI/C,OAAO,GAAGJ,GAAG,CAACI,OAAlB;AAEA,MAAIC,KAAJ,CAAU,YAAW;AACpB,QAAI+C,OAAO,GAAG,IAAI3D,UAAU,CAAC4D,QAAf,CAAwBH,UAAxB,EAAoC;AAAE9C,aAAO,EAAEA;AAAX,KAApC,CAAd;;AAEA,QAAI;AACHX,gBAAU,CAACE,YAAX,CAAwBgE,OAAxB,CAAgC,UAASnC,QAAT,EAAmB;AAClDA,gBAAQ,CAAC+B,IAAT,CAAcH,OAAd,EAAuBpD,GAAG,CAACC,GAA3B;AACA,OAFD;;AAIAuB,cAAQ,CAAC4B,OAAO,CAACpB,OAAR,EAAD,CAAR;AACA,KAND,CAME,OAAOyB,GAAP,EAAY;AACbC,iBAAW,CAACD,GAAD,EAAMlC,IAAN,EAAYC,QAAZ,CAAX;AACA;AACD,GAZD,EAYGoC,GAZH;AAaA,CApBD;;AAsBA,SAASF,WAAT,CAAqBD,GAArB,EAA0BlC,IAA1B,EAAgCC,QAAhC,EAA0C;AACzC,MAAIqC,OAAO,GACV,mCAAmCtC,IAAnC,GAA0C,YAA1C,GAAyDkC,GAAG,CAACK,KAD9D;AAEAC,SAAO,CAACC,KAAR,CAAcH,OAAd;AACArC,UAAQ,CAAC,IAAD,CAAR;AACA,C,CAED;;;AACA/B,UAAU,CAACsD,WAAX,CAAuB,YAAW;AACjC,MAAIK,OAAO,GAAG,IAAd;AACA,MAAIa,YAAY,GAAG1D,MAAM,CAAC2D,cAAP,CAAsBC,0BAAzC;;AAEA,MAAIF,YAAJ,EAAkB;AACjBA,gBAAY,CAACN,OAAb,CAAqB,UAASS,cAAT,EAAyB;AAC7C;AACA,UAAIC,cAAc,GAAG,IAAI3D,cAAJ,CAAmB0C,OAAnB,EAA4BgB,cAA5B,CAArB;AACAhB,aAAO,CAACkB,kBAAR,CAA2BD,cAA3B;AACA,KAJD;AAKA;AACD,CAXD,E;;;;;;;;;;;ACjIA,IAAIE,MAAJ;AAAWhF,MAAM,CAACO,IAAP,CAAY,eAAZ,EAA4B;AAACyE,QAAM,CAACxE,CAAD,EAAG;AAACwE,UAAM,GAACxE,CAAP;AAAS;;AAApB,CAA5B,EAAkD,CAAlD;AAAqD,IAAIyE,KAAJ;AAAUjF,MAAM,CAACO,IAAP,CAAY,cAAZ,EAA2B;AAAC0E,OAAK,CAACzE,CAAD,EAAG;AAACyE,SAAK,GAACzE,CAAN;AAAQ;;AAAlB,CAA3B,EAA+C,CAA/C;AAAkD,IAAIQ,MAAJ;AAAWhB,MAAM,CAACO,IAAP,CAAY,eAAZ,EAA4B;AAACS,QAAM,CAACR,CAAD,EAAG;AAACQ,UAAM,GAACR,CAAP;AAAS;;AAApB,CAA5B,EAAkD,CAAlD;;AAAqD,IAAIY,CAAJ;;AAAMpB,MAAM,CAACO,IAAP,CAAY,mBAAZ,EAAgC;AAACa,GAAC,CAACZ,CAAD,EAAG;AAACY,KAAC,GAACZ,CAAF;AAAI;;AAAV,CAAhC,EAA4C,CAA5C;AAA+C,IAAI0E,OAAJ;AAAYlF,MAAM,CAACO,IAAP,CAAY,wBAAZ,EAAqC;AAAC2E,SAAO,CAAC1E,CAAD,EAAG;AAAC0E,WAAO,GAAC1E,CAAR;AAAU;;AAAtB,CAArC,EAA6D,CAA7D;;AAM7P,MAAMW,cAAc,GAAG,SAASA,cAAT,CACtB0C,OADsB,EAEtBsB,OAFsB,EAGtBC,cAHsB,EAItBhC,MAJsB,EAKtBiC,IALsB,EAMrB;AACD,MAAIC,IAAI,GAAG,IAAX,CADC,CAGD;;AACA,MAAIC,SAAS,GAAGP,MAAM,CAACQ,EAAP,EAAhB;AACA,MAAIC,OAAO,GAAG;AACbD,MAAE,EAAED,SADS;AAEbG,UAAM,EAAE7B,OAAO,CAAC6B,MAFH;AAGb;AACAC,WAAO,EAAE,EAJI;AAKbC,oBAAgB,EAAE;AACjBJ,QAAE,EAAED,SADa;AAEjBM,WAAK,EAAE,YAAW,CAAE,CAFH;AAGjBC,aAAO,EAAE,YAAW,CAAE,CAHL;AAIjBC,mBAAa,EAAE,WAJE;AAKjBC,iBAAW,EAAEnC,OAAO,CAAChD;AALJ,KALL;AAYboF,SAAK,EAAE,UAASC,kBAAT,EAA6BC,cAA7B,EAA6CC,KAA7C,EAAoDC,MAApD,EAA4D;AAClE;AACA,UAAIC,GAAG,GAAGrB,KAAK,CAACsB,KAAN,CAAYF,MAAZ,CAAV;AACAC,SAAG,CAACE,GAAJ,GAAUlB,IAAI,CAACmB,SAAL,CAAeC,OAAf,CAAuBN,KAAvB,CAAV;AACApF,YAAM,CAAC2F,OAAP,CAAerB,IAAI,CAACsB,eAApB,EAAqCT,cAArC,EAAqDC,KAArD,IAA8DE,GAA9D;AACA,KAjBY;AAkBbO,WAAO,EAAE,UAASX,kBAAT,EAA6BC,cAA7B,EAA6CC,KAA7C,EAAoDC,MAApD,EAA4D;AACpE,UAAIC,GAAG,GAAGhB,IAAI,CAACsB,eAAL,CAAqBT,cAArB,EAAqCC,KAArC,CAAV;;AACA,UAAI,CAACE,GAAL,EAAU;AACT,cAAM,IAAInE,KAAJ,CACL,oCAAoCiE,KAApC,GAA4C,YADvC,CAAN;AAGA;;AACDhF,OAAC,CAACyB,IAAF,CAAOwD,MAAP,EAAe,UAASS,KAAT,EAAgBC,GAAhB,EAAqB;AACnC;AACA,YAAIA,GAAG,KAAK,KAAZ,EAAmB;;AAEnB,YAAID,KAAK,KAAKE,SAAd,EAAyB;AACxB,iBAAOV,GAAG,CAACS,GAAD,CAAV;AACA,SAFD,MAEO;AACN;AACAT,aAAG,CAACS,GAAD,CAAH,GAAW9B,KAAK,CAACsB,KAAN,CAAYO,KAAZ,CAAX;AACA;AACD,OAVD;AAWA,KApCY;AAqCbG,WAAO,EAAE,UAASf,kBAAT,EAA6BC,cAA7B,EAA6CC,KAA7C,EAAoD;AAC5D,UACC,EACCd,IAAI,CAACsB,eAAL,CAAqBT,cAArB,KACAb,IAAI,CAACsB,eAAL,CAAqBT,cAArB,EAAqCC,KAArC,CAFD,CADD,EAKE;AACD,cAAM,IAAIjE,KAAJ,CAAU,kCAAkCiE,KAA5C,CAAN;AACA;;AACD,aAAOd,IAAI,CAACsB,eAAL,CAAqBT,cAArB,EAAqCC,KAArC,CAAP;AACA,KA/CY;AAgDbc,aAAS,EAAE,UAASC,eAAT,EAA0B;AACpC;AACA,UAAI,CAAC7B,IAAI,CAAC8B,eAAV,EAA2B,MAAM,IAAIjF,KAAJ,CAAU,YAAV,CAAN,CAFS,CAIpC;;AACA,UAAI,CAACmD,IAAI,CAAC+B,cAAL,EAAL,EAA4B;AAC3B/B,YAAI,CAACgC,QAAL,CAAcC,qBAAd,CAAoCjC,IAAI,CAACkC,KAAzC,EAAgDlC,IAAI,CAACmC,OAArD;AACA,OAPmC,CASpC;;;AACAnC,UAAI,CAACrB,IAAL;AACA;AA3DY,GAAd;AA8DAiB,SAAO,CAACwC,YAAR,CAAqB1D,IAArB,CACCsB,IADD,EAECG,OAFD,EAGCN,OAHD,EAICC,cAJD,EAKChC,MALD,EAMCiC,IAND;;AASAC,MAAI,CAACqC,OAAL,GAAe,YAAW,CAAE,CAA5B;;AAEArC,MAAI,CAACgC,QAAL,GAAgBzD,OAAhB;AACAyB,MAAI,CAACsB,eAAL,GAAuB,EAAvB;AACA,CAtFD;;AAwFAzF,cAAc,CAACyG,SAAf,GAA2BC,MAAM,CAACC,MAAP,CAAc5C,OAAO,CAACwC,YAAR,CAAqBE,SAAnC,CAA3B;AACAzG,cAAc,CAACyG,SAAf,CAAyBG,WAAzB,GAAuC5G,cAAvC;;AAEAA,cAAc,CAACyG,SAAf,CAAyB3D,IAAzB,GAAgC,YAAW;AAC1C;AACA;AACA;AACA;AACA;AACA,OAAK+D,WAAL;AACA,CAPD;;AASA7G,cAAc,CAACyG,SAAf,CAAyBnD,KAAzB,GAAiC,UAASA,KAAT,EAAgB;AAChD;AACAD,SAAO,CAACyD,IAAR,CACC,+BADD,EAEC,KAAKT,KAFN,EAGC,IAHD,EAIC/C,KAAK,CAACH,OAAN,IAAiBG,KAJlB;AAMA,OAAKR,IAAL;AACA,CATD;;AA1GAjE,MAAM,CAACkI,aAAP,CAqHe/G,cArHf,E;;;;;;;;;;;ACAA,IAAIH,MAAJ;AAAWhB,MAAM,CAACO,IAAP,CAAY,eAAZ,EAA4B;AAACS,QAAM,CAACR,CAAD,EAAG;AAACQ,UAAM,GAACR,CAAP;AAAS;;AAApB,CAA5B,EAAkD,CAAlD;AAAqD,IAAI2H,MAAJ;AAAWnI,MAAM,CAACO,IAAP,CAAY,QAAZ,EAAqB;AAACQ,SAAO,CAACP,CAAD,EAAG;AAAC2H,UAAM,GAAC3H,CAAP;AAAS;;AAArB,CAArB,EAA4C,CAA5C;AAA+C,IAAI4H,MAAJ;AAAWpI,MAAM,CAACO,IAAP,CAAY,eAAZ,EAA4B;AAACQ,SAAO,CAACP,CAAD,EAAG;AAAC4H,UAAM,GAAC5H,CAAP;AAAS;;AAArB,CAA5B,EAAmD,CAAnD;AAAsD,IAAI6H,QAAJ;AAAarI,MAAM,CAACO,IAAP,CAAY,sBAAZ,EAAmC;AAAC8H,UAAQ,CAAC7H,CAAD,EAAG;AAAC6H,YAAQ,GAAC7H,CAAT;AAAW;;AAAxB,CAAnC,EAA6D,CAA7D;AAAgE,IAAI8H,GAAJ;AAAQtI,MAAM,CAACO,IAAP,CAAY,YAAZ,EAAyB;AAAC+H,KAAG,CAAC9H,CAAD,EAAG;AAAC8H,OAAG,GAAC9H,CAAJ;AAAM;;AAAd,CAAzB,EAAyC,CAAzC;AAA4C,IAAIwE,MAAJ;AAAWhF,MAAM,CAACO,IAAP,CAAY,eAAZ,EAA4B;AAACyE,QAAM,CAACxE,CAAD,EAAG;AAACwE,UAAM,GAACxE,CAAP;AAAS;;AAApB,CAA5B,EAAkD,CAAlD;AAAqD,IAAIW,cAAJ;AAAmBnB,MAAM,CAACO,IAAP,CAAY,mBAAZ,EAAgC;AAACQ,SAAO,CAACP,CAAD,EAAG;AAACW,kBAAc,GAACX,CAAf;AAAiB;;AAA7B,CAAhC,EAA+D,CAA/D;;AAAkE,IAAIY,CAAJ;;AAAMpB,MAAM,CAACO,IAAP,CAAY,mBAAZ,EAAgC;AAACa,GAAC,CAACZ,CAAD,EAAG;AAACY,KAAC,GAACZ,CAAF;AAAI;;AAAV,CAAhC,EAA4C,CAA5C;AAA+C,IAAIyE,KAAJ;AAAUjF,MAAM,CAACO,IAAP,CAAY,cAAZ,EAA2B;AAAC0E,OAAK,CAACzE,CAAD,EAAG;AAACyE,SAAK,GAACzE,CAAN;AAAQ;;AAAlB,CAA3B,EAA+C,CAA/C;AAAkD,IAAIN,UAAJ;AAAeF,MAAM,CAACO,IAAP,CAAY,aAAZ,EAA0B;AAACL,YAAU,CAACM,CAAD,EAAG;AAACN,cAAU,GAACM,CAAX;AAAa;;AAA5B,CAA1B,EAAwD,CAAxD;;AAWjlB,MAAM+H,OAAO,GAAG,SAASA,OAAT,CAAiB5E,UAAjB,EAA6B6E,WAA7B,EAA0C;AACzD,OAAK5B,eAAL,GAAuB,EAAvB;AACA,OAAK6B,cAAL,GAAsB,EAAtB;AACA,OAAKC,WAAL,GAAmB/E,UAAnB;;AAEAvC,GAAC,CAACuB,MAAF,CAAS,IAAT,EAAe6F,WAAf,EALyD,CAOzD;;;AACA,MAAIxH,MAAM,CAAC2H,KAAX,EAAkB;AACjB;AACA;AACA,QAAIhF,UAAJ,EAAgB;AACf,UAAIiF,WAAW,GAAGjF,UAAU,IAAI0E,QAAQ,CAACQ,eAAT,CAAyBlF,UAAzB,CAAhC;;AACA,UAAImF,KAAK,GAAG;AAAE,mDAA2CF;AAA7C,OAAZ;AACA,UAAIG,OAAO,GAAG;AAAE1C,cAAM,EAAE;AAAEG,aAAG,EAAE;AAAP;AAAV,OAAd;AACA,UAAIwC,IAAI,GAAGhI,MAAM,CAAC2H,KAAP,CAAaM,OAAb,CAAqBH,KAArB,EAA4BC,OAA5B,CAAX;AACA,KARgB,CAUjB;;;AACAZ,UAAM,CAACe,OAAP,CAAeC,gBAAf,GAAkC,EAAlC;AACAhB,UAAM,CAACe,OAAP,CAAeC,gBAAf,CAAgCb,GAAG,CAACc,kBAAJ,CAAuBC,IAAvD,IAA+D,IAA/D;;AAEA,QAAIL,IAAJ,EAAU;AACT,WAAKtD,MAAL,GAAcsD,IAAI,CAACxC,GAAnB;AACA;AACD;AACD,CA1BD;;AA4BA+B,OAAO,CAACX,SAAR,CAAkB0B,SAAlB,GAA8B,UAASC;AAAQ;AAAjB,EAAgC;AAC7D,MAAI1E,cAAc,GAAG7D,MAAM,CAAC2D,cAAP,CAAsB6E,gBAAtB,CAAuCD,OAAvC,CAArB;;AACA,MAAI1E,cAAJ,EAAoB;AACnB,QAAIzB,MAAM,GAAGqG,KAAK,CAAC7B,SAAN,CAAgB8B,KAAhB,CAAsB1F,IAAtB,CAA2B2F,SAA3B,EAAsC,CAAtC,CAAb,CADmB,CAEnB;;AACA,QAAIvE,cAAc,GAAGJ,MAAM,CAACQ,EAAP,EAArB;AACA,QAAIV,cAAc,GAAG,IAAI3D,cAAJ,CACpB,IADoB,EAEpB0D,cAFoB,EAGpBO,cAHoB,EAIpBhC,MAJoB,EAKpBmG,OALoB,CAArB;AAQA,WAAO,KAAKxE,kBAAL,CAAwBD,cAAxB,CAAP;AACA,GAbD,MAaO;AACNN,WAAO,CAACyD,IAAR,CAAa,yCAAb,EAAwDsB,OAAxD;AACA,WAAO,EAAP;AACA;AACD,CAnBD;;AAqBAhB,OAAO,CAACX,SAAR,CAAkB7C,kBAAlB,GAAuC,UAASD,cAAT,EAAyB;AAC/D,MAAIQ,IAAI,GAAG,IAAX;AACA,MAAIvC,IAAI,GAAG,EAAX;;AACA,MAAI6G,gBAAgB,GAAG,UAASzD,cAAT,EAAyB;AAC/Cb,QAAI,CAACuE,iBAAL,CAAuB1D,cAAvB;;AACA,QAAI,CAACpD,IAAI,CAACoD,cAAD,CAAT,EAA2B;AAC1BpD,UAAI,CAACoD,cAAD,CAAJ,GAAuB,EAAvB;AACA;AACD,GALD;;AAOA,MAAI2D,MAAM,GAAG,IAAI1B,MAAJ,EAAb,CAV+D,CAW/D;;AACAtD,gBAAc,CAACiF,MAAf,CAAsB,YAAW;AAChC,QAAI,CAACD,MAAM,CAACE,UAAP,EAAL,EAA0B;AACzBF,YAAM,CAACG,MAAP;AACA;AACD,GAJD;;AAMAnF,gBAAc,CAACoF,WAAf;;AAEA,MAAI,CAACpF,cAAc,CAACsC,eAApB,EAAqC;AACpC;AACA;AACAtC,kBAAc,CAACb,IAAf;AACA;;AAED,MAAI,CAAC6F,MAAM,CAACE,UAAP,EAAL,EAA0B;AACzB;AACAhJ,UAAM,CAACmJ,UAAP,CAAkB,YAAW;AAC5B,UAAI,CAACL,MAAM,CAACE,UAAP,EAAL,EAA0B;AACzB;AACA;AACA;AACA;AACA,YAAI1F,OAAO,GACV,yBACAQ,cAAc,CAAC0C,KADf,GAEA,yBAFA,GAGA,0DAHA,GAIA,qCALD;AAMAhD,eAAO,CAACyD,IAAR,CAAa3D,OAAb;AACAwF,cAAM,CAACG,MAAP;AACA;AACD,KAfD,EAeG,GAfH,EAFyB,CAiBjB;AAER;;AACAH,UAAM,CAACM,IAAP;AACA,GA/C8D,CAiD/D;AACA;AACA;;;AACAtF,gBAAc,CAACb,IAAf,GApD+D,CAsD/D;;AACA7C,GAAC,CAACyB,IAAF,CAAOiC,cAAc,CAAC8B,eAAtB,EAAuC,UAASyD,QAAT,EAAmBlE,cAAnB,EAAmC;AACzE;AACAkE,YAAQ,GAAGjJ,CAAC,CAACkJ,MAAF,CAASD,QAAT,CAAX;AAEAT,oBAAgB,CAACzD,cAAD,CAAhB;AACApD,QAAI,CAACoD,cAAD,CAAJ,CAAqB1C,IAArB,CAA0B4G,QAA1B,EALyE,CAOzE;;AACA/E,QAAI,CAACsB,eAAL,CAAqBT,cAArB,EAAqC1C,IAArC,CAA0C4G,QAA1C;AACA,GATD;;AAWA,SAAOtH,IAAP;AACA,CAnED;;AAqEAwF,OAAO,CAACX,SAAR,CAAkBL,qBAAlB,GAA0C,UAASlC,IAAT,EAAejC,MAAf,EAAuB;AAChE,MAAImH,IAAI,GAAG,KAAK9B,cAAL,CAAoBpD,IAApB,CAAX;;AACA,MAAI,CAACkF,IAAL,EAAW;AACVA,QAAI,GAAG,KAAK9B,cAAL,CAAoBpD,IAApB,IAA4B,EAAnC;AACA;;AAED,MAAIjC,MAAM,IAAIA,MAAM,CAACoH,MAArB,EAA6B;AAC5B,QAAIC,SAAS,GAAGrH,MAAM,CAACA,MAAM,CAACoH,MAAP,GAAgB,CAAjB,CAAtB;;AACA,QACCC,SAAS,KACRA,SAAS,CAACC,cAAV,CAAyB,QAAzB,KACAD,SAAS,CAACC,cAAV,CAAyB,SAAzB,CAFQ,CADV,EAIE;AACDtH,YAAM,CAACuH,GAAP;AACA;AACD;;AAEDJ,MAAI,CAACtF,KAAK,CAAC2F,SAAN,CAAgBxH,MAAhB,CAAD,CAAJ,GAAgC,IAAhC;AACA,CAlBD;;AAoBAmF,OAAO,CAACX,SAAR,CAAkBiC,iBAAlB,GAAsC,UAAS1D,cAAT,EAAyB;AAC9D,MAAI,CAAC,KAAKS,eAAL,CAAqBT,cAArB,CAAL,EAA2C;AAC1C,SAAKS,eAAL,CAAqBT,cAArB,IAAuC,EAAvC;AACA;AACD,CAJD;;AAMAoC,OAAO,CAACX,SAAR,CAAkBnF,OAAlB,GAA4B,YAAW;AACtC,SAAO;AACNK,kBAAc,EAAE,KAAK8D,eADf;AAENhE,iBAAa,EAAE,KAAK6F,cAFd;AAGN9E,cAAU,EAAE,KAAK+E;AAHX,GAAP;AAKA,CAND;;AAQAxI,UAAU,CAAC4D,QAAX,GAAsByE,OAAtB,C;;;;;;;;;;;ACnKA,IAAIvH,MAAJ;AAAWhB,MAAM,CAACO,IAAP,CAAY,eAAZ,EAA4B;AAACS,QAAM,CAACR,CAAD,EAAG;AAACQ,UAAM,GAACR,CAAP;AAAS;;AAApB,CAA5B,EAAkD,CAAlD;AAAqD,IAAIN,UAAJ;AAAeF,MAAM,CAACO,IAAP,CAAY,oCAAZ,EAAiD;AAACL,YAAU,CAACM,CAAD,EAAG;AAACN,cAAU,GAACM,CAAX;AAAa;;AAA5B,CAAjD,EAA+E,CAA/E;AAAkF,IAAIU,UAAJ;AAAelB,MAAM,CAACO,IAAP,CAAY,oCAAZ,EAAiD;AAACW,YAAU,CAACV,CAAD,EAAG;AAACU,cAAU,GAACV,CAAX;AAAa;;AAA5B,CAAjD,EAA+E,CAA/E;AAAkF,IAAIqK,UAAJ;AAAe7K,MAAM,CAACO,IAAP,CAAY,sBAAZ,EAAmC;AAACsK,YAAU,CAACrK,CAAD,EAAG;AAACqK,cAAU,GAACrK,CAAX;AAAa;;AAA5B,CAAnC,EAAiE,CAAjE;;AAAoE,IAAIY,CAAJ;;AAAMpB,MAAM,CAACO,IAAP,CAAY,mBAAZ,EAAgC;AAACa,GAAC,CAACZ,CAAD,EAAG;AAACY,KAAC,GAACZ,CAAF;AAAI;;AAAV,CAAhC,EAA4C,CAA5C;AAM3V,MAAMsK,iBAAiB,GAAG9J,MAAM,CAACsI,SAAjC;;AACAtI,MAAM,CAACsI,SAAP,GAAmB,UAASjE,IAAT,EAAe,GAAG0F,IAAlB,EAAwB;AAC1C,QAAMzJ,SAAS,GAAGpB,UAAU,CAACoB,SAAX,CAAqB0J,GAArB,EAAlB;;AACA,MAAI,CAAC1J,SAAL,EAAgB;AACf,UAAM,IAAIa,KAAJ,CACJ,8BAA6BkD,IAAK,6BAD9B,CAAN;AAGA;;AACD/D,WAAS,CAACgI,SAAV,CAAoBjE,IAApB,EAA0B,GAAG0F,IAA7B;;AAEA,MAAID,iBAAJ,EAAuB;AACtBA,qBAAiB,CAACG,KAAlB,CAAwB,IAAxB,EAA8BtB,SAA9B;AACA;;AAED,SAAO;AACNuB,SAAK,EAAE,MAAM;AADP,GAAP;AAGA,CAhBD;;AAkBAhL,UAAU,CAACiL,YAAX,GAA0B,UAAS1K,GAAT,EAAc8B,SAAd,EAAyB;AAClD,MAAIC,eAAe,GAAGtB,UAAU,CAACuB,OAAX,CAAmBhC,GAAnB,EAAwB,kBAAxB,CAAtB;;AACA,MAAI,CAAC+B,eAAL,EAAsB;AACrBtB,cAAU,CAACwB,QAAX,CAAoBjC,GAApB,EAAyB,kBAAzB,EAA6C8B,SAA7C;AACA,GAFD,MAEO;AACN;AACA;AACAnB,KAAC,CAACuB,MAAF,CAASH,eAAe,CAACI,aAAzB,EAAwCL,SAAS,CAACK,aAAlD;;AACAxB,KAAC,CAACyB,IAAF,CAAON,SAAS,CAACO,cAAjB,EAAiC,UAASC,IAAT,EAAeC,OAAf,EAAwB;AACxD,UAAIC,YAAY,GAAGT,eAAe,CAACM,cAAhB,CAA+BE,OAA/B,CAAnB;;AACA,UAAIC,YAAJ,EAAkB;AACjBF,YAAI,GAAGE,YAAY,CAACC,MAAb,CAAoBH,IAApB,CAAP;AACA;;AAEDP,qBAAe,CAACM,cAAhB,CAA+BE,OAA/B,IAA0CD,IAA1C;AACA7B,gBAAU,CAACwB,QAAX,CAAoBjC,GAApB,EAAyB,kBAAzB,EAA6C+B,eAA7C;AACA,KARD;AASA;AACD,CAlBD;;AAoBAtC,UAAU,CAAC2K,UAAX,GAAwB,UAAS5I,QAAT,EAAmB;AAC1Cf,YAAU,CAACkK,YAAX,GAA0B,KAA1B;AACAP,YAAU,CAAOQ,IAAN,6BAAc;AACxB,UAAM/J,SAAS,GAAG,IAAIpB,UAAU,CAAC4D,QAAf,CACjBuH,IAAI,CAACC,OAAL,CAAa1H,OAAb,CAAqB2H,kBADJ,EAEjB;AACC1K,aAAO,EAAEwK,IAAI,CAACxK;AADf,KAFiB,CAAlB;AAOA,kBAAMX,UAAU,CAACoB,SAAX,CAAqByC,SAArB,CAA+BzC,SAA/B,EAA0C;AAAA,sCAAiB;AAChE,sBAAMW,QAAQ,CAACoJ,IAAD,CAAd;;AACAnL,kBAAU,CAACiL,YAAX,CACCE,IAAI,CAACC,OADN,EAECpL,UAAU,CAACoB,SAAX,CAAqB0J,GAArB,GAA2BvI,OAA3B,EAFD;AAIA,OAN+C;AAAA,KAA1C,CAAN;AAOA,GAfU,CAAD,CAAV;AAgBA,CAlBD,C","file":"/packages/staringatlights_fast-render.js","sourcesContent":["export const FastRender = {\n\t_routes: [],\n\t_onAllRoutes: [],\n}\n","import { RoutePolicy } from 'meteor/routepolicy'\n\n// meteor algorithm to check if this is a meteor serving http request or not\nexport const IsAppUrl = function(req) {\n\tvar url = req.url\n\tif (url === '/favicon.ico' || url === '/robots.txt') {\n\t\treturn false\n\t}\n\n\t// NOTE: app.manifest is not a web standard like favicon.ico and\n\t// robots.txt. It is a file name we have chosen to use for HTML5\n\t// appcache URLs. It is included here to prevent using an appcache\n\t// then removing it from poisoning an app permanently. Eventually,\n\t// once we have server side routing, this won't be needed as\n\t// unknown URLs with return a 404 automatically.\n\tif (url === '/app.manifest') {\n\t\treturn false\n\t}\n\n\t// Avoid serving app HTML for declared routes such as /sockjs/.\n\tif (RoutePolicy.classify(url)) {\n\t\treturn false\n\t}\n\n\t// we only need to support HTML pages only\n\t// this is a check to do it\n\treturn /html/.test(req.headers['accept'])\n}\n","import Fiber from 'fibers'\nimport { FastRender } from './namespace'\nimport { Meteor } from 'meteor/meteor'\nimport { Picker } from 'meteor/meteorhacks:picker'\nimport { InjectData } from 'meteor/staringatlights:inject-data'\nimport PublishContext from './publish_context'\nimport { IsAppUrl } from './utils'\nimport { _ } from 'meteor/underscore'\nimport connect from 'connect'\n\nFastRender._onAllRoutes = []\nFastRender.frContext = new Meteor.EnvironmentVariable()\n\nvar fastRenderRoutes = Picker.filter(function(req, res) {\n\treturn IsAppUrl(req)\n})\nfastRenderRoutes.middleware(connect.cookieParser())\nfastRenderRoutes.middleware(function(req, res, next) {\n\tFastRender.handleOnAllRoutes(req, res, next)\n})\n\n// handling specific routes\nFastRender.route = function route(path, callback) {\n\tif (path.indexOf('/') !== 0) {\n\t\tthrow new Error(\n\t\t\t'Error: path (' + path + ') must begin with a leading slash \"/\"'\n\t\t)\n\t}\n\tfastRenderRoutes.route(path, FastRender.handleRoute.bind(null, callback))\n}\n\nfunction setQueryDataCallback(req, next) {\n\treturn function(queryData) {\n\t\tif (!queryData) return next()\n\n\t\tvar existingPayload = InjectData.getData(req, 'fast-render-data')\n\t\tif (!existingPayload) {\n\t\t\tInjectData.pushData(req, 'fast-render-data', queryData)\n\t\t} else {\n\t\t\t// it's possible to execute this callback twice\n\t\t\t// the we need to merge exisitng data with the new one\n\t\t\t_.extend(existingPayload.subscriptions, queryData.subscriptions)\n\t\t\t_.each(queryData.collectionData, function(data, pubName) {\n\t\t\t\tvar existingData = existingPayload.collectionData[pubName]\n\t\t\t\tif (existingData) {\n\t\t\t\t\tdata = existingData.concat(data)\n\t\t\t\t}\n\n\t\t\t\texistingPayload.collectionData[pubName] = data\n\t\t\t\tInjectData.pushData(req, 'fast-render-data', existingPayload)\n\t\t\t})\n\t\t}\n\t\tnext()\n\t}\n}\n\nFastRender.handleRoute = function(processingCallback, params, req, res, next) {\n\tvar afterProcessed = setQueryDataCallback(req, next)\n\tFastRender._processRoutes(params, req, processingCallback, afterProcessed)\n}\n\nFastRender.handleOnAllRoutes = function(req, res, next) {\n\tvar afterProcessed = setQueryDataCallback(req, next)\n\tFastRender._processAllRoutes(req, afterProcessed)\n}\n\nFastRender.onAllRoutes = function onAllRoutes(callback) {\n\tFastRender._onAllRoutes.push(callback)\n}\n\nFastRender._processRoutes = function _processRoutes(\n\tparams,\n\treq,\n\trouteCallback,\n\tcallback\n) {\n\tcallback = callback || function() {}\n\n\tvar path = req.url\n\tvar loginToken = req.cookies['meteor_login_token']\n\tvar headers = req.headers\n\n\tvar context = new FastRender._Context(loginToken, { headers: headers })\n\n\ttry {\n\t\tFastRender.frContext.withValue(context, function() {\n\t\t\trouteCallback.call(context, params, path)\n\t\t})\n\n\t\tif (context.stop) {\n\t\t\treturn\n\t\t}\n\n\t\tcallback(context.getData())\n\t} catch (err) {\n\t\thandleError(err, path, callback)\n\t}\n}\n\nFastRender._processAllRoutes = function _processAllRoutes(req, callback) {\n\tcallback = callback || function() {}\n\n\tvar path = req.url\n\tvar loginToken = req.cookies['meteor_login_token']\n\tvar headers = req.headers\n\n\tnew Fiber(function() {\n\t\tvar context = new FastRender._Context(loginToken, { headers: headers })\n\n\t\ttry {\n\t\t\tFastRender._onAllRoutes.forEach(function(callback) {\n\t\t\t\tcallback.call(context, req.url)\n\t\t\t})\n\n\t\t\tcallback(context.getData())\n\t\t} catch (err) {\n\t\t\thandleError(err, path, callback)\n\t\t}\n\t}).run()\n}\n\nfunction handleError(err, path, callback) {\n\tvar message =\n\t\t'error on fast-rendering path: ' + path + ' ; error: ' + err.stack\n\tconsole.error(message)\n\tcallback(null)\n}\n\n// adding support for null publications\nFastRender.onAllRoutes(function() {\n\tvar context = this\n\tvar nullHandlers = Meteor.default_server.universal_publish_handlers\n\n\tif (nullHandlers) {\n\t\tnullHandlers.forEach(function(publishHandler) {\n\t\t\t// universal subs have subscription ID, params, and name undefined\n\t\t\tvar publishContext = new PublishContext(context, publishHandler)\n\t\t\tcontext.processPublication(publishContext)\n\t\t})\n\t}\n})\n","import { Random } from 'meteor/random'\nimport { EJSON } from 'meteor/ejson'\nimport { Meteor } from 'meteor/meteor'\nimport { _ } from 'meteor/underscore'\nimport { MeteorX } from 'meteor/lamhieu:meteorx'\n\nconst PublishContext = function PublishContext(\n\tcontext,\n\thandler,\n\tsubscriptionId,\n\tparams,\n\tname\n) {\n\tvar self = this\n\n\t// mock session\n\tvar sessionId = Random.id()\n\tvar session = {\n\t\tid: sessionId,\n\t\tuserId: context.userId,\n\t\t// not null\n\t\tinQueue: {},\n\t\tconnectionHandle: {\n\t\t\tid: sessionId,\n\t\t\tclose: function() {},\n\t\t\tonClose: function() {},\n\t\t\tclientAddress: '127.0.0.1',\n\t\t\thttpHeaders: context.headers,\n\t\t},\n\t\tadded: function(subscriptionHandle, collectionName, strId, fields) {\n\t\t\t// Don't share state with the data passed in by the user.\n\t\t\tvar doc = EJSON.clone(fields)\n\t\t\tdoc._id = self._idFilter.idParse(strId)\n\t\t\tMeteor._ensure(self._collectionData, collectionName)[strId] = doc\n\t\t},\n\t\tchanged: function(subscriptionHandle, collectionName, strId, fields) {\n\t\t\tvar doc = self._collectionData[collectionName][strId]\n\t\t\tif (!doc) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t'Could not find element with id ' + strId + ' to change'\n\t\t\t\t)\n\t\t\t}\n\t\t\t_.each(fields, function(value, key) {\n\t\t\t\t// Publish API ignores _id if present in fields.\n\t\t\t\tif (key === '_id') return\n\n\t\t\t\tif (value === undefined) {\n\t\t\t\t\tdelete doc[key]\n\t\t\t\t} else {\n\t\t\t\t\t// Don't share state with the data passed in by the user.\n\t\t\t\t\tdoc[key] = EJSON.clone(value)\n\t\t\t\t}\n\t\t\t})\n\t\t},\n\t\tremoved: function(subscriptionHandle, collectionName, strId) {\n\t\t\tif (\n\t\t\t\t!(\n\t\t\t\t\tself._collectionData[collectionName] &&\n\t\t\t\t\tself._collectionData[collectionName][strId]\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\tthrow new Error('Removed nonexistent document ' + strId)\n\t\t\t}\n\t\t\tdelete self._collectionData[collectionName][strId]\n\t\t},\n\t\tsendReady: function(subscriptionIds) {\n\t\t\t// this is called only for non-universal subscriptions\n\t\t\tif (!self._subscriptionId) throw new Error('Assertion.')\n\n\t\t\t// make the subscription be marked as ready\n\t\t\tif (!self._isDeactivated()) {\n\t\t\t\tself._context.completeSubscriptions(self._name, self._params)\n\t\t\t}\n\n\t\t\t// we just stop it\n\t\t\tself.stop()\n\t\t},\n\t}\n\n\tMeteorX.Subscription.call(\n\t\tself,\n\t\tsession,\n\t\thandler,\n\t\tsubscriptionId,\n\t\tparams,\n\t\tname\n\t)\n\n\tself.unblock = function() {}\n\n\tself._context = context\n\tself._collectionData = {}\n}\n\nPublishContext.prototype = Object.create(MeteorX.Subscription.prototype)\nPublishContext.prototype.constructor = PublishContext\n\nPublishContext.prototype.stop = function() {\n\t// our stop does not remove all documents (it just calls deactivate)\n\t// Meteor one removes documents for non-universal subscription\n\t// we deactivate both for universal and named subscriptions\n\t// hopefully this is right in our case\n\t// Meteor does it just for named subscriptions\n\tthis._deactivate()\n}\n\nPublishContext.prototype.error = function(error) {\n\t// TODO: Should we pass the error to the subscription somehow?\n\tconsole.warn(\n\t\t'error caught on publication: ',\n\t\tthis._name,\n\t\t': ',\n\t\terror.message || error\n\t)\n\tthis.stop()\n}\n\nexport default PublishContext\n","import { Meteor } from 'meteor/meteor'\nimport Fibers from 'fibers'\nimport Future from 'fibers/future'\nimport { Accounts } from 'meteor/accounts-base'\nimport { DDP } from 'meteor/ddp'\nimport { Random } from 'meteor/random'\nimport PublishContext from './publish_context'\nimport { _ } from 'meteor/underscore'\nimport { EJSON } from 'meteor/ejson'\nimport { FastRender } from './namespace'\n\nconst Context = function Context(loginToken, otherParams) {\n\tthis._collectionData = {}\n\tthis._subscriptions = {}\n\tthis._loginToken = loginToken\n\n\t_.extend(this, otherParams)\n\n\t// get the user\n\tif (Meteor.users) {\n\t\t// check to make sure, we've the loginToken,\n\t\t// otherwise a random user will fetched from the db\n\t\tif (loginToken) {\n\t\t\tvar hashedToken = loginToken && Accounts._hashLoginToken(loginToken)\n\t\t\tvar query = { 'services.resume.loginTokens.hashedToken': hashedToken }\n\t\t\tvar options = { fields: { _id: 1 } }\n\t\t\tvar user = Meteor.users.findOne(query, options)\n\t\t}\n\n\t\t// support for Meteor.user\n\t\tFibers.current._meteor_dynamics = []\n\t\tFibers.current._meteor_dynamics[DDP._CurrentInvocation.slot] = this\n\n\t\tif (user) {\n\t\t\tthis.userId = user._id\n\t\t}\n\t}\n}\n\nContext.prototype.subscribe = function(subName /*, params */) {\n\tvar publishHandler = Meteor.default_server.publish_handlers[subName]\n\tif (publishHandler) {\n\t\tvar params = Array.prototype.slice.call(arguments, 1)\n\t\t// non-universal subs have subscription id\n\t\tvar subscriptionId = Random.id()\n\t\tvar publishContext = new PublishContext(\n\t\t\tthis,\n\t\t\tpublishHandler,\n\t\t\tsubscriptionId,\n\t\t\tparams,\n\t\t\tsubName\n\t\t)\n\n\t\treturn this.processPublication(publishContext)\n\t} else {\n\t\tconsole.warn('There is no such publish handler named:', subName)\n\t\treturn {}\n\t}\n}\n\nContext.prototype.processPublication = function(publishContext) {\n\tvar self = this\n\tvar data = {}\n\tvar ensureCollection = function(collectionName) {\n\t\tself._ensureCollection(collectionName)\n\t\tif (!data[collectionName]) {\n\t\t\tdata[collectionName] = []\n\t\t}\n\t}\n\n\tvar future = new Future()\n\t// detect when the context is ready to be sent to the client\n\tpublishContext.onStop(function() {\n\t\tif (!future.isResolved()) {\n\t\t\tfuture.return()\n\t\t}\n\t})\n\n\tpublishContext._runHandler()\n\n\tif (!publishContext._subscriptionId) {\n\t\t// universal subscription, we stop it (same as marking it as ready) ourselves\n\t\t// they otherwise do not have ready or stopped state, but in our case they do\n\t\tpublishContext.stop()\n\t}\n\n\tif (!future.isResolved()) {\n\t\t// don't wait forever for handler to fire ready()\n\t\tMeteor.setTimeout(function() {\n\t\t\tif (!future.isResolved()) {\n\t\t\t\t// publish handler failed to send ready signal in time\n\t\t\t\t// maybe your non-universal publish handler is not calling this.ready()?\n\t\t\t\t// or maybe it is returning null to signal empty publish?\n\t\t\t\t// it should still call this.ready() or return an empty array []\n\t\t\t\tvar message =\n\t\t\t\t\t'Publish handler for ' +\n\t\t\t\t\tpublishContext._name +\n\t\t\t\t\t' sent no ready signal\\n' +\n\t\t\t\t\t' This could be because this publication `return null`.\\n' +\n\t\t\t\t\t' Use `return this.ready()` instead.'\n\t\t\t\tconsole.warn(message)\n\t\t\t\tfuture.return()\n\t\t\t}\n\t\t}, 500) // arbitrarially set timeout to 500ms, should probably be configurable\n\n\t\t//  wait for the subscription became ready.\n\t\tfuture.wait()\n\t}\n\n\t// stop any runaway subscription\n\t// this can happen if a publish handler never calls ready or stop, for example\n\t// it does not hurt to call it multiple times\n\tpublishContext.stop()\n\n\t// get the data\n\t_.each(publishContext._collectionData, function(collData, collectionName) {\n\t\t// making an array from a map\n\t\tcollData = _.values(collData)\n\n\t\tensureCollection(collectionName)\n\t\tdata[collectionName].push(collData)\n\n\t\t// copy the collection data in publish context into the FR context\n\t\tself._collectionData[collectionName].push(collData)\n\t})\n\n\treturn data\n}\n\nContext.prototype.completeSubscriptions = function(name, params) {\n\tvar subs = this._subscriptions[name]\n\tif (!subs) {\n\t\tsubs = this._subscriptions[name] = {}\n\t}\n\n\tif (params && params.length) {\n\t\tvar lastParam = params[params.length - 1]\n\t\tif (\n\t\t\tlastParam &&\n\t\t\t(lastParam.hasOwnProperty('onStop') ||\n\t\t\t\tlastParam.hasOwnProperty('onReady'))\n\t\t) {\n\t\t\tparams.pop()\n\t\t}\n\t}\n\n\tsubs[EJSON.stringify(params)] = true\n}\n\nContext.prototype._ensureCollection = function(collectionName) {\n\tif (!this._collectionData[collectionName]) {\n\t\tthis._collectionData[collectionName] = []\n\t}\n}\n\nContext.prototype.getData = function() {\n\treturn {\n\t\tcollectionData: this._collectionData,\n\t\tsubscriptions: this._subscriptions,\n\t\tloginToken: this._loginToken,\n\t}\n}\n\nFastRender._Context = Context\n","import { Meteor } from 'meteor/meteor'\nimport { FastRender } from 'meteor/staringatlights:fast-render'\nimport { InjectData } from 'meteor/staringatlights:inject-data'\nimport { onPageLoad } from 'meteor/server-render'\nimport { _ } from 'meteor/underscore'\n\nconst originalSubscribe = Meteor.subscribe\nMeteor.subscribe = function(name, ...args) {\n\tconst frContext = FastRender.frContext.get()\n\tif (!frContext) {\n\t\tthrow new Error(\n\t\t\t`Cannot add a subscription: ${name} without FastRender Context`\n\t\t)\n\t}\n\tfrContext.subscribe(name, ...args)\n\n\tif (originalSubscribe) {\n\t\toriginalSubscribe.apply(this, arguments)\n\t}\n\n\treturn {\n\t\tready: () => true,\n\t}\n}\n\nFastRender._mergeFrData = function(req, queryData) {\n\tvar existingPayload = InjectData.getData(req, 'fast-render-data')\n\tif (!existingPayload) {\n\t\tInjectData.pushData(req, 'fast-render-data', queryData)\n\t} else {\n\t\t// it's possible to execute this callback twice\n\t\t// the we need to merge exisitng data with the new one\n\t\t_.extend(existingPayload.subscriptions, queryData.subscriptions)\n\t\t_.each(queryData.collectionData, function(data, pubName) {\n\t\t\tvar existingData = existingPayload.collectionData[pubName]\n\t\t\tif (existingData) {\n\t\t\t\tdata = existingData.concat(data)\n\t\t\t}\n\n\t\t\texistingPayload.collectionData[pubName] = data\n\t\t\tInjectData.pushData(req, 'fast-render-data', existingPayload)\n\t\t})\n\t}\n}\n\nFastRender.onPageLoad = function(callback) {\n\tInjectData.injectToHead = false\n\tonPageLoad(async sink => {\n\t\tconst frContext = new FastRender._Context(\n\t\t\tsink.request.cookies.meteor_login_token,\n\t\t\t{\n\t\t\t\theaders: sink.headers,\n\t\t\t}\n\t\t)\n\n\t\tawait FastRender.frContext.withValue(frContext, async function() {\n\t\t\tawait callback(sink)\n\t\t\tFastRender._mergeFrData(\n\t\t\t\tsink.request,\n\t\t\t\tFastRender.frContext.get().getData()\n\t\t\t)\n\t\t})\n\t})\n}\n"]}