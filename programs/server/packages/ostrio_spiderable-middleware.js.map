{"version":3,"sources":["meteor://ðŸ’»app/packages/ostrio:spiderable-middleware/lib/index.js"],"names":["url","require","request","window","Error","re","proto","semi","trailingSlash","beginningSlash","nonDigit","staticExt","_debug","debug","console","trace","warn","apply","arguments","defaultOptions","module","exports","Spiderable","_opts","opts","Object","prototype","toString","call","auth","ignore","only","onlyRE","botsUA","rootURL","serviceURL","ignoredHeaders","handler","middleware","handle","headersRE","RegExp","join","botsRE","process","env","SPIDERABLE_SERVICE_AUTH","PRERENDER_SERVICE_AUTH","ROOT_URL","SPIDERABLE_SERVICE_URL","PRERENDER_SERVICE_URL","test","replace","ignoreRE","req","res","next","method","toLowerCase","urlObj","parse","query","_escaped_fragment_","headers","hasIgnored","hasOnly","pathname","i","length","reqUrl","path","uri","encodeURIComponent","wait","rawBody","usedHeaders","_headersRE","serviceReq","error","resp","statusCode","end","on","header","h","indexOf","split","trim","headersSent","includes","setHeader","push","data","write","aborted","abort","sendDate","send","e"],"mappings":"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","file":"/packages/ostrio_spiderable-middleware.js","sourcesContent":["var url     = require('url');\nvar request = require('request-libcurl');\n\nif (typeof window !== 'undefined') {\n  throw new Error('Running `spiderable-middleware` in Browser environment isn\\'t allowed! Please make sure `spiderable-middleware` NPM package is imported and used only in Node.js environment.');\n}\n\nvar re = {\n  proto: /^https?:\\/\\//i,\n  semi: /:(.+)/,\n  trailingSlash: /\\/$/,\n  beginningSlash: /^\\//,\n  nonDigit: /\\D+/g,\n  staticExt: /\\.(?:3ds|3g2|3gp|3gpp|7z|a|aac|aaf|adp|ai|aif|aiff|alz|ape|apk|appcache|ar|arj|asf|asx|atom|au|avchd|avi|bak|bbaw|bh|bin|bk|bmp|btif|bz2|bzip2|cab|caf|cco|cgm|class|cmx|cpio|cr2|crt|crx|css|csv|cur|dat|deb|der|dex|djvu|dll|dmg|dng|doc|docm|docx|dot|dotm|dra|drc|DS_Store|dsk|dts|dtshd|dvb|dwg|dxf|ear|ecelp4800|ecelp7470|ecelp9600|egg|eol|eot|eps|epub|exe|f4a|f4b|f4p|f4v|fbs|fh|fla|flac|fli|flv|fpx|fst|fvt|g3|geojson|gif|graffle|gz|gzip|h261|h263|h264|hqx|htc|ico|ief|img|ipa|iso|jad|jar|jardiff|jng|jnlp|jpeg|jpg|jpgv|jpm|js|jxr|key|kml|kmz|ktx|less|lha|lvp|lz|lzh|lzma|lzo|m2v|m3u|m4a|m4p|m4v|map|manifest|mar|markdown|md|mdi|mdown|mdwn|mht|mid|midi|mj2|mka|mkd|mkdn|mkdown|mkv|mml|mmr|mng|mobi|mov|movie|mp2|mp3|mp4|mp4a|mpe|mpeg|mpg|mpga|mpv|msi|msm|msp|mxf|mxu|nef|npx|nsv|numbers|o|oex|oga|ogg|ogv|opus|otf|pages|pbm|pcx|pdb|pdf|pea|pem|pgm|pic|pl|pm|png|pnm|pot|potm|potx|ppa|ppam|ppm|pps|ppsm|ppsx|ppt|pptm|pptx|prc|ps|psd|pya|pyc|pyo|pyv|qt|ra|rar|ras|raw|rdf|rgb|rip|rlc|rm|rmf|rmvb|ron|roq|rpm|rss|rtf|run|rz|s3m|s7z|safariextz|scpt|sea|sgi|shar|sil|sit|slk|smv|so|sub|svg|svgz|svi|swf|tar|tbz|tbz2|tcl|tga|tgz|thmx|tif|tiff|tk|tlz|topojson|torrent|ttc|ttf|txt|txz|udf|uvh|uvi|uvm|uvp|uvs|uvu|vcard|vcf|viv|vob|vtt|war|wav|wax|wbmp|wdp|weba|webapp|webm|webmanifest|webp|whl|wim|wm|wma|wml|wmlc|wmv|wmx|woff|woff2|wvx|xbm|xif|xla|xlam|xloc|xls|xlsb|xlsm|xlsx|xlt|xltm|xltx|xm|xmind|xml|xpi|xpm|xsl|xwd|xz|yuv|z|zip|zipx)(?:\\?[a-zA-Z0-9\\-\\.\\_\\~\\:\\/\\#\\[\\]\\@\\!\\$\\&\\'\\(\\)\\*\\+\\,\\;\\=]*)?$/i\n};\n\nvar _debug = function debug () {\n  console.trace();\n  console.warn.apply(null, arguments);\n};\n\nrequest.defaultOptions.debug = false;\n\nmodule.exports = (function () {\n  function Spiderable(_opts) {\n    var opts = {};\n    if (_opts && Object.prototype.toString.call(_opts) === '[object Object]') {\n      opts = _opts;\n    }\n\n    this.auth       = opts.auth;\n    var ignore      = opts.ignore || false;\n    this.only       = opts.only || false;\n    this.onlyRE     = opts.onlyRE || false;\n    this.botsUA     = opts.botsUA || Spiderable.prototype.botsUA;\n    this.rootURL    = opts.rootURL;\n    this.staticExt  = opts.staticExt || re.staticExt;\n    this.serviceURL = opts.serviceURL;\n    this.ignoredHeaders = opts.ignoredHeaders || Spiderable.prototype.ignoredHeaders;\n\n    if (Object.prototype.toString.call(this.staticExt) !== '[object RegExp]') {\n      _debug('[Spiderable-Middleware] `opts.staticExt` must be instance of RegExp, falling back to defaults.');\n      this.staticExt = re.staticExt;\n    }\n\n    if (this.onlyRE && Object.prototype.toString.call(this.onlyRE) !== '[object RegExp]') {\n      _debug('[Spiderable-Middleware] `opts.onlyRE` must be instance of RegExp, rules are ignored!');\n      this.onlyRE = false;\n    }\n\n    if (Object.prototype.toString.call(this.botsUA) !== '[object Array]') {\n      _debug('[Spiderable-Middleware] `opts.botsUA` must be instance of Array, falling back to defaults.');\n      this.botsUA = this.prototype.botsUA;\n    }\n\n    if (Object.prototype.toString.call(this.ignoredHeaders) !== '[object Array]') {\n      _debug('[Spiderable-Middleware] `opts.ignoredHeaders` must be instance of Array, falling back to defaults.');\n      this.ignoredHeaders = this.prototype.ignoredHeaders;\n    }\n\n    if (this.only && Object.prototype.toString.call(this.only) !== '[object Array]') {\n      _debug('[Spiderable-Middleware] `opts.only` must be instance of Array, rules are ignored!');\n      this.only = false;\n    }\n\n    if (!this.handler) {\n      this.handler = this.middleware;\n    }\n\n    if (!this.handle) {\n      this.handle = this.middleware;\n    }\n\n    this.headersRE = new RegExp(this.ignoredHeaders.join('|'), 'i');\n    this.botsRE = new RegExp(this.botsUA.join('|'), 'i');\n    if (!this.auth) {\n      this.auth = process.env.SPIDERABLE_SERVICE_AUTH || process.env.PRERENDER_SERVICE_AUTH || '';\n    }\n\n    if (ignore && Object.prototype.toString.call(ignore) !== '[object Array]') {\n      _debug('[Spiderable-Middleware] `opts.ignore` must be instance of Array, rules are ignored!');\n      ignore = false;\n    }\n\n    if (!this.rootURL) {\n      this.rootURL = process.env.ROOT_URL;\n    }\n\n    if (!this.serviceURL) {\n      this.serviceURL = process.env.SPIDERABLE_SERVICE_URL || process.env.PRERENDER_SERVICE_URL || 'https://render.ostr.io';\n    }\n\n    if (!this.rootURL) {\n      throw new Error('[Spiderable-Middleware] {rootURL} or env variable ROOT_URL is not detected! But must be specified!');\n    }\n\n    if (!this.serviceURL) {\n      throw new Error('[Spiderable-Middleware] {serviceURL} or env variable SPIDERABLE_SERVICE_URL or PRERENDER_SERVICE_URL is not detected! But must be specified!');\n    }\n\n    if (!re.proto.test(this.rootURL)) {\n      throw new Error('[Spiderable-Middleware] {rootURL} is malformed! Must start with protocol http or https');\n    }\n\n    if (!re.proto.test(this.serviceURL)) {\n      throw new Error('[Spiderable-Middleware] {serviceURL} is malformed! Must start with protocol http or https');\n    }\n\n    this.rootURL    = this.rootURL.replace(re.trailingSlash, '').replace(re.beginningSlash, '');\n    this.serviceURL = this.serviceURL.replace(re.trailingSlash, '').replace(re.beginningSlash, '');\n\n    if (ignore) {\n      this.ignoreRE = new RegExp(ignore.join('|'), '');\n    } else {\n      this.ignoreRE = false;\n    }\n  }\n\n  Spiderable.prototype.botsUA = ['\\\\.net crawler', '360spider', '50\\\\.nu', '8bo crawler bot', 'aboundex', 'accoona', 'adldxbot', 'adsbot-google', 'ahrefsbot', 'altavista', 'appengine-google', 'applebot', 'archiver', 'arielisbot', 'ask jeeves', 'auskunftbot', 'baidumobaider', 'baiduspider', 'becomebot', 'bingbot', 'bingpreview', 'bitbot', 'bitlybot', 'blitzbot', 'blogbridge', 'boardreader', 'botseer', 'catchbot', 'catchpoint bot', 'charlotte', 'checklinks', 'cliqzbot', 'clumboot', 'coccocbot', 'converacrawler', 'crawl-e', 'crawlconvera', 'dataparksearch', 'daum', 'deusu', 'developers\\\\.google\\\\.com/+/web/snippet', 'discordbot', 'dotbot', 'duckduckbot', 'elefent', 'embedly', 'evernote', 'exabot', 'facebookbot', 'facebookexternalhit', 'fatbot', 'fdse robot', 'feed seeker bot', 'feedfetcher', 'femtosearchbot', 'findlinks', 'flamingo_searchengine', 'flipboard', 'followsite bot', 'furlbot', 'fyberspider', 'gaisbot', 'galaxybot', 'geniebot', 'genieo', 'gigablast', 'gigabot', 'girafabot', 'gomezagent', 'gonzo1', 'google sketchup', 'google-structured-data-testing-tool', 'googlebot', 'haosouspider', 'heritrix', 'holmes', 'hoowwwer', 'htdig', 'ia_archiver', 'idbot', 'infuzapp', 'innovazion crawler', 'instagram', 'internetarchive', 'iqdb', 'iskanie', 'istellabot', 'izsearch\\\\.com', 'kaloogabot', 'kaz\\\\.kz_bot', 'kd bot', 'konqueror', 'kraken', 'kurzor', 'larbin', 'leia', 'lesnikbot', 'linguee bot', 'linkaider', 'linkapediabot', 'linkedinbot', 'lite bot', 'llaut', 'lookseek', 'lycos', 'mail\\\\.ru_bot', 'masidani_bot', 'masscan', 'mediapartners-google', 'metajobbot', 'mj12bot', 'mnogosearch', 'mogimogi', 'mojeekbot', 'motominerbot', 'mozdex', 'msiecrawler', 'msnbot', 'msrbot', 'netpursual', 'netresearch', 'netvibes', 'newsgator', 'ng-search', 'nicebot', 'nutchcvs', 'nuzzel', 'nymesis', 'objectssearch', 'odklbot', 'omgili', 'oovoo', 'oozbot', 'openfosbot', 'orangebot', 'orbiter', 'org_bot', 'outbrain', 'pagepeeker', 'pagesinventory', 'parsijoobot', 'paxleframework', 'peeplo screenshot bot', 'pinterest', 'plantynet_webrobot', 'plukkie', 'pompos', 'psbot', 'quora link preview', 'qwantify', 'read%20later', 'reaper', 'redcarpet', 'redditbot', 'retreiver', 'riddler', 'rival iq', 'rogerbot', 'saucenao', 'scooter', 'scrapy', 'scrubby', 'searchie', 'searchsight', 'seekbot', 'semanticdiscovery', 'seznambot', 'showyoubot', 'simplepie', 'simpy', 'sitelockspider', 'skypeuripreview', 'slack-imgproxy', 'slackbot', 'slurp', 'snappy', 'sogou', 'solofield', 'speedy spider', 'speedyspider', 'sputnikbot', 'stackrambler', 'teeraidbot', 'teoma', 'theusefulbot', 'thumbshots\\\\.ru', 'thumbshotsbot', 'tineye', 'toweya\\\\.com', 'toweyabot', 'tumblr', 'tweetedtimes', 'tweetmemebot', 'twitterbot', 'url2png', 'vagabondo', 'vebidoobot', 'viber', 'visionutils', 'vkshare', 'voilabot', 'vortex', 'votay bot', 'voyager', 'w3c_validator', 'wasalive\\\\.bot', 'web-sniffer', 'websquash\\\\.com', 'webthumb', 'whatsapp', 'whatweb', 'wire', 'wotbox', 'yacybot', 'yahoo', 'yandex', 'yeti', 'yisouspider', 'yodaobot', 'yooglifetchagent', 'yoozbot', 'yottaamonitor', 'yowedo', 'zao-crawler', 'zebot_www\\\\.ze\\\\.bz', 'zooshot', 'zyborg'];\n\n  Spiderable.prototype.ignoredHeaders = ['age', 'alt-svc', 'cache-status', 'cf-cache-status', 'cf-connecting-ip', 'cf-ipcountry', 'cf-ray', 'cnection', 'cneonction', 'connection', 'content-encoding', 'content-length', 'date', 'etag', 'expect-ct', 'expires', 'keep-alive', 'last-modified', 'link', 'nncoection', 'pragma', 'server', 'set-cookie', 'status', 'transfer-encoding', 'vary', 'via', 'www-authenticate', 'x-accel-buffering', 'x-accel-charset', 'x-accel-expires', 'x-accel-limit-rate', 'x-accel-redirect', 'x-ostrio-domain', 'x-powered-by', 'x-preprender-status', 'x-prerender-status', 'x-real-ip', 'x-runtime'];\n\n  Spiderable.prototype.middleware = function (req, res, next) {\n    if (req.method.toLowerCase() !== 'get' && req.method.toLowerCase() !== 'head') {\n      return next();\n    }\n\n    var urlObj = url.parse(req.url, true);\n    if (urlObj.query._escaped_fragment_ !== void 0 || this.botsRE.test(req.headers['user-agent'] || '')) {\n      var hasIgnored = false;\n      var hasOnly    = false;\n\n      if (this.staticExt.test(urlObj.pathname)) {\n        return next();\n      }\n\n      if (this.onlyRE) {\n        hasOnly    = this.onlyRE.test(urlObj.pathname);\n        hasIgnored = !hasOnly;\n      }\n\n      if (!hasOnly && this.only) {\n        hasIgnored = true;\n\n        for (var i = 0; i < this.only.length; i++) {\n          if (Object.prototype.toString.call(this.only[i]) === '[object String]') {\n            if (this.only[i] === urlObj.pathname) {\n              hasIgnored = false;\n              hasOnly    = true;\n              break;\n            }\n          } else if (Object.prototype.toString.call(this.only[i]) === '[object RegExp]') {\n            if (this.only[i].test(urlObj.pathname)) {\n              hasIgnored = false;\n              hasOnly    = true;\n              break;\n            }\n          } else {\n            _debug('[Spiderable-Middleware] `opts.only` {' + this.only[i] + '} rule isn\\'t instance of {String} nor {RegExp}, rule ignored!');\n          }\n        }\n      }\n\n      if (this.ignoreRE && this.ignoreRE.test(urlObj.pathname)) {\n        hasIgnored = true;\n      }\n\n      if (hasIgnored) {\n        return next();\n      }\n\n      var reqUrl = this.rootURL;\n\n      urlObj.path = urlObj.path.replace(re.trailingSlash, '').replace(re.beginningSlash, '');\n      if (urlObj.query._escaped_fragment_ !== void 0 && urlObj.query._escaped_fragment_.length) {\n        urlObj.pathname += '/' + urlObj.query._escaped_fragment_.replace(re.beginningSlash, '');\n      }\n\n      reqUrl += '/' + urlObj.pathname;\n      reqUrl  = reqUrl.replace(/([^:]\\/)\\/+/g, '$1');\n\n      var opts  = {\n        uri: (this.serviceURL + '/?url=' + encodeURIComponent(reqUrl)).replace(/([^:]\\/)\\/+/g, '$1'),\n        wait: true,\n        auth: this.auth || false,\n        headers: {\n          'User-Agent': 'spiderable-middleware/1.4.2'\n        },\n        rawBody: true\n      };\n\n      try {\n        var usedHeaders = [];\n        var _headersRE  = this.headersRE;\n        var serviceReq  = request(opts, function (error, resp) {\n          if (error) {\n            _debug('[Spiderable-Middleware] [request.get] Error while connecting to external service:', error);\n            next();\n          } else {\n            if (resp.statusCode === 401 || resp.statusCode === 403) {\n              _debug('[Spiderable-Middleware] Can\\'t authenticate! Please check you \"auth\" parameter and other settings.');\n            }\n            res.statusCode = resp.statusCode || 200;\n            res.end();\n          }\n        });\n\n        serviceReq.request.on('header', function (header) {\n          var h = header.toString('utf8');\n          if (!!~h.indexOf(':')) {\n            h = h.split(re.semi);\n            h[0] = h[0].trim().toLowerCase();\n            h[1] = h[1].replace(/\\r|\\n/, '').trim();\n\n            if (!res.headersSent && h[1].length && !_headersRE.test(h[0]) && !usedHeaders.includes(h[0])) {\n              res.setHeader(h[0], h[1]);\n              usedHeaders.push(h[0]);\n            }\n          }\n        });\n\n        serviceReq.request.on('data', function (data) {\n          res.write(data.toString('utf8'), 'utf8');\n        });\n\n        req.on('aborted', function () {\n          _debug('[Spiderable-Middleware] [REQ] [\"aborted\" event]:', arguments);\n          req.aborted = true;\n          serviceReq.abort();\n          res.end();\n        });\n\n        req.on('error', function (error) {\n          _debug('[Spiderable-Middleware] [REQ] [\"error\" event] Unexpected error:', error);\n          serviceReq.abort();\n          next();\n        });\n\n        res.on('error', function (error) {\n          _debug('[Spiderable-Middleware] [RES] [\"error\" event] Unexpected error:', error);\n          serviceReq.abort();\n          next();\n        });\n\n        res.on('close', function () {\n          _debug('[Spiderable-Middleware] [RES] [\"close\" event]:', arguments);\n          serviceReq.abort();\n          next();\n        });\n\n        res.sendDate = false;\n        serviceReq.send();\n      } catch (e) {\n        _debug('[Spiderable-Middleware] Exception while connecting to external service:', e);\n        next();\n      }\n      return true;\n    }\n    return next();\n  };\n\n  return Spiderable;\n})();\n"]}