{"version":3,"sources":["meteor://ðŸ’»app/packages/ostrio:files/server.js","meteor://ðŸ’»app/packages/ostrio:files/core.js","meteor://ðŸ’»app/packages/ostrio:files/cursor.js","meteor://ðŸ’»app/packages/ostrio:files/lib.js","meteor://ðŸ’»app/packages/ostrio:files/write-stream.js"],"names":["module","export","FilesCollection","_","watch","require","v","Mongo","WebApp","Meteor","Random","Cookies","WriteStream","default","check","Match","FilesCollectionCore","fixJSONParse","fixJSONStringify","fs","nodeQs","request","fileType","nodePath","bound","bindEnvironment","callback","NOOP","constructor","config","storagePath","debug","schema","public","strict","chunkSize","protected","collection","permissions","cacheControl","downloadRoute","onAfterUpload","onAfterRemove","disableUpload","onBeforeRemove","integrityCheck","collectionName","onBeforeUpload","namingFunction","responseHeaders","disableDownload","allowClientCode","downloadCallback","onInitiateUpload","interceptDownload","continueUploadTTL","parentDirPermissions","self","cookie","isBoolean","Math","floor","isString","Collection","_name","filesCollection","String","Error","replace","isFunction","isNumber","parseInt","isObject","_currentUploads","responseCode","fileRef","versionRef","headers","Pragma","Trailer","size","Connection","type","sep","sp","apply","arguments","normalize","_debug","mkdirs","mode","error","Boolean","Number","Function","OneOf","Object","_preCollection","_ensureIndex","createdAt","expireAfterSeconds","background","_preCollectionCursor","find","fields","_id","isFinished","observe","changed","doc","remove","removed","stop","end","abort","_createStream","path","opts","fileLength","_continueUpload","file","aborted","ended","contUpld","findOne","name","isVideo","isAudio","isImage","isText","isJSON","isPDF","extension","optional","_storagePath","_downloadRoute","_collectionName","meta","blackbox","userId","updatedAt","Date","versions","_checkAccess","http","result","user","_getUser","params","call","extend","rc","text","response","headersSent","writeHead","length","finished","_methodNames","_Abort","_Write","_Start","_Remove","on","_handleUpload","_finishUpload","connectHandlers","use","httpReq","httpResp","next","_parsedUrl","indexOf","method","handleError","console","warn","JSON","stringify","body","data","server","sessions","has","fileId","eof","Buffer","from","binData","buffErr","chunkId","_prepareUpload","emit","parse","jsonErr","___s","clone","maxLength","insert","omit","returnMeta","uploadRoute","httpRespErr","uri","uris","substring","split","query","version","download","_file","_methods","selector","userFuncs","users","cursor","count","FSName","Optional","unblock","wrapAsync","bind","handleUploadErr","unlink","methods","transport","ctx","fileName","_getFileName","extensionWithDot","_getExt","ext","_dataToSchema","isUploadAllowed","cb","chmod","_getMimeType","_updateFileTypes","update","$set","write","e","fileData","mime","buf","fd","openSync","br","readSync","close","slice","mtok","get","buffer","proceedAfterUpload","id","stream","createWriteStream","flags","streamErr","insertErr","load","url","pathParts","storeResult","stat","stats","original","pipe","addFile","statErr","isFile","undefined","files","forEach","docs","fetch","deny","rules","allow","denyClient","allowClient","each","vRef","_404","originalUrl","responseType","serve","readableStream","force200","partiral","reqRange","dispositionType","start","take","dispositionName","encodeURI","dispositionEncoding","setHeader","range","array","isNaN","play","streamErrorHandler","toString","key","createReadStream","EventEmitter","formatFleURL","FilesCursor","FileCursor","info","log","pop","toLowerCase","test","ds","options","link","_fileRef","_collection","assign","property","with","_selector","_current","hasNext","hasPrevious","previous","first","last","context","map","current","callbacks","observeChanges","obj","isArray","i","isDate","_root","__meteor_runtime_config__","ROOT_URL","fdCache","writtenChunks","ensureFile","efError","open","oError","num","chunk","written","setTimeout","ceil"],"mappings":"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","file":"/packages/ostrio_files.js","sourcesContent":["import { _ }                              from 'meteor/underscore';\nimport { Mongo }                          from 'meteor/mongo';\nimport { WebApp }                         from 'meteor/webapp';\nimport { Meteor }                         from 'meteor/meteor';\nimport { Random }                         from 'meteor/random';\nimport { Cookies }                        from 'meteor/ostrio:cookies';\nimport WriteStream                        from './write-stream.js';\nimport { check, Match }                   from 'meteor/check';\nimport FilesCollectionCore                from './core.js';\nimport { fixJSONParse, fixJSONStringify } from './lib.js';\n\nimport fs       from 'fs-extra';\nimport nodeQs   from 'querystring';\nimport request  from 'request';\nimport fileType from 'file-type';\nimport nodePath from 'path';\n\n/*\n * @const {Object} bound  - Meteor.bindEnvironment (Fiber wrapper)\n * @const {Function} NOOP - No Operation function, placeholder for required callbacks\n */\nconst bound = Meteor.bindEnvironment(callback => callback());\nconst NOOP  = () => {  };\n\n/*\n * @locus Anywhere\n * @class FilesCollection\n * @param config           {Object}   - [Both]   Configuration object with next properties:\n * @param config.debug     {Boolean}  - [Both]   Turn on/of debugging and extra logging\n * @param config.schema    {Object}   - [Both]   Collection Schema\n * @param config.public    {Boolean}  - [Both]   Store files in folder accessible for proxy servers, for limits, and more - read docs\n * @param config.strict    {Boolean}  - [Server] Strict mode for partial content, if is `true` server will return `416` response code, when `range` is not specified, otherwise server return `206`\n * @param config.protected {Function} - [Server] If `true` - files will be served only to authorized users, if `function()` - you're able to check visitor's permissions in your own way function's context has:\n *  - `request`\n *  - `response`\n *  - `user()`\n *  - `userId`\n * @param config.chunkSize      {Number}  - [Both] Upload chunk size, default: 524288 bytes (0,5 Mb)\n * @param config.permissions    {Number}  - [Server] Permissions which will be set to uploaded files (octal), like: `511` or `0o755`. Default: 0644\n * @param config.parentDirPermissions {Number}  - [Server] Permissions which will be set to parent directory of uploaded files (octal), like: `611` or `0o777`. Default: 0755\n * @param config.storagePath    {String|Function}  - [Server] Storage path on file system\n * @param config.cacheControl   {String}  - [Server] Default `Cache-Control` header\n * @param config.responseHeaders {Object|Function} - [Server] Custom response headers, if function is passed, must return Object\n * @param config.throttle       {Number}  - [Server] DEPRECATED bps throttle threshold\n * @param config.downloadRoute  {String}  - [Both]   Server Route used to retrieve files\n * @param config.collection     {Mongo.Collection} - [Both] Mongo Collection Instance\n * @param config.collectionName {String}  - [Both]   Collection name\n * @param config.namingFunction {Function}- [Both]   Function which returns `String`\n * @param config.integrityCheck {Boolean} - [Server] Check file's integrity before serving to users\n * @param config.onAfterUpload  {Function}- [Server] Called right after file is ready on FS. Use to transfer file somewhere else, or do other thing with file directly\n * @param config.onAfterRemove  {Function} - [Server] Called right after file is removed. Removed objects is passed to callback\n * @param config.continueUploadTTL {Number} - [Server] Time in seconds, during upload may be continued, default 3 hours (10800 seconds)\n * @param config.onBeforeUpload {Function}- [Both]   Function which executes on server after receiving each chunk and on client right before beginning upload. Function context is `File` - so you are able to check for extension, mime-type, size and etc.:\n *  - return `true` to continue\n *  - return `false` or `String` to abort upload\n * @param config.onInitiateUpload {Function} - [Server] Function which executes on server right before upload is begin and right after `onBeforeUpload` hook. This hook is fully asynchronous.\n * @param config.onBeforeRemove {Function} - [Server] Executes before removing file on server, so you can check permissions. Return `true` to allow action and `false` to deny.\n * @param config.allowClientCode  {Boolean}  - [Both]   Allow to run `remove` from client\n * @param config.downloadCallback {Function} - [Server] Callback triggered each time file is requested, return truthy value to continue download, or falsy to abort\n * @param config.interceptDownload {Function} - [Server] Intercept download request, so you can serve file from third-party resource, arguments {http: {request: {...}, response: {...}}, fileRef: {...}}\n * @param config.disableUpload {Boolean} - Disable file upload, useful for server only solutions\n * @param config.disableDownload {Boolean} - Disable file download (serving), useful for file management only solutions\n * @summary Create new instance of FilesCollection\n */\nexport class FilesCollection extends FilesCollectionCore {\n  constructor(config) {\n    super();\n    let storagePath;\n    if (config) {\n      ({\n        storagePath,\n        debug: this.debug,\n        schema: this.schema,\n        public: this.public,\n        strict: this.strict,\n        chunkSize: this.chunkSize,\n        protected: this.protected,\n        collection: this.collection,\n        permissions: this.permissions,\n        cacheControl: this.cacheControl,\n        downloadRoute: this.downloadRoute,\n        onAfterUpload: this.onAfterUpload,\n        onAfterRemove: this.onAfterRemove,\n        disableUpload: this.disableUpload,\n        onBeforeRemove: this.onBeforeRemove,\n        integrityCheck: this.integrityCheck,\n        collectionName: this.collectionName,\n        onBeforeUpload: this.onBeforeUpload,\n        namingFunction: this.namingFunction,\n        responseHeaders: this.responseHeaders,\n        disableDownload: this.disableDownload,\n        allowClientCode: this.allowClientCode,\n        downloadCallback: this.downloadCallback,\n        onInitiateUpload: this.onInitiateUpload,\n        interceptDownload: this.interceptDownload,\n        continueUploadTTL: this.continueUploadTTL,\n        parentDirPermissions: this.parentDirPermissions\n      } = config);\n    }\n\n    const self   = this;\n    const cookie = new Cookies();\n\n    if (!_.isBoolean(this.debug)) {\n      this.debug = false;\n    }\n\n    if (!_.isBoolean(this.public)) {\n      this.public = false;\n    }\n\n    if (!this.protected) {\n      this.protected = false;\n    }\n\n    if (!this.chunkSize) {\n      this.chunkSize = 1024 * 512;\n    }\n\n    this.chunkSize = Math.floor(this.chunkSize / 8) * 8;\n\n    if (!_.isString(this.collectionName) && !this.collection) {\n      this.collectionName = 'MeteorUploadFiles';\n    }\n\n    if (!this.collection) {\n      this.collection = new Mongo.Collection(this.collectionName);\n    } else {\n      this.collectionName = this.collection._name;\n    }\n\n    this.collection.filesCollection = this;\n    check(this.collectionName, String);\n\n    if (this.public && !this.downloadRoute) {\n      throw new Meteor.Error(500, `[FilesCollection.${this.collectionName}]: \\\"downloadRoute\\\" must be precisely provided on \\\"public\\\" collections! Note: \\\"downloadRoute\\\" must be equal or be inside of your web/proxy-server (relative) root.`);\n    }\n\n    if (!_.isString(this.downloadRoute)) {\n      this.downloadRoute = '/cdn/storage';\n    }\n\n    this.downloadRoute = this.downloadRoute.replace(/\\/$/, '');\n\n    if (!_.isFunction(this.namingFunction)) {\n      this.namingFunction = false;\n    }\n\n    if (!_.isFunction(this.onBeforeUpload)) {\n      this.onBeforeUpload = false;\n    }\n\n    if (!_.isBoolean(this.allowClientCode)) {\n      this.allowClientCode = true;\n    }\n\n    if (!_.isFunction(this.onInitiateUpload)) {\n      this.onInitiateUpload = false;\n    }\n\n    if (!_.isFunction(this.interceptDownload)) {\n      this.interceptDownload = false;\n    }\n\n    if (!_.isBoolean(this.strict)) {\n      this.strict = true;\n    }\n\n    if (!_.isNumber(this.permissions)) {\n      this.permissions = parseInt('644', 8);\n    }\n\n    if (!_.isNumber(this.parentDirPermissions)) {\n      this.parentDirPermissions = parseInt('755', 8);\n    }\n\n    if (!_.isString(this.cacheControl)) {\n      this.cacheControl = 'public, max-age=31536000, s-maxage=31536000';\n    }\n\n    if (!_.isFunction(this.onAfterUpload)) {\n      this.onAfterUpload = false;\n    }\n\n    if (!_.isBoolean(this.disableUpload)) {\n      this.disableUpload = false;\n    }\n\n    if (!_.isFunction(this.onAfterRemove)) {\n      this.onAfterRemove = false;\n    }\n\n    if (!_.isFunction(this.onBeforeRemove)) {\n      this.onBeforeRemove = false;\n    }\n\n    if (!_.isBoolean(this.integrityCheck)) {\n      this.integrityCheck = true;\n    }\n\n    if (!_.isBoolean(this.disableDownload)) {\n      this.disableDownload = false;\n    }\n\n    if (!_.isObject(this._currentUploads)) {\n      this._currentUploads = {};\n    }\n\n    if (!_.isFunction(this.downloadCallback)) {\n      this.downloadCallback = false;\n    }\n\n    if (!_.isNumber(this.continueUploadTTL)) {\n      this.continueUploadTTL = 10800;\n    }\n\n    if (!_.isFunction(this.responseHeaders)) {\n      this.responseHeaders = (responseCode, fileRef, versionRef) => {\n        const headers = {};\n\n        switch (responseCode) {\n        case '206':\n          headers.Pragma               = 'private';\n          headers.Trailer              = 'expires';\n          headers['Transfer-Encoding'] = 'chunked';\n          break;\n        case '400':\n          headers['Cache-Control']     = 'no-cache';\n          break;\n        case '416':\n          headers['Content-Range']     = `bytes */${versionRef.size}`;\n          break;\n        default:\n          break;\n        }\n\n        headers.Connection       = 'keep-alive';\n        headers['Content-Type']  = versionRef.type || 'application/octet-stream';\n        headers['Accept-Ranges'] = 'bytes';\n        return headers;\n      };\n    }\n\n    if (this.public && !storagePath) {\n      throw new Meteor.Error(500, `[FilesCollection.${this.collectionName}] \\\"storagePath\\\" must be set on \\\"public\\\" collections! Note: \\\"storagePath\\\" must be equal on be inside of your web/proxy-server (absolute) root.`);\n    }\n\n    if (!storagePath) {\n      storagePath = function () {\n        return `assets${nodePath.sep}app${nodePath.sep}uploads${nodePath.sep}${self.collectionName}`;\n      };\n    }\n\n    if (_.isString(storagePath)) {\n      this.storagePath = () => storagePath;\n    } else {\n      this.storagePath = function () {\n        let sp = storagePath.apply(self, arguments);\n        if (!_.isString(sp)) {\n          throw new Meteor.Error(400, `[FilesCollection.${self.collectionName}] \\\"storagePath\\\" function must return a String!`);\n        }\n        sp = sp.replace(/\\/$/, '');\n        return nodePath.normalize(sp);\n      };\n    }\n\n    this._debug('[FilesCollection.storagePath] Set to:', this.storagePath({}));\n\n    fs.mkdirs(this.storagePath({}), { mode: this.parentDirPermissions }, (error) => {\n      if (error) {\n        throw new Meteor.Error(401, `[FilesCollection.${self.collectionName}] Path \\\"${this.storagePath({})}\\\" is not writable!`, error);\n      }\n    });\n\n    check(this.strict, Boolean);\n    check(this.permissions, Number);\n    check(this.storagePath, Function);\n    check(this.cacheControl, String);\n    check(this.onAfterRemove, Match.OneOf(false, Function));\n    check(this.onAfterUpload, Match.OneOf(false, Function));\n    check(this.disableUpload, Boolean);\n    check(this.integrityCheck, Boolean);\n    check(this.onBeforeRemove, Match.OneOf(false, Function));\n    check(this.disableDownload, Boolean);\n    check(this.downloadCallback, Match.OneOf(false, Function));\n    check(this.interceptDownload, Match.OneOf(false, Function));\n    check(this.continueUploadTTL, Number);\n    check(this.responseHeaders, Match.OneOf(Object, Function));\n\n    if (!this.disableUpload) {\n      this._preCollection = new Mongo.Collection(`__pre_${this.collectionName}`);\n      this._preCollection._ensureIndex({createdAt: 1}, {expireAfterSeconds: this.continueUploadTTL, background: true});\n      const _preCollectionCursor = this._preCollection.find({}, {\n        fields: {\n          _id: 1,\n          isFinished: 1\n        }\n      });\n\n      _preCollectionCursor.observe({\n        changed(doc) {\n          if (doc.isFinished) {\n            self._debug(`[FilesCollection] [_preCollectionCursor.observe] [changed]: ${doc._id}`);\n            self._preCollection.remove({_id: doc._id}, NOOP);\n          }\n        },\n        removed(doc) {\n          // Free memory after upload is done\n          // Or if upload is unfinished\n          self._debug(`[FilesCollection] [_preCollectionCursor.observe] [removed]: ${doc._id}`);\n          if (_.isObject(self._currentUploads[doc._id])) {\n            self._currentUploads[doc._id].stop();\n            self._currentUploads[doc._id].end();\n\n            if (!doc.isFinished) {\n              self._debug(`[FilesCollection] [_preCollectionCursor.observe] [removeUnfinishedUpload]: ${doc._id}`);\n              self._currentUploads[doc._id].abort();\n            }\n\n            delete self._currentUploads[doc._id];\n          }\n        }\n      });\n\n      this._createStream = (_id, path, opts) => {\n        this._currentUploads[_id] = new WriteStream(path, opts.fileLength, opts, this.permissions);\n      };\n\n      // This little function allows to continue upload\n      // even after server is restarted (*not on dev-stage*)\n      this._continueUpload = (_id) => {\n        if (this._currentUploads[_id] && this._currentUploads[_id].file) {\n          if (!this._currentUploads[_id].aborted && !this._currentUploads[_id].ended) {\n            return this._currentUploads[_id].file;\n          }\n          this._createStream(_id, this._currentUploads[_id].file.file.path, this._currentUploads[_id].file);\n          return this._currentUploads[_id].file;\n        }\n        const contUpld = this._preCollection.findOne({_id});\n        if (contUpld) {\n          this._createStream(_id, contUpld.file.path, contUpld);\n          return this._currentUploads[_id].file;\n        }\n        return false;\n      };\n    }\n\n    if (!this.schema) {\n      this.schema = {\n        size: {\n          type: Number\n        },\n        name: {\n          type: String\n        },\n        type: {\n          type: String\n        },\n        path: {\n          type: String\n        },\n        isVideo: {\n          type: Boolean\n        },\n        isAudio: {\n          type: Boolean\n        },\n        isImage: {\n          type: Boolean\n        },\n        isText: {\n          type: Boolean\n        },\n        isJSON: {\n          type: Boolean\n        },\n        isPDF: {\n          type: Boolean\n        },\n        extension: {\n          type: String,\n          optional: true\n        },\n        _storagePath: {\n          type: String\n        },\n        _downloadRoute: {\n          type: String\n        },\n        _collectionName: {\n          type: String\n        },\n        public: {\n          type: Boolean,\n          optional: true\n        },\n        meta: {\n          type: Object,\n          blackbox: true,\n          optional: true\n        },\n        userId: {\n          type: String,\n          optional: true\n        },\n        updatedAt: {\n          type: Date,\n          optional: true\n        },\n        versions: {\n          type: Object,\n          blackbox: true\n        }\n      };\n    }\n\n    check(this.debug, Boolean);\n    check(this.schema, Object);\n    check(this.public, Boolean);\n    check(this.protected, Match.OneOf(Boolean, Function));\n    check(this.chunkSize, Number);\n    check(this.downloadRoute, String);\n    check(this.namingFunction, Match.OneOf(false, Function));\n    check(this.onBeforeUpload, Match.OneOf(false, Function));\n    check(this.onInitiateUpload, Match.OneOf(false, Function));\n    check(this.allowClientCode, Boolean);\n\n    if (this.public && this.protected) {\n      throw new Meteor.Error(500, `[FilesCollection.${this.collectionName}]: Files can not be public and protected at the same time!`);\n    }\n\n    this._checkAccess = (http) => {\n      if (this.protected) {\n        let result;\n        const {user, userId} = this._getUser(http);\n\n        if (_.isFunction(this.protected)) {\n          let fileRef;\n          if (_.isObject(http.params) &&  http.params._id) {\n            fileRef = this.collection.findOne(http.params._id);\n          }\n\n          result = http ? this.protected.call(_.extend(http, {user, userId}), (fileRef || null)) : this.protected.call({user, userId}, (fileRef || null));\n        } else {\n          result = !!userId;\n        }\n\n        if ((http && (result === true)) || !http) {\n          return true;\n        }\n\n        const rc = _.isNumber(result) ? result : 401;\n        this._debug('[FilesCollection._checkAccess] WARN: Access denied!');\n        if (http) {\n          const text = 'Access denied!';\n          if (!http.response.headersSent) {\n            http.response.writeHead(rc, {\n              'Content-Type': 'text/plain',\n              'Content-Length': text.length\n            });\n          }\n\n          if (!http.response.finished) {\n            http.response.end(text);\n          }\n        }\n\n        return false;\n      }\n      return true;\n    };\n\n    this._methodNames = {\n      _Abort: `_FilesCollectionAbort_${this.collectionName}`,\n      _Write: `_FilesCollectionWrite_${this.collectionName}`,\n      _Start: `_FilesCollectionStart_${this.collectionName}`,\n      _Remove: `_FilesCollectionRemove_${this.collectionName}`\n    };\n\n    this.on('_handleUpload', this._handleUpload);\n    this.on('_finishUpload', this._finishUpload);\n\n    if (!this.disableUpload && !this.disableDownload) {\n      WebApp.connectHandlers.use((httpReq, httpResp, next) => {\n        if (!this.disableUpload && !!~httpReq._parsedUrl.path.indexOf(`${this.downloadRoute}/${this.collectionName}/__upload`)) {\n          if (httpReq.method === 'POST') {\n            const handleError = (error) => {\n              console.warn('[FilesCollection] [Upload] [HTTP] Exception:', error);\n              if (!httpResp.headersSent) {\n                httpResp.writeHead(500);\n              }\n              if (!httpResp.finished) {\n                httpResp.end(JSON.stringify({error}));\n              }\n            };\n\n            let body = '';\n            httpReq.on('data', (data) => bound(() => {\n              body += data;\n            }));\n\n            httpReq.on('end', () => bound(() => {\n              try {\n                let opts;\n                let result;\n                let user;\n\n                if (httpReq.headers['x-mtok'] && _.isObject(Meteor.server.sessions) && _.has(Meteor.server.sessions[httpReq.headers['x-mtok']], 'userId')) {\n                  user = {\n                    userId: Meteor.server.sessions[httpReq.headers['x-mtok']].userId\n                  };\n                } else {\n                  user = this._getUser({request: httpReq, response: httpResp});\n                }\n\n                if (httpReq.headers['x-start'] !== '1') {\n                  opts = {\n                    fileId: httpReq.headers['x-fileid']\n                  };\n\n                  if (httpReq.headers['x-eof'] === '1') {\n                    opts.eof = true;\n                  } else {\n                    if (typeof Buffer.from === 'function') {\n                      try {\n                        opts.binData = Buffer.from(body, 'base64');\n                      } catch (buffErr) {\n                        opts.binData = new Buffer(body, 'base64');\n                      }\n                    } else {\n                      opts.binData = new Buffer(body, 'base64');\n                    }\n                    opts.chunkId = parseInt(httpReq.headers['x-chunkid']);\n                  }\n\n                  const _continueUpload = this._continueUpload(opts.fileId);\n                  if (!_continueUpload) {\n                    throw new Meteor.Error(408, 'Can\\'t continue upload, session expired. Start upload again.');\n                  }\n\n                  ({result, opts}  = this._prepareUpload(_.extend(opts, _continueUpload), user.userId, 'HTTP'));\n\n                  if (opts.eof) {\n                    this._handleUpload(result, opts, () => {\n                      if (!httpResp.headersSent) {\n                        httpResp.writeHead(200);\n                      }\n\n                      if (_.isObject(result.file) && result.file.meta) {\n                        result.file.meta = fixJSONStringify(result.file.meta);\n                      }\n\n                      if (!httpResp.finished) {\n                        httpResp.end(JSON.stringify(result));\n                      }\n                    });\n                    return;\n                  }\n\n                  this.emit('_handleUpload', result, opts, NOOP);\n\n                  if (!httpResp.headersSent) {\n                    httpResp.writeHead(204);\n                  }\n                  if (!httpResp.finished) {\n                    httpResp.end();\n                  }\n                } else {\n                  try {\n                    opts = JSON.parse(body);\n                  } catch (jsonErr) {\n                    console.error('Can\\'t parse incoming JSON from Client on [.insert() | upload], something went wrong!', jsonErr);\n                    opts = {file: {}};\n                  }\n\n                  opts.___s = true;\n                  this._debug(`[FilesCollection] [File Start HTTP] ${opts.file.name} - ${opts.fileId}`);\n                  if (_.isObject(opts.file) && opts.file.meta) {\n                    opts.file.meta = fixJSONParse(opts.file.meta);\n                  }\n\n                  ({result} = this._prepareUpload(_.clone(opts), user.userId, 'HTTP Start Method'));\n\n                  if (this.collection.findOne(result._id)) {\n                    throw new Meteor.Error(400, 'Can\\'t start upload, data substitution detected!');\n                  }\n\n                  opts._id       = opts.fileId;\n                  opts.createdAt = new Date();\n                  opts.maxLength = opts.fileLength;\n                  this._preCollection.insert(_.omit(opts, '___s'));\n                  this._createStream(result._id, result.path, _.omit(opts, '___s'));\n\n                  if (opts.returnMeta) {\n                    if (!httpResp.headersSent) {\n                      httpResp.writeHead(200);\n                    }\n                    if (!httpResp.finished) {\n                      httpResp.end(JSON.stringify({\n                        uploadRoute: `${this.downloadRoute}/${this.collectionName}/__upload`,\n                        file: result\n                      }));\n                    }\n                  } else {\n                    if (!httpResp.headersSent) {\n                      httpResp.writeHead(204);\n                    }\n                    if (!httpResp.finished) {\n                      httpResp.end();\n                    }\n                  }\n                }\n              } catch (httpRespErr) {\n                handleError(httpRespErr);\n              }\n            }));\n          } else {\n            next();\n          }\n          return;\n        }\n\n        if (!this.disableDownload) {\n          let http;\n          let params;\n          let uri;\n          let uris;\n\n          if (!this.public) {\n            if (!!~httpReq._parsedUrl.path.indexOf(`${this.downloadRoute}/${this.collectionName}`)) {\n              uri = httpReq._parsedUrl.path.replace(`${this.downloadRoute}/${this.collectionName}`, '');\n              if (uri.indexOf('/') === 0) {\n                uri = uri.substring(1);\n              }\n\n              uris = uri.split('/');\n              if (uris.length === 3) {\n                params = {\n                  _id: uris[0],\n                  query: httpReq._parsedUrl.query ? nodeQs.parse(httpReq._parsedUrl.query) : {},\n                  name: uris[2].split('?')[0],\n                  version: uris[1]\n                };\n\n                http = {request: httpReq, response: httpResp, params};\n                if (this._checkAccess(http)) {\n                  this.download(http, uris[1], this.collection.findOne(uris[0]));\n                }\n              } else {\n                next();\n              }\n            } else {\n              next();\n            }\n          } else {\n            if (!!~httpReq._parsedUrl.path.indexOf(`${this.downloadRoute}`)) {\n              uri = httpReq._parsedUrl.path.replace(`${this.downloadRoute}`, '');\n              if (uri.indexOf('/') === 0) {\n                uri = uri.substring(1);\n              }\n\n              uris  = uri.split('/');\n              let _file = uris[uris.length - 1];\n              if (_file) {\n                let version;\n                if (!!~_file.indexOf('-')) {\n                  version = _file.split('-')[0];\n                  _file   = _file.split('-')[1].split('?')[0];\n                } else {\n                  version = 'original';\n                  _file   = _file.split('?')[0];\n                }\n\n                params = {\n                  query: httpReq._parsedUrl.query ? nodeQs.parse(httpReq._parsedUrl.query) : {},\n                  file: _file,\n                  _id: _file.split('.')[0],\n                  version,\n                  name: _file\n                };\n                http = {request: httpReq, response: httpResp, params};\n                this.download(http, version, this.collection.findOne(params._id));\n              } else {\n                next();\n              }\n            } else {\n              next();\n            }\n          }\n          return;\n        }\n        next();\n      });\n    }\n\n    if (!this.disableUpload) {\n      const _methods = {};\n\n      // Method used to remove file\n      // from Client side\n      _methods[this._methodNames._Remove] = function (selector) {\n        check(selector, Match.OneOf(String, Object));\n        self._debug(`[FilesCollection] [Unlink Method] [.remove(${selector})]`);\n\n        if (self.allowClientCode) {\n          if (self.onBeforeRemove && _.isFunction(self.onBeforeRemove)) {\n            const userId = this.userId;\n            const userFuncs = {\n              userId: this.userId,\n              user() {\n                if (Meteor.users) {\n                  return Meteor.users.findOne(userId);\n                }\n                return null;\n              }\n            };\n\n            if (!self.onBeforeRemove.call(userFuncs, (self.find(selector) || null))) {\n              throw new Meteor.Error(403, '[FilesCollection] [remove] Not permitted!');\n            }\n          }\n\n          const cursor = self.find(selector);\n          if (cursor.count() > 0) {\n            self.remove(selector);\n            return true;\n          }\n          throw new Meteor.Error(404, 'Cursor is empty, no files is removed');\n        } else {\n          throw new Meteor.Error(401, '[FilesCollection] [remove] Run code from client is not allowed!');\n        }\n      };\n\n\n      // Method used to receive \"first byte\" of upload\n      // and all file's meta-data, so\n      // it won't be transferred with every chunk\n      // Basically it prepares everything\n      // So user can pause/disconnect and\n      // continue upload later, during `continueUploadTTL`\n      _methods[this._methodNames._Start] = function (opts, returnMeta) {\n        check(opts, {\n          file: Object,\n          fileId: String,\n          FSName: Match.Optional(String),\n          chunkSize: Number,\n          fileLength: Number\n        });\n\n        check(returnMeta, Match.Optional(Boolean));\n\n        self._debug(`[FilesCollection] [File Start Method] ${opts.file.name} - ${opts.fileId}`);\n        opts.___s = true;\n        const {result} = self._prepareUpload(_.clone(opts), this.userId, 'DDP Start Method');\n\n        if (self.collection.findOne(result._id)) {\n          throw new Meteor.Error(400, 'Can\\'t start upload, data substitution detected!');\n        }\n\n        opts._id       = opts.fileId;\n        opts.createdAt = new Date();\n        opts.maxLength = opts.fileLength;\n        self._preCollection.insert(_.omit(opts, '___s'));\n        self._createStream(result._id, result.path, _.omit(opts, '___s'));\n\n        if (returnMeta) {\n          return {\n            uploadRoute: `${self.downloadRoute}/${self.collectionName}/__upload`,\n            file: result\n          };\n        }\n        return true;\n      };\n\n\n      // Method used to write file chunks\n      // it receives very limited amount of meta-data\n      // This method also responsible for EOF\n      _methods[this._methodNames._Write] = function (opts) {\n        let result;\n        check(opts, {\n          eof: Match.Optional(Boolean),\n          fileId: String,\n          binData: Match.Optional(String),\n          chunkId: Match.Optional(Number)\n        });\n\n        if (opts.binData) {\n          if (typeof Buffer.from === 'function') {\n            try {\n              opts.binData = Buffer.from(opts.binData, 'base64');\n            } catch (buffErr) {\n              opts.binData = new Buffer(opts.binData, 'base64');\n            }\n          } else {\n            opts.binData = new Buffer(opts.binData, 'base64');\n          }\n        }\n\n        const _continueUpload = self._continueUpload(opts.fileId);\n        if (!_continueUpload) {\n          throw new Meteor.Error(408, 'Can\\'t continue upload, session expired. Start upload again.');\n        }\n\n        this.unblock();\n        ({result, opts} = self._prepareUpload(_.extend(opts, _continueUpload), this.userId, 'DDP'));\n\n        if (opts.eof) {\n          try {\n            return Meteor.wrapAsync(self._handleUpload.bind(self, result, opts))();\n          } catch (handleUploadErr) {\n            self._debug('[FilesCollection] [Write Method] [DDP] Exception:', handleUploadErr);\n            throw handleUploadErr;\n          }\n        } else {\n          self.emit('_handleUpload', result, opts, NOOP);\n        }\n        return true;\n      };\n\n      // Method used to Abort upload\n      // - Feeing memory by .end()ing writableStreams\n      // - Removing temporary record from @_preCollection\n      // - Removing record from @collection\n      // - .unlink()ing chunks from FS\n      _methods[this._methodNames._Abort] = function (_id) {\n        check(_id, String);\n\n        const _continueUpload = self._continueUpload(_id);\n        self._debug(`[FilesCollection] [Abort Method]: ${_id} - ${(_.isObject(_continueUpload.file) ? _continueUpload.file.path : '')}`);\n\n        if (self._currentUploads && self._currentUploads[_id]) {\n          self._currentUploads[_id].stop();\n          self._currentUploads[_id].abort();\n        }\n\n        if (_continueUpload) {\n          self._preCollection.remove({_id});\n          self.remove({_id});\n          if (_.isObject(_continueUpload.file) && _continueUpload.file.path) {\n            self.unlink({_id, path: _continueUpload.file.path});\n          }\n        }\n        return true;\n      };\n\n      Meteor.methods(_methods);\n    }\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name _prepareUpload\n   * @summary Internal method. Used to optimize received data and check upload permission\n   * @returns {Object}\n   */\n  _prepareUpload(opts = {}, userId, transport) {\n    let ctx;\n    if (!_.isBoolean(opts.eof)) {\n      opts.eof = false;\n    }\n\n    if (!opts.binData) {\n      opts.binData = 'EOF';\n    }\n\n    if (!_.isNumber(opts.chunkId)) {\n      opts.chunkId = -1;\n    }\n\n    if (!_.isString(opts.FSName)) {\n      opts.FSName = opts.fileId;\n    }\n\n    this._debug(`[FilesCollection] [Upload] [${transport}] Got #${opts.chunkId}/${opts.fileLength} chunks, dst: ${opts.file.name || opts.file.fileName}`);\n\n    const fileName = this._getFileName(opts.file);\n    const {extension, extensionWithDot} = this._getExt(fileName);\n\n    if (!_.isObject(opts.file.meta)) {\n      opts.file.meta = {};\n    }\n\n    let result       = opts.file;\n    result.name      = fileName;\n    result.meta      = opts.file.meta;\n    result.extension = extension;\n    result.ext       = extension;\n    result._id       = opts.fileId;\n    result.userId    = userId || null;\n    opts.FSName      = opts.FSName.replace(/([^a-z0-9\\-\\_]+)/gi, '-');\n    result.path      = `${this.storagePath(result)}${nodePath.sep}${opts.FSName}${extensionWithDot}`;\n    result           = _.extend(result, this._dataToSchema(result));\n\n    if (this.onBeforeUpload && _.isFunction(this.onBeforeUpload)) {\n      ctx = _.extend({\n        file: opts.file\n      }, {\n        chunkId: opts.chunkId,\n        userId: result.userId,\n        user() {\n          if (Meteor.users && result.userId) {\n            return Meteor.users.findOne(result.userId);\n          }\n          return null;\n        },\n        eof: opts.eof\n      });\n      const isUploadAllowed = this.onBeforeUpload.call(ctx, result);\n\n      if (isUploadAllowed !== true) {\n        throw new Meteor.Error(403, _.isString(isUploadAllowed) ? isUploadAllowed : '@onBeforeUpload() returned false');\n      } else {\n        if ((opts.___s === true) && this.onInitiateUpload && _.isFunction(this.onInitiateUpload)) {\n          this.onInitiateUpload.call(ctx, result);\n        }\n      }\n    } else if ((opts.___s === true) && this.onInitiateUpload && _.isFunction(this.onInitiateUpload)) {\n      ctx = _.extend({\n        file: opts.file\n      }, {\n        chunkId: opts.chunkId,\n        userId: result.userId,\n        user() {\n          if (Meteor.users && result.userId) {\n            return Meteor.users.findOne(result.userId);\n          }\n          return null;\n        },\n        eof: opts.eof\n      });\n      this.onInitiateUpload.call(ctx, result);\n    }\n\n    return {result, opts};\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name _finishUpload\n   * @summary Internal method. Finish upload, close Writable stream, add record to MongoDB and flush used memory\n   * @returns {undefined}\n   */\n  _finishUpload(result, opts, cb) {\n    this._debug(`[FilesCollection] [Upload] [finish(ing)Upload] -> ${result.path}`);\n    fs.chmod(result.path, this.permissions, NOOP);\n    result.type   = this._getMimeType(opts.file);\n    result.public = this.public;\n    this._updateFileTypes(result);\n\n    this.collection.insert(_.clone(result), (error, _id) => {\n      if (error) {\n        cb && cb(error);\n        this._debug('[FilesCollection] [Upload] [_finishUpload] Error:', error);\n      } else {\n        this._preCollection.update({_id: opts.fileId}, {$set: {isFinished: true}});\n        result._id = _id;\n        this._debug(`[FilesCollection] [Upload] [finish(ed)Upload] -> ${result.path}`);\n        this.onAfterUpload && this.onAfterUpload.call(this, result);\n        this.emit('afterUpload', result);\n        cb && cb(null, result);\n      }\n    });\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name _handleUpload\n   * @summary Internal method to handle upload process, pipe incoming data to Writable stream\n   * @returns {undefined}\n   */\n  _handleUpload(result, opts, cb) {\n    try {\n      if (opts.eof) {\n        this._currentUploads[result._id].end(() => {\n          this.emit('_finishUpload', result, opts, cb);\n        });\n      } else {\n        this._currentUploads[result._id].write(opts.chunkId, opts.binData, cb);\n      }\n    } catch (e) {\n      this._debug('[_handleUpload] [EXCEPTION:]', e);\n      cb && cb(e);\n    }\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollection\n   * @name _getMimeType\n   * @param {Object} fileData - File Object\n   * @summary Returns file's mime-type\n   * @returns {String}\n   */\n  _getMimeType(fileData) {\n    let mime;\n    check(fileData, Object);\n    if (_.isObject(fileData) && fileData.type) {\n      mime = fileData.type;\n    }\n\n    if (fileData.path && (!mime || !_.isString(mime))) {\n      try {\n        let buf   = new Buffer(262);\n        const fd  = fs.openSync(fileData.path, 'r');\n        const br  = fs.readSync(fd, buf, 0, 262, 0);\n        fs.close(fd, NOOP);\n        if (br < 262) {\n          buf = buf.slice(0, br);\n        }\n        ({mime} = fileType(buf));\n      } catch (e) {\n        // We're good\n      }\n    }\n\n    if (!mime || !_.isString(mime)) {\n      mime = 'application/octet-stream';\n    }\n    return mime;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollection\n   * @name _getUser\n   * @summary Returns object with `userId` and `user()` method which return user's object\n   * @returns {Object}\n   */\n  _getUser(http) {\n    const result = {\n      user() { return null; },\n      userId: null\n    };\n\n    if (http) {\n      let mtok = null;\n      if (http.request.headers['x-mtok']) {\n        mtok = http.request.headers['x-mtok'];\n      } else {\n        const cookie = http.request.Cookies;\n        if (cookie.has('x_mtok')) {\n          mtok = cookie.get('x_mtok');\n        }\n      }\n\n      if (mtok) {\n        const userId = (_.isObject(Meteor.server.sessions) && _.isObject(Meteor.server.sessions[mtok])) ? Meteor.server.sessions[mtok].userId : void 0;\n\n        if (userId) {\n          result.user   = () => Meteor.users.findOne(userId);\n          result.userId = userId;\n        }\n      }\n    }\n\n    return result;\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name write\n   * @param {Buffer} buffer - Binary File's Buffer\n   * @param {Object} opts - Object with file-data\n   * @param {String} opts.name - File name, alias: `fileName`\n   * @param {String} opts.type - File mime-type\n   * @param {Object} opts.meta - File additional meta-data\n   * @param {String} opts.userId - UserId, default *null*\n   * @param {String} opts.fileId - _id, default *null*\n   * @param {Function} callback - function(error, fileObj){...}\n   * @param {Boolean} proceedAfterUpload - Proceed onAfterUpload hook\n   * @summary Write buffer to FS and add to FilesCollection Collection\n   * @returns {FilesCollection} Instance\n   */\n  write(buffer, opts = {}, callback, proceedAfterUpload) {\n    this._debug('[FilesCollection] [write()]');\n\n    if (_.isFunction(opts)) {\n      proceedAfterUpload = callback;\n      callback = opts;\n      opts     = {};\n    } else if (_.isBoolean(callback)) {\n      proceedAfterUpload = callback;\n    } else if (_.isBoolean(opts)) {\n      proceedAfterUpload = opts;\n    }\n\n    check(opts, Match.Optional(Object));\n    check(callback, Match.Optional(Function));\n    check(proceedAfterUpload, Match.Optional(Boolean));\n\n    const fileId   = opts.fileId || Random.id();\n    const FSName   = this.namingFunction ? this.namingFunction(opts) : fileId;\n    const fileName = (opts.name || opts.fileName) ? (opts.name || opts.fileName) : FSName;\n\n    const {extension, extensionWithDot} = this._getExt(fileName);\n\n    opts.path = `${this.storagePath(opts)}${nodePath.sep}${FSName}${extensionWithDot}`;\n    opts.type = this._getMimeType(opts);\n    if (!_.isObject(opts.meta)) {\n      opts.meta = {};\n    }\n\n    if (!_.isNumber(opts.size)) {\n      opts.size = buffer.length;\n    }\n\n    const result = this._dataToSchema({\n      name: fileName,\n      path: opts.path,\n      meta: opts.meta,\n      type: opts.type,\n      size: opts.size,\n      userId: opts.userId,\n      extension\n    });\n\n    result._id = fileId;\n\n    const stream = fs.createWriteStream(opts.path, {flags: 'w', mode: this.permissions});\n    stream.end(buffer, (streamErr) => bound(() => {\n      if (streamErr) {\n        callback && callback(streamErr);\n      } else {\n        this.collection.insert(result, (insertErr, _id) => {\n          if (insertErr) {\n            callback && callback(insertErr);\n            this._debug(`[FilesCollection] [write] [insert] Error: ${fileName} -> ${this.collectionName}`, insertErr);\n          } else {\n            const fileRef = this.collection.findOne(_id);\n            callback && callback(null, fileRef);\n            if (proceedAfterUpload === true) {\n              this.onAfterUpload && this.onAfterUpload.call(this, fileRef);\n              this.emit('afterUpload', fileRef);\n            }\n            this._debug(`[FilesCollection] [write]: ${fileName} -> ${this.collectionName}`);\n          }\n        });\n      }\n    }));\n    return this;\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name load\n   * @param {String} url - URL to file\n   * @param {Object} opts - Object with file-data\n   * @param {Object} opts.headers - HTTP headers to use when requesting the file\n   * @param {String} opts.name - File name, alias: `fileName`\n   * @param {String} opts.type - File mime-type\n   * @param {Object} opts.meta - File additional meta-data\n   * @param {String} opts.userId - UserId, default *null*\n   * @param {String} opts.fileId - _id, default *null*\n   * @param {Function} callback - function(error, fileObj){...}\n   * @param {Boolean} proceedAfterUpload - Proceed onAfterUpload hook\n   * @summary Download file, write stream to FS and add to FilesCollection Collection\n   * @returns {FilesCollection} Instance\n   */\n  load(url, opts = {}, callback, proceedAfterUpload) {\n    this._debug(`[FilesCollection] [load(${url}, ${JSON.stringify(opts)}, callback)]`);\n\n    if (_.isFunction(opts)) {\n      proceedAfterUpload = callback;\n      callback = opts;\n      opts     = {};\n    } else if (_.isBoolean(callback)) {\n      proceedAfterUpload = callback;\n    } else if (_.isBoolean(opts)) {\n      proceedAfterUpload = opts;\n    }\n\n    check(url, String);\n    check(opts, Match.Optional(Object));\n    check(callback, Match.Optional(Function));\n    check(proceedAfterUpload, Match.Optional(Boolean));\n\n    if (!_.isObject(opts)) {\n      opts = {};\n    }\n\n    const fileId    = opts.fileId || Random.id();\n    const FSName    = this.namingFunction ? this.namingFunction(opts) : fileId;\n    const pathParts = url.split('/');\n    const fileName  = (opts.name || opts.fileName) ? (opts.name || opts.fileName) : pathParts[pathParts.length - 1] || FSName;\n\n    const {extension, extensionWithDot} = this._getExt(fileName);\n    opts.path  = `${this.storagePath(opts)}${nodePath.sep}${FSName}${extensionWithDot}`;\n\n    const storeResult = (result, cb) => {\n      result._id = fileId;\n\n      this.collection.insert(result, (error, _id) => {\n        if (error) {\n          cb && cb(error);\n          this._debug(`[FilesCollection] [load] [insert] Error: ${fileName} -> ${this.collectionName}`, error);\n        } else {\n          const fileRef = this.collection.findOne(_id);\n          cb && cb(null, fileRef);\n          if (proceedAfterUpload === true) {\n            this.onAfterUpload && this.onAfterUpload.call(this, fileRef);\n            this.emit('afterUpload', fileRef);\n          }\n          this._debug(`[FilesCollection] [load] [insert] ${fileName} -> ${this.collectionName}`);\n        }\n      });\n    };\n\n    request.get({\n      url,\n      headers: opts.headers || {}\n    }).on('error', (error) => bound(() => {\n      callback && callback(error);\n      this._debug(`[FilesCollection] [load] [request.get(${url})] Error:`, error);\n    })).on('response', (response) => bound(() => {\n      response.on('end', () => bound(() => {\n        this._debug(`[FilesCollection] [load] Received: ${url}`);\n        const result = this._dataToSchema({\n          name: fileName,\n          path: opts.path,\n          meta: opts.meta,\n          type: opts.type || response.headers['content-type'] || this._getMimeType({path: opts.path}),\n          size: opts.size || parseInt(response.headers['content-length'] || 0),\n          userId: opts.userId,\n          extension\n        });\n\n        if (!result.size) {\n          fs.stat(opts.path, (error, stats) => bound(() => {\n            if (error) {\n              callback && callback(error);\n            } else {\n              result.versions.original.size = (result.size = stats.size);\n              storeResult(result, callback);\n            }\n          }));\n        } else {\n          storeResult(result, callback);\n        }\n      }));\n    })).pipe(fs.createWriteStream(opts.path, {flags: 'w', mode: this.permissions}));\n\n    return this;\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name addFile\n   * @param {String} path          - Path to file\n   * @param {String} opts          - [Optional] Object with file-data\n   * @param {String} opts.type     - [Optional] File mime-type\n   * @param {Object} opts.meta     - [Optional] File additional meta-data\n   * @param {Object} opts.fileName - [Optional] File name, if not specified file name and extension will be taken from path\n   * @param {String} opts.userId   - [Optional] UserId, default *null*\n   * @param {Function} callback    - [Optional] function(error, fileObj){...}\n   * @param {Boolean} proceedAfterUpload - Proceed onAfterUpload hook\n   * @summary Add file from FS to FilesCollection\n   * @returns {FilesCollection} Instance\n   */\n  addFile(path, opts = {}, callback, proceedAfterUpload) {\n    this._debug(`[FilesCollection] [addFile(${path})]`);\n\n    if (_.isFunction(opts)) {\n      proceedAfterUpload = callback;\n      callback = opts;\n      opts     = {};\n    } else if (_.isBoolean(callback)) {\n      proceedAfterUpload = callback;\n    } else if (_.isBoolean(opts)) {\n      proceedAfterUpload = opts;\n    }\n\n    if (this.public) {\n      throw new Meteor.Error(403, 'Can not run [addFile] on public collection! Just Move file to root of your server, then add record to Collection');\n    }\n\n    check(path, String);\n    check(opts, Match.Optional(Object));\n    check(callback, Match.Optional(Function));\n    check(proceedAfterUpload, Match.Optional(Boolean));\n\n    fs.stat(path, (statErr, stats) => bound(() => {\n      if (statErr) {\n        callback && callback(statErr);\n      } else if (stats.isFile()) {\n        if (!_.isObject(opts)) {\n          opts = {};\n        }\n        opts.path  = path;\n\n        if (!opts.fileName) {\n          const pathParts = path.split(nodePath.sep);\n          opts.fileName   = path.split(nodePath.sep)[pathParts.length - 1];\n        }\n\n        const {extension} = this._getExt(opts.fileName);\n\n        if (!_.isString(opts.type)) {\n          opts.type = this._getMimeType(opts);\n        }\n\n        if (!_.isObject(opts.meta)) {\n          opts.meta = {};\n        }\n\n        if (!_.isNumber(opts.size)) {\n          opts.size = stats.size;\n        }\n\n        const result = this._dataToSchema({\n          name: opts.fileName,\n          path,\n          meta: opts.meta,\n          type: opts.type,\n          size: opts.size,\n          userId: opts.userId,\n          extension,\n          _storagePath: path.replace(`${nodePath.sep}${opts.fileName}`, ''),\n          fileId: opts.fileId || null\n        });\n\n\n        this.collection.insert(result, (insertErr, _id) => {\n          if (insertErr) {\n            callback && callback(insertErr);\n            this._debug(`[FilesCollection] [addFile] [insert] Error: ${result.name} -> ${this.collectionName}`, insertErr);\n          } else {\n            const fileRef = this.collection.findOne(_id);\n            callback && callback(null, fileRef);\n            if (proceedAfterUpload === true) {\n              this.onAfterUpload && this.onAfterUpload.call(this, fileRef);\n              this.emit('afterUpload', fileRef);\n            }\n            this._debug(`[FilesCollection] [addFile]: ${result.name} -> ${this.collectionName}`);\n          }\n        });\n      } else {\n        callback && callback(new Meteor.Error(400, `[FilesCollection] [addFile(${path})]: File does not exist`));\n      }\n    }));\n    return this;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollection\n   * @name remove\n   * @param {String|Object} selector - Mongo-Style selector (http://docs.meteor.com/api/collections.html#selectors)\n   * @param {Function} callback - Callback with one `error` argument\n   * @summary Remove documents from the collection\n   * @returns {FilesCollection} Instance\n   */\n  remove(selector, callback) {\n    this._debug(`[FilesCollection] [remove(${JSON.stringify(selector)})]`);\n    if (selector === undefined) {\n      return 0;\n    }\n    check(callback, Match.Optional(Function));\n\n    const files = this.collection.find(selector);\n    if (files.count() > 0) {\n      files.forEach((file) => {\n        this.unlink(file);\n      });\n    } else {\n      callback && callback(new Meteor.Error(404, 'Cursor is empty, no files is removed'));\n      return this;\n    }\n\n    if (this.onAfterRemove) {\n      const docs = files.fetch();\n      const self = this;\n      this.collection.remove(selector, function () {\n        callback && callback.apply(this, arguments);\n        self.onAfterRemove(docs);\n      });\n    } else {\n      this.collection.remove(selector, (callback || NOOP));\n    }\n    return this;\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name deny\n   * @param {Object} rules\n   * @see  https://docs.meteor.com/api/collections.html#Mongo-Collection-deny\n   * @summary link Mongo.Collection deny methods\n   * @returns {Mongo.Collection} Instance\n   */\n  deny(rules) {\n    this.collection.deny(rules);\n    return this.collection;\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name allow\n   * @param {Object} rules\n   * @see https://docs.meteor.com/api/collections.html#Mongo-Collection-allow\n   * @summary link Mongo.Collection allow methods\n   * @returns {Mongo.Collection} Instance\n   */\n  allow(rules) {\n    this.collection.allow(rules);\n    return this.collection;\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name denyClient\n   * @see https://docs.meteor.com/api/collections.html#Mongo-Collection-deny\n   * @summary Shorthands for Mongo.Collection deny method\n   * @returns {Mongo.Collection} Instance\n   */\n  denyClient() {\n    this.collection.deny({\n      insert() { return true; },\n      update() { return true; },\n      remove() { return true; }\n    });\n    return this.collection;\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name allowClient\n   * @see https://docs.meteor.com/api/collections.html#Mongo-Collection-allow\n   * @summary Shorthands for Mongo.Collection allow method\n   * @returns {Mongo.Collection} Instance\n   */\n  allowClient() {\n    this.collection.allow({\n      insert() { return true; },\n      update() { return true; },\n      remove() { return true; }\n    });\n    return this.collection;\n  }\n\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name unlink\n   * @param {Object} fileRef - fileObj\n   * @param {String} version - [Optional] file's version\n   * @param {Function} callback - [Optional] callback function\n   * @summary Unlink files and it's versions from FS\n   * @returns {FilesCollection} Instance\n   */\n  unlink(fileRef, version, callback) {\n    this._debug(`[FilesCollection] [unlink(${fileRef._id}, ${version})]`);\n    if (version) {\n      if (_.isObject(fileRef.versions) && _.isObject(fileRef.versions[version]) && fileRef.versions[version].path) {\n        fs.unlink(fileRef.versions[version].path, (callback || NOOP));\n      }\n    } else {\n      if (_.isObject(fileRef.versions)) {\n        _.each(fileRef.versions, (vRef) => bound(() => {\n          fs.unlink(vRef.path, (callback || NOOP));\n        }));\n      } else {\n        fs.unlink(fileRef.path, (callback || NOOP));\n      }\n    }\n    return this;\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name _404\n   * @summary Internal method, used to return 404 error\n   * @returns {undefined}\n   */\n  _404(http) {\n    this._debug(`[FilesCollection] [download(${http.request.originalUrl})] [_404] File not found`);\n    const text = 'File Not Found :(';\n\n    if (!http.response.headersSent) {\n      http.response.writeHead(404, {\n        'Content-Type': 'text/plain',\n        'Content-Length': text.length\n      }\n      );\n    }\n    if (!http.response.finished) {\n      http.response.end(text);\n    }\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name download\n   * @param {Object} http    - Server HTTP object\n   * @param {String} version - Requested file version\n   * @param {Object} fileRef - Requested file Object\n   * @summary Initiates the HTTP response\n   * @returns {undefined}\n   */\n  download(http, version = 'original', fileRef) {\n    let vRef;\n    this._debug(`[FilesCollection] [download(${http.request.originalUrl}, ${version})]`);\n\n    if (fileRef) {\n      if (_.has(fileRef, 'versions') && _.has(fileRef.versions, version)) {\n        vRef = fileRef.versions[version];\n        vRef._id = fileRef._id;\n      } else {\n        vRef = fileRef;\n      }\n    } else {\n      vRef = false;\n    }\n\n    if (!vRef || !_.isObject(vRef)) {\n      return this._404(http);\n    } else if (fileRef) {\n      if (this.downloadCallback) {\n        if (!this.downloadCallback.call(_.extend(http, this._getUser(http)), fileRef)) {\n          return this._404(http);\n        }\n      }\n\n      if (this.interceptDownload && _.isFunction(this.interceptDownload)) {\n        if (this.interceptDownload(http, fileRef, version) === true) {\n          return void 0;\n        }\n      }\n\n      fs.stat(vRef.path, (statErr, stats) => bound(() => {\n        let responseType;\n        if (statErr || !stats.isFile()) {\n          return this._404(http);\n        }\n\n        if ((stats.size !== vRef.size) && !this.integrityCheck) {\n          vRef.size    = stats.size;\n        }\n\n        if ((stats.size !== vRef.size) && this.integrityCheck) {\n          responseType = '400';\n        }\n\n        return this.serve(http, fileRef, vRef, version, null, (responseType || '200'));\n      }));\n      return void 0;\n    }\n    return this._404(http);\n  }\n\n  /*\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name serve\n   * @param {Object} http    - Server HTTP object\n   * @param {Object} fileRef - Requested file Object\n   * @param {Object} vRef    - Requested file version Object\n   * @param {String} version - Requested file version\n   * @param {stream.Readable|null} readableStream - Readable stream, which serves binary file data\n   * @param {String} responseType - Response code\n   * @param {Boolean} force200 - Force 200 response code over 206\n   * @summary Handle and reply to incoming request\n   * @returns {undefined}\n   */\n  serve(http, fileRef, vRef, version = 'original', readableStream = null, responseType = '200', force200 = false) {\n    let partiral = false;\n    let reqRange = false;\n    let dispositionType = '';\n    let start;\n    let end;\n    let take;\n\n    if (http.params.query.download && (http.params.query.download === 'true')) {\n      dispositionType = 'attachment; ';\n    } else {\n      dispositionType = 'inline; ';\n    }\n\n    const dispositionName     = `filename=\\\"${encodeURI(vRef.name || fileRef.name)}\\\"; filename*=UTF-8''${encodeURI(vRef.name || fileRef.name)}; `;\n    const dispositionEncoding = 'charset=UTF-8';\n\n    if (!http.response.headersSent) {\n      http.response.setHeader('Content-Disposition', dispositionType + dispositionName + dispositionEncoding);\n    }\n\n    if (http.request.headers.range && !force200) {\n      partiral    = true;\n      const array = http.request.headers.range.split(/bytes=([0-9]*)-([0-9]*)/);\n      start       = parseInt(array[1]);\n      end         = parseInt(array[2]);\n      if (isNaN(end)) {\n        end       = vRef.size - 1;\n      }\n      take        = end - start;\n    } else {\n      start = 0;\n      end   = vRef.size - 1;\n      take  = vRef.size;\n    }\n\n    if (partiral || (http.params.query.play && (http.params.query.play === 'true'))) {\n      reqRange = {start, end};\n      if (isNaN(start) && !isNaN(end)) {\n        reqRange.start = end - take;\n        reqRange.end   = end;\n      }\n      if (!isNaN(start) && isNaN(end)) {\n        reqRange.start = start;\n        reqRange.end   = start + take;\n      }\n\n      if ((start + take) >= vRef.size) { reqRange.end = vRef.size - 1; }\n\n      if (this.strict && ((reqRange.start >= (vRef.size - 1)) || (reqRange.end > (vRef.size - 1)))) {\n        responseType = '416';\n      } else {\n        responseType = '206';\n      }\n    } else {\n      responseType = '200';\n    }\n\n    const streamErrorHandler = (error) => {\n      this._debug(`[FilesCollection] [serve(${vRef.path}, ${version})] [500]`, error);\n      if (!http.response.finished) {\n        http.response.end(error.toString());\n      }\n    };\n\n    const headers = _.isFunction(this.responseHeaders) ? this.responseHeaders(responseType, fileRef, vRef, version) : this.responseHeaders;\n\n    if (!headers['Cache-Control']) {\n      if (!http.response.headersSent) {\n        http.response.setHeader('Cache-Control', this.cacheControl);\n      }\n    }\n\n    for (let key in headers) {\n      if (!http.response.headersSent) {\n        http.response.setHeader(key, headers[key]);\n      }\n    }\n\n    let stream;\n\n    switch (responseType) {\n    case '400':\n      this._debug(`[FilesCollection] [serve(${vRef.path}, ${version})] [400] Content-Length mismatch!`);\n      var text = 'Content-Length mismatch!';\n\n      if (!http.response.headersSent) {\n        http.response.writeHead(400, {\n          'Content-Type': 'text/plain',\n          'Content-Length': text.length\n        });\n      }\n\n      if (!http.response.finished) {\n        http.response.end(text);\n      }\n      break;\n    case '404':\n      this._404(http);\n      break;\n    case '416':\n      this._debug(`[FilesCollection] [serve(${vRef.path}, ${version})] [416] Content-Range is not specified!`);\n      if (!http.response.headersSent) {\n        http.response.writeHead(416);\n      }\n      if (!http.response.finished) {\n        http.response.end();\n      }\n      break;\n    case '206':\n      this._debug(`[FilesCollection] [serve(${vRef.path}, ${version})] [206]`);\n      if (!http.response.headersSent) {\n        http.response.setHeader('Content-Range', `bytes ${reqRange.start}-${reqRange.end}/${vRef.size}`);\n      }\n      stream = readableStream || fs.createReadStream(vRef.path, {start: reqRange.start, end: reqRange.end});\n      if (!http.response.headersSent) {\n        if (readableStream) {\n          http.response.writeHead(206);\n        }\n      }\n\n      http.response.on('close', () => {\n        if (typeof stream.abort === 'function') {\n          stream.abort();\n        }\n        if (typeof stream.end === 'function') {\n          stream.end();\n        }\n      });\n\n      http.request.on('abort', () => {\n        if (typeof stream.abort === 'function') {\n          stream.abort();\n        }\n        if (typeof stream.end === 'function') {\n          stream.end();\n        }\n      });\n\n      stream.on('open', () => {\n        if (!http.response.headersSent) {\n          http.response.writeHead(206);\n        }\n      }).on('abort', () => {\n        if (!http.response.finished) {\n          http.response.end();\n        }\n        if (!http.request.aborted) {\n          http.request.abort();\n        }\n      }).on('error', streamErrorHandler\n      ).on('end', () => {\n        if (!http.response.finished) {\n          http.response.end();\n        }\n      }).pipe(http.response);\n      break;\n    default:\n      this._debug(`[FilesCollection] [serve(${vRef.path}, ${version})] [200]`);\n      stream = readableStream || fs.createReadStream(vRef.path);\n      if (!http.response.headersSent) {\n        if (readableStream) { http.response.writeHead(200); }\n      }\n\n      http.response.on('close', () => {\n        if (typeof stream.abort === 'function') {\n          stream.abort();\n        }\n        if (typeof stream.end === 'function') {\n          stream.end();\n        }\n      });\n\n      http.request.on('abort', () => {\n        if (typeof stream.abort === 'function') {\n          stream.abort();\n        }\n        if (typeof stream.end === 'function') {\n          stream.end();\n        }\n      });\n\n      stream.on('open', () => {\n        if (!http.response.headersSent) {\n          http.response.writeHead(200);\n        }\n      }).on('abort', () => {\n        if (!http.response.finished) {\n          http.response.end();\n        }\n        if (!http.request.aborted) {\n          http.request.abort();\n        }\n      }).on('error', streamErrorHandler\n      ).on('end', () => {\n        if (!http.response.finished) {\n          http.response.end();\n        }\n      }).pipe(http.response);\n      break;\n    }\n  }\n}\n","import { _ }                       from 'meteor/underscore';\nimport { EventEmitter }            from 'eventemitter3';\nimport { formatFleURL }            from './lib.js';\nimport { check, Match }            from 'meteor/check';\nimport { FilesCursor, FileCursor } from './cursor.js';\n\nexport default class FilesCollectionCore extends EventEmitter {\n  constructor() {\n    super();\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name _debug\n   * @summary Print logs in debug mode\n   * @returns {void}\n   */\n  _debug() {\n    if (this.debug) {\n      (console.info || console.log || function () { }).apply(undefined, arguments);\n    }\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name _getFileName\n   * @param {Object} fileData - File Object\n   * @summary Returns file's name\n   * @returns {String}\n   */\n  _getFileName(fileData) {\n    const fileName = fileData.name || fileData.fileName;\n    if (_.isString(fileName) && (fileName.length > 0)) {\n      return (fileData.name || fileData.fileName).replace(/\\.\\./g, '').replace(/\\//g, '');\n    }\n    return '';\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name _getExt\n   * @param {String} FileName - File name\n   * @summary Get extension from FileName\n   * @returns {Object}\n   */\n  _getExt(fileName) {\n    if (!!~fileName.indexOf('.')) {\n      const extension = (fileName.split('.').pop().split('?')[0] || '').toLowerCase();\n      return { ext: extension, extension, extensionWithDot: `.${extension}` };\n    }\n    return { ext: '', extension: '', extensionWithDot: '' };\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name _updateFileTypes\n   * @param {Object} data - File data\n   * @summary Internal method. Classify file based on 'type' field\n   */\n  _updateFileTypes(data) {\n    data.isVideo  = /^video\\//i.test(data.type);\n    data.isAudio  = /^audio\\//i.test(data.type);\n    data.isImage  = /^image\\//i.test(data.type);\n    data.isText   = /^text\\//i.test(data.type);\n    data.isJSON   = /^application\\/json$/i.test(data.type);\n    data.isPDF    = /^application\\/(x-)?pdf$/i.test(data.type);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name _dataToSchema\n   * @param {Object} data - File data\n   * @summary Internal method. Build object in accordance with default schema from File data\n   * @returns {Object}\n   */\n  _dataToSchema(data) {\n    const ds = {\n      name: data.name,\n      extension: data.extension,\n      path: data.path,\n      meta: data.meta,\n      type: data.type,\n      size: data.size,\n      userId: data.userId || null,\n      versions: {\n        original: {\n          path: data.path,\n          size: data.size,\n          type: data.type,\n          extension: data.extension\n        }\n      },\n      _downloadRoute: data._downloadRoute || this.downloadRoute,\n      _collectionName: data._collectionName || this.collectionName\n    };\n\n    //Optional fileId\n    if (data.fileId) {\n      ds._id = data.fileId;\n    }\n\n    this._updateFileTypes(ds);\n    ds._storagePath = data._storagePath || this.storagePath(_.extend(data, ds));\n    return ds;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name findOne\n   * @param {String|Object} selector - Mongo-Style selector (http://docs.meteor.com/api/collections.html#selectors)\n   * @param {Object} options - Mongo-Style selector Options (http://docs.meteor.com/api/collections.html#sortspecifiers)\n   * @summary Find and return Cursor for matching document Object\n   * @returns {FileCursor} Instance\n   */\n  findOne(selector = {}, options) {\n    this._debug(`[FilesCollection] [findOne(${JSON.stringify(selector)}, ${JSON.stringify(options)})]`);\n    check(selector, Match.Optional(Match.OneOf(Object, String, Boolean, Number, null)));\n    check(options, Match.Optional(Object));\n\n    const doc = this.collection.findOne(selector, options);\n    if (doc) {\n      return new FileCursor(doc, this);\n    }\n    return doc;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name find\n   * @param {String|Object} selector - Mongo-Style selector (http://docs.meteor.com/api/collections.html#selectors)\n   * @param {Object}        options  - Mongo-Style selector Options (http://docs.meteor.com/api/collections.html#sortspecifiers)\n   * @summary Find and return Cursor for matching documents\n   * @returns {FilesCursor} Instance\n   */\n  find(selector = {}, options) {\n    this._debug(`[FilesCollection] [find(${JSON.stringify(selector)}, ${JSON.stringify(options)})]`);\n    check(selector, Match.Optional(Match.OneOf(Object, String, Boolean, Number, null)));\n    check(options, Match.Optional(Object));\n\n    return new FilesCursor(selector, options, this);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name update\n   * @see http://docs.meteor.com/#/full/update\n   * @summary link Mongo.Collection update method\n   * @returns {Mongo.Collection} Instance\n   */\n  update() {\n    this.collection.update.apply(this.collection, arguments);\n    return this.collection;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name link\n   * @param {Object} fileRef - File reference object\n   * @param {String} version - Version of file you would like to request\n   * @summary Returns downloadable URL\n   * @returns {String} Empty string returned in case if file not found in DB\n   */\n  link(fileRef, version = 'original') {\n    this._debug(`[FilesCollection] [link(${(_.isObject(fileRef) ? fileRef._id : undefined)}, ${version})]`);\n    check(fileRef, Object);\n    check(version, String);\n\n    if (!fileRef) {\n      return '';\n    }\n    return formatFleURL(fileRef, version);\n  }\n}\n","import { _ }      from 'meteor/underscore';\nimport { Meteor } from 'meteor/meteor';\n\n/*\n * @private\n * @locus Anywhere\n * @class FileCursor\n * @param _fileRef    {Object} - Mongo-Style selector (http://docs.meteor.com/api/collections.html#selectors)\n * @param _collection {FilesCollection} - FilesCollection Instance\n * @summary Internal class, represents each record in `FilesCursor.each()` or document returned from `.findOne()` method\n */\nexport class FileCursor {\n  constructor(_fileRef, _collection) {\n    this._fileRef    = _fileRef;\n    this._collection = _collection;\n    Object.assign(this, _fileRef);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FileCursor\n   * @name remove\n   * @param callback {Function} - Triggered asynchronously after item is removed or failed to be removed\n   * @summary Remove document\n   * @returns {FileCursor}\n   */\n  remove(callback) {\n    this._collection._debug('[FilesCollection] [FileCursor] [remove()]');\n    if (this._fileRef) {\n      this._collection.remove(this._fileRef._id, callback);\n    } else {\n      callback && callback(new Meteor.Error(404, 'No such file'));\n    }\n    return this;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FileCursor\n   * @name link\n   * @param version {String} - Name of file's subversion\n   * @summary Returns downloadable URL to File\n   * @returns {String}\n   */\n  link(version = 'original') {\n    this._collection._debug(`[FilesCollection] [FileCursor] [link(${version})]`);\n    if (this._fileRef) {\n      return this._collection.link(this._fileRef, version);\n    }\n    return '';\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FileCursor\n   * @name get\n   * @param property {String} - Name of sub-object property\n   * @summary Returns current document as a plain Object, if `property` is specified - returns value of sub-object property\n   * @returns {Object|mix}\n   */\n  get(property) {\n    this._collection._debug(`[FilesCollection] [FileCursor] [get(${property})]`);\n    if (property) {\n      return this._fileRef[property];\n    }\n    return this._fileRef;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FileCursor\n   * @name fetch\n   * @summary Returns document as plain Object in Array\n   * @returns {[Object]}\n   */\n  fetch() {\n    this._collection._debug('[FilesCollection] [FileCursor] [fetch()]');\n    return [this._fileRef];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FileCursor\n   * @name with\n   * @summary Returns reactive version of current FileCursor, useful to use with `{{#with}}...{{/with}}` block template helper\n   * @returns {[Object]}\n   */\n  with() {\n    this._collection._debug('[FilesCollection] [FileCursor] [with()]');\n    return _.extend(this, this._collection.collection.findOne(this._fileRef._id));\n  }\n}\n\n/*\n * @private\n * @locus Anywhere\n * @class FilesCursor\n * @param _selector   {String|Object}   - Mongo-Style selector (http://docs.meteor.com/api/collections.html#selectors)\n * @param options     {Object}          - Mongo-Style selector Options (http://docs.meteor.com/api/collections.html#selectors)\n * @param _collection {FilesCollection} - FilesCollection Instance\n * @summary Implementation of Cursor for FilesCollection\n */\nexport class FilesCursor {\n  constructor(_selector = {}, options, _collection) {\n    this._collection = _collection;\n    this._selector   = _selector;\n    this._current    = -1;\n    this.cursor      = this._collection.collection.find(this._selector, options);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name get\n   * @summary Returns all matching document(s) as an Array. Alias of `.fetch()`\n   * @returns {[Object]}\n   */\n  get() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [get()]');\n    return this.cursor.fetch();\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name hasNext\n   * @summary Returns `true` if there is next item available on Cursor\n   * @returns {Boolean}\n   */\n  hasNext() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [hasNext()]');\n    return this._current < (this.cursor.count() - 1);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name next\n   * @summary Returns next item on Cursor, if available\n   * @returns {Object|undefined}\n   */\n  next() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [next()]');\n    this.cursor.fetch()[++this._current];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name hasPrevious\n   * @summary Returns `true` if there is previous item available on Cursor\n   * @returns {Boolean}\n   */\n  hasPrevious() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [hasPrevious()]');\n    return this._current !== -1;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name previous\n   * @summary Returns previous item on Cursor, if available\n   * @returns {Object|undefined}\n   */\n  previous() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [previous()]');\n    this.cursor.fetch()[--this._current];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name fetch\n   * @summary Returns all matching document(s) as an Array.\n   * @returns {[Object]}\n   */\n  fetch() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [fetch()]');\n    return this.cursor.fetch() || [];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name first\n   * @summary Returns first item on Cursor, if available\n   * @returns {Object|undefined}\n   */\n  first() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [first()]');\n    this._current = 0;\n    return this.fetch()[this._current];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name last\n   * @summary Returns last item on Cursor, if available\n   * @returns {Object|undefined}\n   */\n  last() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [last()]');\n    this._current = this.count() - 1;\n    return this.fetch()[this._current];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name count\n   * @summary Returns the number of documents that match a query\n   * @returns {Number}\n   */\n  count() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [count()]');\n    return this.cursor.count();\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name remove\n   * @param callback {Function} - Triggered asynchronously after item is removed or failed to be removed\n   * @summary Removes all documents that match a query\n   * @returns {FilesCursor}\n   */\n  remove(callback) {\n    this._collection._debug('[FilesCollection] [FilesCursor] [remove()]');\n    this._collection.remove(this._selector, callback);\n    return this;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name forEach\n   * @param callback {Function} - Function to call. It will be called with three arguments: the `file`, a 0-based index, and cursor itself\n   * @param context {Object} - An object which will be the value of `this` inside `callback`\n   * @summary Call `callback` once for each matching document, sequentially and synchronously.\n   * @returns {undefined}\n   */\n  forEach(callback, context = {}) {\n    this._collection._debug('[FilesCollection] [FilesCursor] [forEach()]');\n    this.cursor.forEach(callback, context);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name each\n   * @summary Returns an Array of FileCursor made for each document on current cursor\n   *          Useful when using in {{#each FilesCursor#each}}...{{/each}} block template helper\n   * @returns {[FileCursor]}\n   */\n  each() {\n    return this.map((file) => {\n      return new FileCursor(file, this._collection);\n    });\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name map\n   * @param callback {Function} - Function to call. It will be called with three arguments: the `file`, a 0-based index, and cursor itself\n   * @param context {Object} - An object which will be the value of `this` inside `callback`\n   * @summary Map `callback` over all matching documents. Returns an Array.\n   * @returns {Array}\n   */\n  map(callback, context = {}) {\n    this._collection._debug('[FilesCollection] [FilesCursor] [map()]');\n    return this.cursor.map(callback, context);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name current\n   * @summary Returns current item on Cursor, if available\n   * @returns {Object|undefined}\n   */\n  current() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [current()]');\n    if (this._current < 0) {\n      this._current = 0;\n    }\n    return this.fetch()[this._current];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name observe\n   * @param callbacks {Object} - Functions to call to deliver the result set as it changes\n   * @summary Watch a query. Receive callbacks as the result set changes.\n   * @url http://docs.meteor.com/api/collections.html#Mongo-Cursor-observe\n   * @returns {Object} - live query handle\n   */\n  observe(callbacks) {\n    this._collection._debug('[FilesCollection] [FilesCursor] [observe()]');\n    return this.cursor.observe(callbacks);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name observeChanges\n   * @param callbacks {Object} - Functions to call to deliver the result set as it changes\n   * @summary Watch a query. Receive callbacks as the result set changes. Only the differences between the old and new documents are passed to the callbacks.\n   * @url http://docs.meteor.com/api/collections.html#Mongo-Cursor-observeChanges\n   * @returns {Object} - live query handle\n   */\n  observeChanges(callbacks) {\n    this._collection._debug('[FilesCollection] [FilesCursor] [observeChanges()]');\n    return this.cursor.observeChanges(callbacks);\n  }\n}\n","import { _ }     from 'meteor/underscore';\nimport { check } from 'meteor/check';\n\n/*\n * @const {Function} fixJSONParse - Fix issue with Date parse\n */\nconst fixJSONParse = function(obj) {\n  for (let key in obj) {\n    if (_.isString(obj[key]) && !!~obj[key].indexOf('=--JSON-DATE--=')) {\n      obj[key] = obj[key].replace('=--JSON-DATE--=', '');\n      obj[key] = new Date(parseInt(obj[key]));\n    } else if (_.isObject(obj[key])) {\n      obj[key] = fixJSONParse(obj[key]);\n    } else if (_.isArray(obj[key])) {\n      let v;\n      for (let i = 0; i < obj[key].length; i++) {\n        v = obj[key][i];\n        if (_.isObject(v)) {\n          obj[key][i] = fixJSONParse(v);\n        } else if (_.isString(v) && !!~v.indexOf('=--JSON-DATE--=')) {\n          v = v.replace('=--JSON-DATE--=', '');\n          obj[key][i] = new Date(parseInt(v));\n        }\n      }\n    }\n  }\n  return obj;\n};\n\n/*\n * @const {Function} fixJSONStringify - Fix issue with Date stringify\n */\nconst fixJSONStringify = function(obj) {\n  for (let key in obj) {\n    if (_.isDate(obj[key])) {\n      obj[key] = `=--JSON-DATE--=${+obj[key]}`;\n    } else if (_.isObject(obj[key])) {\n      obj[key] = fixJSONStringify(obj[key]);\n    } else if (_.isArray(obj[key])) {\n      let v;\n      for (let i = 0; i < obj[key].length; i++) {\n        v = obj[key][i];\n        if (_.isObject(v)) {\n          obj[key][i] = fixJSONStringify(v);\n        } else if (_.isDate(v)) {\n          obj[key][i] = `=--JSON-DATE--=${+v}`;\n        }\n      }\n    }\n  }\n  return obj;\n};\n\n/*\n * @locus Anywhere\n * @private\n * @name formatFleURL\n * @param {Object} fileRef - File reference object\n * @param {String} version - [Optional] Version of file you would like build URL for\n * @summary Returns formatted URL for file\n * @returns {String} Downloadable link\n */\nconst formatFleURL = (fileRef, version = 'original') => {\n  let ext;\n  check(fileRef, Object);\n  check(version, String);\n\n  const _root = __meteor_runtime_config__.ROOT_URL.replace(/\\/+$/, '');\n  const vRef = ((fileRef.versions && fileRef.versions[version]) || fileRef);\n\n  if (_.has(vRef, 'extension')) {\n    ext = `.${vRef.extension.replace(/^\\./, '')}`;\n  } else {\n    ext = '';\n  }\n\n  if (fileRef.public === true) {\n    return _root + (version === 'original' ? `${fileRef._downloadRoute}/${fileRef._id}${ext}` : `${fileRef._downloadRoute}/${version}-${fileRef._id}${ext}`);\n  }\n  return _root + `${fileRef._downloadRoute}/${fileRef._collectionName}/${fileRef._id}/${version}/${fileRef._id}${ext}`;\n};\n\nexport { fixJSONParse, fixJSONStringify, formatFleURL };\n","import fs         from 'fs-extra';\nimport { _ }      from 'meteor/underscore';\nimport { Meteor } from 'meteor/meteor';\nconst NOOP = () => {};\n\n/*\n * @const {Object} bound   - Meteor.bindEnvironment (Fiber wrapper)\n * @const {Object} fdCache - File Descriptors Cache\n */\nconst bound   = Meteor.bindEnvironment(callback => callback());\nconst fdCache = {};\n\n/*\n * @private\n * @locus Server\n * @class WriteStream\n * @param path      {String} - Path to file on FS\n * @param maxLength {Number} - Max amount of chunks in stream\n * @param file      {Object} - fileRef Object\n * @summary writableStream wrapper class, makes sure chunks is written in given order. Implementation of queue stream.\n */\nexport default class WriteStream {\n  constructor(path, maxLength, file, permissions) {\n    this.path = path;\n    this.maxLength = maxLength;\n    this.file = file;\n    this.permissions = permissions;\n    if (!this.path || !_.isString(this.path)) {\n      return;\n    }\n\n    this.fd            = null;\n    this.writtenChunks = 0;\n    this.ended         = false;\n    this.aborted       = false;\n\n    if (fdCache[this.path] && !fdCache[this.path].ended && !fdCache[this.path].aborted) {\n      this.fd = fdCache[this.path].fd;\n      this.writtenChunks = fdCache[this.path].writtenChunks;\n    } else {\n      fs.ensureFile(this.path, (efError) => {\n        bound(() => {\n          if (efError) {\n            throw new Meteor.Error(500, '[FilesCollection] [writeStream] [ensureFile] [Error:]', efError);\n          } else {\n            fs.open(this.path, 'r+', this.permissions, (oError, fd) => {\n              bound(() => {\n                if (oError) {\n                  throw new Meteor.Error(500, '[FilesCollection] [writeStream] [ensureFile] [open] [Error:]', oError);\n                } else {\n                  this.fd = fd;\n                  fdCache[this.path] = this;\n                }\n              });\n            });\n          }\n        });\n      });\n    }\n  }\n\n  /*\n   * @memberOf writeStream\n   * @name write\n   * @param {Number} num - Chunk position in a stream\n   * @param {Buffer} chunk - Buffer (chunk binary data)\n   * @param {Function} callback - Callback\n   * @summary Write chunk in given order\n   * @returns {Boolean} - True if chunk is sent to stream, false if chunk is set into queue\n   */\n  write(num, chunk, callback) {\n    if (!this.aborted && !this.ended) {\n      if (this.fd) {\n        fs.write(this.fd, chunk, 0, chunk.length, (num - 1) * this.file.chunkSize, (error, written, buffer) => {\n          bound(() => {\n            callback && callback(error, written, buffer);\n            if (error) {\n              console.warn('[FilesCollection] [writeStream] [write] [Error:]', error);\n              this.abort();\n            } else {\n              ++this.writtenChunks;\n            }\n          });\n        });\n      } else {\n        Meteor.setTimeout(() => {\n          this.write(num, chunk, callback);\n        }, 25);\n      }\n    }\n    return false;\n  }\n\n  /*\n   * @memberOf writeStream\n   * @name end\n   * @param {Function} callback - Callback\n   * @summary Finishes writing to writableStream, only after all chunks in queue is written\n   * @returns {Boolean} - True if stream is fulfilled, false if queue is in progress\n   */\n  end(callback) {\n    if (!this.aborted && !this.ended) {\n      if (this.writtenChunks === this.maxLength) {\n        fs.close(this.fd, () => {\n          bound(() => {\n            delete fdCache[this.path];\n            this.ended = true;\n            callback && callback(void 0, true);\n          });\n        });\n        return true;\n      }\n\n      fs.stat(this.path, (error, stat) => {\n        bound(() => {\n          if (!error && stat) {\n            this.writtenChunks = Math.ceil(stat.size / this.file.chunkSize);\n          }\n\n          return Meteor.setTimeout(() => {\n            this.end(callback);\n          }, 25);\n        });\n      });\n    } else {\n      callback && callback(void 0, this.ended);\n    }\n    return false;\n  }\n\n  /*\n   * @memberOf writeStream\n   * @name abort\n   * @param {Function} callback - Callback\n   * @summary Aborts writing to writableStream, removes created file\n   * @returns {Boolean} - True\n   */\n  abort(callback) {\n    this.aborted = true;\n    delete fdCache[this.path];\n    fs.unlink(this.path, (callback || NOOP));\n    return true;\n  }\n\n  /*\n   * @memberOf writeStream\n   * @name stop\n   * @summary Stop writing to writableStream\n   * @returns {Boolean} - True\n   */\n  stop() {\n    this.aborted = true;\n    delete fdCache[this.path];\n    return true;\n  }\n}\n"]}